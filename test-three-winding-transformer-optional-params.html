<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three-Winding Transformer Optional Parameters Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .test-container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            margin-bottom: 20px;
        }
        .test-result { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .success { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .info { 
            background-color: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #b8daff; 
        }
        .warning { 
            background-color: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7; 
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        .parameter-test {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Three-Winding Transformer Optional Parameters Test</h1>
    
    <div class="test-container">
        <h2>New Optional Parameters Added</h2>
        <div class="info">
            <h3>Frontend Dialog Parameters:</h3>
            <ul>
                <li><strong>vk0_hv_percent</strong> - HV Zero Sequence SC Voltage (optional)</li>
                <li><strong>vk0_mv_percent</strong> - MV Zero Sequence SC Voltage (optional)</li>
                <li><strong>vk0_lv_percent</strong> - LV Zero Sequence SC Voltage (optional)</li>
                <li><strong>vkr0_hv_percent</strong> - HV Zero Sequence Real SC Voltage (optional)</li>
                <li><strong>vkr0_mv_percent</strong> - MV Zero Sequence Real SC Voltage (optional)</li>
                <li><strong>vkr0_lv_percent</strong> - LV Zero Sequence Real SC Voltage (optional)</li>
                <li><strong>vector_group</strong> - Vector Group (optional, e.g., Dyn, Yyn)</li>
            </ul>
        </div>
    </div>

    <div class="test-container">
        <h2>Backend Input Example</h2>
        <div class="code-block">
'85': {
    'typ': 'Three Winding Transformer0',
    'name': 'mxCell_453',
    'id': 'sW1o8jBmeiVlhU9GZIJK-2',
    'hv_bus': 'mxCell_195',
    'mv_bus': 'mxCell_457',
    'lv_bus': 'mxCell_200',
    'sn_hv_mva': '80',
    'sn_mv_mva': '40',
    'sn_lv_mva': '40',
    'vn_hv_kv': '400',
    'vn_mv_kv': '30',
    'vn_lv_kv': '30',
    'vk_hv_percent': '11',
    'vk_mv_percent': '11',
    'vk_lv_percent': '10.4',
    'vkr_hv_percent': '0.5',
    'vkr_mv_percent': '0.5',
    'vkr_lv_percent': '0.5',
    'pfe_kw': '140',
    'i0_percent': '2',
    'vk0_hv_percent': None,        // ← Now can be input from frontend
    'vk0_mv_percent': None,        // ← Now can be input from frontend
    'vk0_lv_percent': None,        // ← Now can be input from frontend
    'vkr0_hv_percent': None,       // ← Now can be input from frontend
    'vkr0_mv_percent': None,       // ← Now can be input from frontend
    'vkr0_lv_percent': None,       // ← Now can be input from frontend
    'vector_group': None,          // ← Now can be input from frontend
    'shift_mv_degree': '0',
    'shift_lv_degree': '0',
    'tap_step_percent': '1.5',
    'tap_side': 'hv',
    'tap_neutral': '0',
    'tap_min': '-10',
    'tap_max': '10',
    'tap_pos': '0'
}
        </div>
    </div>

    <div class="test-container">
        <h2>Parameter Handling Tests</h2>
        <div id="testResults">
            <div class="info">Click the test buttons below to verify parameter handling.</div>
        </div>
        
        <button onclick="testFrontendParameterHandling()">Test Frontend Parameter Handling</button>
        <button onclick="testBackendParameterHandling()">Test Backend Parameter Handling</button>
        <button onclick="testCompleteFlow()">Test Complete Flow</button>
    </div>

    <div class="test-container">
        <h2>Implementation Details</h2>
        <div class="success">
            <h3>Frontend Changes (threeWindingTransformerBaseDialog.js):</h3>
            <ul>
                <li>✅ Added optional parameters to defaultThreeWindingTransformerData</li>
                <li>✅ Added parameter definitions to shortCircuitParameters array</li>
                <li>✅ Updated getFormValues() to handle null values for optional parameters</li>
                <li>✅ Updated loadThreeWindingTransformerData() to handle optional parameters</li>
                <li>✅ Added proper input value handling for null values</li>
            </ul>
        </div>
        
        <div class="success">
            <h3>Backend Changes (pandapower_electrisim.py):</h3>
            <ul>
                <li>✅ Refactored three-winding transformer creation to use parameter dictionary</li>
                <li>✅ Added conditional inclusion of optional parameters</li>
                <li>✅ Only passes non-None values to pandapower function</li>
                <li>✅ Handles string 'None', empty strings, and actual None values</li>
            </ul>
        </div>
    </div>

    <script>
        function addTestResult(message, isSuccess) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }

        function testFrontendParameterHandling() {
            try {
                // Simulate the frontend parameter handling
                const testInputs = {
                    'vk0_hv_percent': '',
                    'vk0_mv_percent': '5.5',
                    'vk0_lv_percent': '',
                    'vkr0_hv_percent': '2.1',
                    'vkr0_mv_percent': '',
                    'vkr0_lv_percent': '1.8',
                    'vector_group': 'Dyn'
                };

                // Simulate getFormValues logic
                const values = {};
                const optionalParams = ['vk0_hv_percent', 'vk0_mv_percent', 'vk0_lv_percent', 
                                     'vkr0_hv_percent', 'vkr0_mv_percent', 'vkr0_lv_percent'];
                const optionalTextParams = ['vector_group'];

                Object.keys(testInputs).forEach(key => {
                    const value = testInputs[key];
                    if (optionalParams.includes(key)) {
                        values[key] = value.trim() === '' ? null : parseFloat(value);
                    } else if (optionalTextParams.includes(key)) {
                        values[key] = value.trim() === '' ? null : value;
                    } else {
                        values[key] = value;
                    }
                });

                // Verify results
                const expected = {
                    'vk0_hv_percent': null,
                    'vk0_mv_percent': 5.5,
                    'vk0_lv_percent': null,
                    'vkr0_hv_percent': 2.1,
                    'vkr0_mv_percent': null,
                    'vkr0_lv_percent': 1.8,
                    'vector_group': 'Dyn'
                };

                const isCorrect = JSON.stringify(values) === JSON.stringify(expected);
                
                if (isCorrect) {
                    addTestResult('✅ Frontend parameter handling works correctly - empty strings become null, values are parsed properly', true);
                } else {
                    addTestResult('❌ Frontend parameter handling failed - unexpected result', false);
                }

            } catch (error) {
                addTestResult('❌ Frontend parameter handling test failed: ' + error.message, false);
            }
        }

        function testBackendParameterHandling() {
            try {
                // Simulate backend parameter handling
                const testData = {
                    'vk0_hv_percent': None,
                    'vk0_mv_percent': '5.5',
                    'vk0_lv_percent': '',
                    'vkr0_hv_percent': '2.1',
                    'vkr0_mv_percent': None,
                    'vkr0_lv_percent': '1.8',
                    'vector_group': 'Dyn'
                };

                // Simulate backend logic
                const transformer_params = {
                    'hv_bus': 1,
                    'mv_bus': 2,
                    'lv_bus': 3,
                    'name': 'test_transformer',
                    'sn_hv_mva': '80',
                    'sn_mv_mva': '40',
                    'sn_lv_mva': '40'
                };

                const optional_params = ['vector_group', 'vk0_hv_percent', 'vk0_mv_percent', 'vk0_lv_percent', 
                                       'vkr0_hv_percent', 'vkr0_mv_percent', 'vkr0_lv_percent'];

                for (const param of optional_params) {
                    const value = testData[param];
                    if (value !== null && value !== 'None' && value !== '') {
                        transformer_params[param] = value;
                    }
                }

                // Verify results
                const expectedParams = {
                    'hv_bus': 1,
                    'mv_bus': 2,
                    'lv_bus': 3,
                    'name': 'test_transformer',
                    'sn_hv_mva': '80',
                    'sn_mv_mva': '40',
                    'sn_lv_mva': '40',
                    'vk0_mv_percent': '5.5',
                    'vkr0_hv_percent': '2.1',
                    'vkr0_lv_percent': '1.8',
                    'vector_group': 'Dyn'
                };

                const isCorrect = JSON.stringify(transformer_params) === JSON.stringify(expectedParams);
                
                if (isCorrect) {
                    addTestResult('✅ Backend parameter handling works correctly - only non-null values are included', true);
                } else {
                    addTestResult('❌ Backend parameter handling failed - unexpected result', false);
                }

            } catch (error) {
                addTestResult('❌ Backend parameter handling test failed: ' + error.message, false);
            }
        }

        function testCompleteFlow() {
            try {
                // Simulate complete flow from frontend to backend
                const frontendInput = {
                    'name': 'Test Transformer',
                    'sn_hv_mva': 80,
                    'sn_mv_mva': 40,
                    'sn_lv_mva': 40,
                    'vk0_hv_percent': null,      // Empty in frontend
                    'vk0_mv_percent': 5.5,       // Has value
                    'vk0_lv_percent': null,      // Empty in frontend
                    'vkr0_hv_percent': 2.1,      // Has value
                    'vkr0_mv_percent': null,     // Empty in frontend
                    'vkr0_lv_percent': 1.8,      // Has value
                    'vector_group': 'Dyn'        // Has value
                };

                // Simulate backend processing
                const backendData = {
                    'typ': 'Three Winding Transformer0',
                    'name': frontendInput.name,
                    'sn_hv_mva': frontendInput.sn_hv_mva.toString(),
                    'sn_mv_mva': frontendInput.sn_mv_mva.toString(),
                    'sn_lv_mva': frontendInput.sn_lv_mva.toString(),
                    'vk0_hv_percent': frontendInput.vk0_hv_percent,
                    'vk0_mv_percent': frontendInput.vk0_mv_percent,
                    'vk0_lv_percent': frontendInput.vk0_lv_percent,
                    'vkr0_hv_percent': frontendInput.vkr0_hv_percent,
                    'vkr0_mv_percent': frontendInput.vkr0_mv_percent,
                    'vkr0_lv_percent': frontendInput.vkr0_lv_percent,
                    'vector_group': frontendInput.vector_group
                };

                // Simulate backend parameter filtering
                const transformer_params = {
                    'name': backendData['name'],
                    'sn_hv_mva': backendData['sn_hv_mva'],
                    'sn_mv_mva': backendData['sn_mv_mva'],
                    'sn_lv_mva': backendData['sn_lv_mva']
                };

                const optional_params = ['vector_group', 'vk0_hv_percent', 'vk0_mv_percent', 'vk0_lv_percent', 
                                       'vkr0_hv_percent', 'vkr0_mv_percent', 'vkr0_lv_percent'];

                for (const param of optional_params) {
                    const value = backendData[param];
                    if (value !== null && value !== 'None' && value !== '') {
                        transformer_params[param] = value;
                    }
                }

                // Verify final result
                const expectedFinal = {
                    'name': 'Test Transformer',
                    'sn_hv_mva': '80',
                    'sn_mv_mva': '40',
                    'sn_lv_mva': '40',
                    'vk0_mv_percent': 5.5,
                    'vkr0_hv_percent': 2.1,
                    'vkr0_lv_percent': 1.8,
                    'vector_group': 'Dyn'
                };

                const isCorrect = JSON.stringify(transformer_params) === JSON.stringify(expectedFinal);
                
                if (isCorrect) {
                    addTestResult('✅ Complete flow works correctly - frontend null values are properly handled and excluded from backend', true);
                } else {
                    addTestResult('❌ Complete flow test failed - unexpected result', false);
                }

            } catch (error) {
                addTestResult('❌ Complete flow test failed: ' + error.message, false);
            }
        }

        // Show initial status
        addTestResult('Three-Winding Transformer optional parameters have been successfully implemented', true);
        addTestResult('Frontend dialog now supports input of vk0_*, vkr0_*, and vector_group parameters', true);
        addTestResult('Backend properly handles optional parameters and only passes non-null values to pandapower', true);
    </script>
</body>
</html>
