const createTableRow=(e,t)=>e.map((e,n)=>String(e).padEnd(t[n]," ")).join(" | "),createTableSeparator=e=>e.map(e=>"-".repeat(e)).join("-+-"),getConnectedBusId=(e,t=!1,n=!1)=>{const isBus=e=>!(!e||!e.style)&&(e.style.includes("shape=mxgraph.electrical.transmission.busbar")||e.style.includes("Bus")||e.value&&e.value.nodeName&&e.value.nodeName.includes("Bus"));if(t)return n&&(e.source&&!isBus(e.source)&&console.warn(`Line "${e.id}" source is connected to "${e.source.id}" which may not be a Bus`),e.target&&!isBus(e.target)&&console.warn(`Line "${e.id}" target is connected to "${e.target.id}" which may not be a Bus`)),{busFrom:e.source?.mxObjectId?.replace("#","_"),busTo:e.target?.mxObjectId?.replace("#","_")};const r=e.edges[0];if(!r)return null;if(!r.target&&!r.source)return null;const a=r.target&&r.target.mxObjectId!==e.mxObjectId?r.target:r.source;return n&&a&&!isBus(a)&&console.warn(`Component "${e.id}" is connected to "${a.id}" which may not be a Bus. PandaPower requires explicit Bus connections.`),a?a.mxObjectId.replace("#","_"):null},getAttributesAsObject=(e,t)=>{const n={};if(!e?.value?.attributes)return console.warn("Cell is missing required properties"),n;const r=new Map,a=e.value.attributes;for(let e=0;e<a.length;e++)r.set(a[e].nodeName,a[e].nodeValue);const o={parallel:"1",df:"1.0",vector_group:"Dyn11",vk0_percent:"0.0",vkr0_percent:"0.0",mag0_percent:"0.0",si0_hv_partial:"0.0",step:"1",max_step:"1",scaling:"1.0"};for(const[e,a]of Object.entries(t)){const t="object"==typeof a&&a.optional,l="object"==typeof a?a.name:a,s=r.get(l);void 0!==s?n[e]=s:t?o[e]&&(n[e]=o[e]):(console.warn(`Missing required attribute ${e} with name ${l}`),n[e]=null)}return n},updateTransformerBusConnections=(e,t,n)=>e.map(e=>(e=>{try{(e=>{const t=n.getModel().getStyle(e),r=mxUtils.setStyle(t,mxConstants.STYLE_STROKECOLOR,"black");r&&n.setCellStyle(r,[e])})((e=>{const t=n.getModel().getCell(e);if(!t)throw new Error(`Invalid transformer cell: ${e}`);return t})(e.id));const r=((e,n)=>{const r=t.find(t=>t.name===e),a=t.find(e=>e.name===n);if(!r||!a)throw new Error("Transformer is not connected to valid busbars.");return[r,a]})(e.hv_bus,e.lv_bus),{highVoltage:a,lowVoltage:o}=(e=>{if(0===e.length)throw new Error("No valid busbars found for transformer.");const t=e.reduce((e,t)=>parseFloat(e.vn_kv)>parseFloat(t.vn_kv)?e:t),n=e.reduce((e,t)=>parseFloat(e.vn_kv)<parseFloat(t.vn_kv)?e:t);return{highVoltage:t.name,lowVoltage:n.name}})(r);return{...e,hv_bus:a,lv_bus:o}}catch(t){return alert(`Error processing transformer ${e.id}:`,t.message),e}})(e)),updateThreeWindingTransformerConnections=(e,t,n)=>{const updateTransformerStyle=(e,t)=>{const r=n.getModel().getStyle(e),a=mxUtils.setStyle(r,mxConstants.STYLE_STROKECOLOR,t);n.setCellStyle(a,[e])};return e.map(e=>(e=>{const r=(e=>{const t=n.getModel().getCell(e);if(!t)throw new Error(`Invalid three-winding transformer cell: ${e}`);return t})(e.id);try{const n=((e,n,r)=>{const a=t.find(t=>t.name===e),o=t.find(e=>e.name===n),l=t.find(e=>e.name===r);if(!a||!o||!l)throw new Error("Three-winding transformer is not connected to valid busbars.");return[a,o,l]})(e.hv_bus,e.mv_bus,e.lv_bus);updateTransformerStyle(r,"black");const{highVoltage:a,mediumVoltage:o,lowVoltage:l}=(e=>{if(3!==e.length)throw new Error("Three-winding transformer requires exactly three busbars.");const t=e.reduce((e,t)=>parseFloat(e.vn_kv)>parseFloat(t.vn_kv)?e:t),n=e.reduce((e,t)=>parseFloat(e.vn_kv)<parseFloat(t.vn_kv)?e:t),r=e.find(e=>e.name!==t.name&&e.name!==n.name);return{highVoltage:t.name,mediumVoltage:r.name,lowVoltage:n.name}})(n);return{...e,hv_bus:a,mv_bus:o,lv_bus:l}}catch(t){return console.log(`Error processing three-winding transformer ${e.id}:`,t.message),updateTransformerStyle(r,"red"),alert("The three-winding transformer is not connected to the bus. Please check the three-winding transformer highlighted in red and connect it to the appropriate bus."),e}})(e))},getImpedanceConnections=e=>{try{const[t,n]=e.edges;return{busFrom:(t.target.mxObjectId!==e.mxObjectId?t.target.mxObjectId:t.source.mxObjectId).replace("#","_"),busTo:(n.target.mxObjectId!==e.mxObjectId?n.target.mxObjectId:n.source.mxObjectId).replace("#","_")}}catch{throw new Error("Connect an impedance's 'in' and 'out' to other element in the model. The impedance has not been taken into account in the simulation.")}};function getConnectedBuses(e){return{busFrom:e.source?.mxObjectId?.replace("#","_"),busTo:e.target?.mxObjectId?.replace("#","_")}}import{DIALOG_STYLES as e}from"./utils/dialogStyles.js";import{LoadFlowDialog as t}from"./dialogs/LoadFlowDialog.js";function loadFlowPandaPower(e,n,r){globalThis.simulationRunCount++;const a=globalThis.simulationRunCount,o=performance.now();console.log(`=== LOAD FLOW SIMULATION #${a} STARTED ===`);const l={externalGrid:0,generator:0,staticGenerator:0,asymmetricGenerator:0,busbar:0,transformer:0,threeWindingTransformer:0,shuntReactor:0,capacitor:0,load:0,asymmetricLoad:0,impedance:0,ward:0,extendedWard:0,motor:0,storage:0,SVC:0,TCSC:0,SSC:0,dcLine:0,line:0},s=n.getModel(),i=new Map,c=new Map,_=new Map;console.log("Starting fresh simulation with clean caches");const getCachedCell=e=>{if(i.has(e))return i.get(e);const t=s.getCell(e);return i.set(e,t),t},getUserFriendlyName=e=>{const t=e.id;if(c.has(t))return c.get(t);let n=e.mxObjectId.replace("#","_");if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName){n=e.value.attributes[t].nodeValue;break}return c.set(t,n),n},getCachedAttributes=(e,t)=>{const n=`${e.id}_${Object.keys(t).length}`;if(_.has(n))return _.get(n);const r=getAttributesAsObject(e,t);return _.set(n,r),r},m={simulationParameters:[],externalGrid:[],generator:[],staticGenerator:[],asymmetricGenerator:[],busbar:[],transformer:[],threeWindingTransformer:[],shuntReactor:[],capacitor:[],load:[],asymmetricLoad:[],impedance:[],ward:[],extendedWard:[],motor:[],storage:[],SVC:[],TCSC:[],SSC:[],dcLine:[],line:[]},u=s;let d=u.getDescendants();function setCellStyle(e,t){let r=s.getStyle(e),a=Object.entries(t).reduce((e,[t,n])=>mxUtils.setStyle(e,`mxConstants.STYLE_${t.toUpperCase()}`,n),r);n.setCellStyle(a,[e])}const p={label:{[mxConstants.STYLE_FONTSIZE]:"6",[mxConstants.STYLE_ALIGN]:"ALIGN_LEFT"},line:{[mxConstants.STYLE_FONTSIZE]:"6",[mxConstants.STYLE_STROKE_OPACITY]:"0",[mxConstants.STYLE_STROKECOLOR]:"white",[mxConstants.STYLE_STROKEWIDTH]:"0",[mxConstants.STYLE_OVERFLOW]:"hidden"}},v="orange",g="green",formatNumber=(e,t=3)=>null==e||"NaN"===e||"number"==typeof e&&isNaN(e)?"N/A":parseFloat(e).toFixed(t),replaceUnderscores=e=>e.replace("_","#"),h={label:Object.entries(p.label).map(([e,t])=>`${e}=${t}`).join(";"),line:Object.entries(p.line).map(([e,t])=>`${e}=${t}`).join(";")};function processCellStyles(e,t,n=!1){const r=n?h.line:h.label;e.setCellStyle(r,[t]),n&&e.orderCells(!0,[t])}function processLoadingColor(e,t,n){const r=parseFloat(n.toFixed(1));let a=null;r>100?a="red":r>80?a=v:r>0&&(a=g),a&&updateCellColor(e,t,a)}function updateCellColor(e,t,n){const r=e.getModel().getStyle(t),a=mxUtils.setStyle(r,mxConstants.STYLE_STROKECOLOR,n);e.setCellStyle(a,[t])}const f={busbars:(e,t,n)=>{e.map(e=>{const t=getCachedCell(e.id);return e.name=replaceUnderscores(e.name),{resultCell:t,resultString:`${t.value.attributes[0].nodeValue}\n            U[pu]: ${formatNumber(e.vm_pu)}\n            U[degree]: ${formatNumber(e.va_degree)}\n            P[MW]: ${formatNumber(e.p_mw)}\n            Q[MVar]: ${formatNumber(e.q_mvar)}\n            PF: ${formatNumber(e.pf)}\n            Q/P: ${formatNumber(e.q_p)}`,cell:e}}).forEach(({resultCell:e,resultString:r,cell:a})=>{const o=t.insertVertex(e,null,r,0,2.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,o),function processVoltageColor(e,t,n){const r=parseFloat(n.toFixed(2));let a=null;r>=1.1||r<=.9?a="red":r>1.05&&r<=1.1||r>.9&&r<=.95?a=v:(r>1&&r<=1.05||r>.95&&r<=1)&&(a=g),a&&updateCellColor(e,t,a)}(n,e,a.vm_pu)})},lines:(e,t,n)=>{e.map(e=>{const t=getCachedCell(e.id),n=t;return e.name=replaceUnderscores(e.name),{resultCell:t,linia:n,resultString:`${n.value.attributes[6].nodeValue}\n            P_from[MW]: ${formatNumber(e.p_from_mw)}\n            Q_from[MVar]: ${formatNumber(e.q_from_mvar)}\n            i_from[kA]: ${formatNumber(e.i_from_ka)}\n\n            Loading[%]: ${formatNumber(e.loading_percent,1)}\n\n            P_to[MW]: ${formatNumber(e.p_to_mw)}\n            Q_to[MVar]: ${formatNumber(e.q_to_mvar)}\n            i_to[kA]: ${formatNumber(e.i_to_ka)}`,cell:e}}).forEach(({resultCell:e,linia:r,resultString:a,cell:o})=>{const l=t.insertVertex(e,null,a,0,0,0,0,"shapeELXXX=Result",!0);processCellStyles(t,l,!0),processLoadingColor(n,r,o.loading_percent)})},externalgrids:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            \n            P[MW]: ${formatNumber(e.p_mw)}\n            Q[MVar]: ${formatNumber(e.q_mvar)}\n            PF: ${formatNumber(e.pf)}\n            Q/P: ${formatNumber(e.q_p)}`,a=t.insertVertex(n,null,r,-.15,1.1,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},generators:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P[MW]: ${formatNumber(e.p_mw)}\n            Q[MVar]: ${formatNumber(e.q_mvar)}\n            U[degree]: ${formatNumber(e.va_degree)}\n            Um[pu]: ${formatNumber(e.vm_pu)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},staticgenerators:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P[MW]: ${formatNumber(e.p_mw)}\n            Q[MVar]: ${formatNumber(e.q_mvar)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},asymmetricstaticgenerators:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P_A[MW]: ${formatNumber(e.p_a_mw)}\n            Q_A[MVar]: ${formatNumber(e.q_a_mvar)}\n            P_B[MW]: ${formatNumber(e.p_b_mw)}\n            Q_B[MVar]: ${formatNumber(e.q_b_mvar)}\n            P_C[MW]: ${formatNumber(e.p_c_mw)}\n            Q_C[MVar]: ${formatNumber(e.q_c_mvar)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},transformers:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            i_HV[kA]: ${formatNumber(e.i_hv_ka)}\n            i_LV[kA]: ${formatNumber(e.i_lv_ka)}\n            loading[%]: ${formatNumber(e.loading_percent)}\n            `,a=t.insertVertex(n,null,r,-.15,1.1,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a),processLoadingColor(w,n,e.loading_percent)})},transformers3W:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            i_HV[kA]: ${formatNumber(e.i_hv_ka)}\n            i_MV[kA]: ${formatNumber(e.i_mv_ka)}\n            i_LV[kA]: ${formatNumber(e.i_lv_ka)}\n            loading[%]: ${formatNumber(e.loading_percent)}`,a=t.insertVertex(n,null,r,-.15,1.1,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a),processLoadingColor(w,n,e.loading_percent)})},shunts:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P[MW]: ${formatNumber(e.p_mw)}\n            Q[MVar]: ${formatNumber(e.q_mvar)}\n            Um[pu]: ${formatNumber(e.vm_pu)}`,a=t.insertVertex(n,null,r,-.15,1.5,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},capacitors:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P[MW]: ${formatNumber(e.p_mw)}\n            Q[MVar]: ${formatNumber(e.q_mvar)}\n            Um[pu]: ${formatNumber(e.vm_pu)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},loads:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P[MW]: ${formatNumber(e.p_mw)}\n            Q[MVar]: ${formatNumber(e.q_mvar)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},asymmetricloads:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P_A[MW]: ${formatNumber(e.p_a_mw)}\n            Q_A[MVar]: ${formatNumber(e.q_a_mvar)}\n            P_B[MW]: ${formatNumber(e.p_b_mw)}\n            Q_B[MVar]: ${formatNumber(e.q_b_mvar)}\n            P_C[MW]: ${formatNumber(e.p_c_mw)}\n            Q_C[MVar]: ${formatNumber(e.q_c_mvar)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},impedances:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P_from[MW]: ${formatNumber(e.p_from_mw)}\n            Q_from[MVar]: ${formatNumber(e.q_from_mvar)}\n            P_to[MW]: ${formatNumber(e.p_to_mw)}\n            Q_to[MVar]: ${formatNumber(e.q_to_mvar)}\n            Pl[MW]: ${formatNumber(e.pl_mw)}\n            Ql[MVar]: ${formatNumber(e.ql_mvar)}\n            i_from[kA]: ${formatNumber(e.i_from_ka)}\n            i_to[kA]: ${formatNumber(e.i_to_ka)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},wards:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P[MW]: ${formatNumber(e.p_mw)}\n            Q[MVar]: ${formatNumber(e.q_mvar)}\n            Um[pu]: ${formatNumber(e.p_to_mw)}\n            `,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},extendedwards:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P[MW]: ${formatNumber(e.p_mw)}\n            Q[MVar]: ${formatNumber(e.q_mvar)}\n            Um[pu]: ${formatNumber(e.p_to_mw)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},motors:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P[MW]: ${formatNumber(e.p_mw)}\n            Q[MVar]: ${formatNumber(e.q_mvar)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},storages:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P[MW]: ${formatNumber(e.p_mw)}\n            Q[MVar]: ${formatNumber(e.q_mvar)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},svc:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            Firing angle[degree]: ${formatNumber(e.thyristor_firing_angle_degree)}\n            x[Ohm]: ${formatNumber(e.x_ohm)}\n            q[MVar]: ${formatNumber(e.q_mvar)}\n            vm[pu]: ${formatNumber(e.vm_pu)}\n            va[degree]: ${formatNumber(e.va_degree)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},tcsc:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            Firing angle[degree]: ${formatNumber(e.thyristor_firing_angle_degree)}\n            x[Ohm]: ${formatNumber(e.x_ohm)}\n            p_from[MW]: ${formatNumber(e.p_from_mw)}\n            q_from[MVar]: ${formatNumber(e.q_from_mvar)}\n            p_to[MW]: ${formatNumber(e.p_to_mw)}\n            q_to[MVar]: ${formatNumber(e.q_to_mvar)}\n            p_l[MW]: ${formatNumber(e.p_l_mw)}\n            q_l[MVar]: ${formatNumber(e.q_l_mvar)}\n            vm_from[pu]: ${formatNumber(e.vm_from_pu)}\n            va_from[degree]: ${formatNumber(e.va_from_degree)}\n            vm_to[pu]: ${formatNumber(e.vm_to_pu)}\n            va_to[degree]: ${formatNumber(e.va_to_degree)}`,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},sscs:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            q_mvar: ${formatNumber(e.q_mvar)}\n            vm_internal_pu: ${formatNumber(e.vm_internal_pu)}\n            va_internal_degree: ${formatNumber(e.va_internal_degree)}\n            vm_pu: ${formatNumber(e.vm_pu)}\n            va_degree: ${formatNumber(e.va_degree)}            \n            `,a=t.insertVertex(n,null,r,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})},dclines:(e,t)=>{e.forEach(e=>{const n=getCachedCell(e.id),r=`${n.value.attributes[0].nodeValue}\n            P_from[MW]: ${formatNumber(e.p_from_mw)}\n            Q_from[MVar]: ${formatNumber(e.q_mvar)}\n            P_to[MW]: ${formatNumber(e.p_to_mw)}\n            Q_to[MVar]: ${formatNumber(e.q_to_mvar)}\n            Pl[MW]: ${formatNumber(e.pl_mw)}\n            `,a=t.insertVertex(n,null,r,-.15,1.1,0,0,"shapeELXXX=Result",!0);processCellStyles(t,a)})}};let b=e,w=n;n.isEnabled()&&!n.isCellLocked(n.getDefaultParent())&&new t(e).show(function(e,t){if(b.spinner.spin(document.body,"Waiting for results..."),console.log('üîç loadFlowPandaPower callback received parameter "a":',e),console.log('üîç Type of "a":',typeof e,", Is array?",Array.isArray(e)),console.log("üîç a.exportPython:",e?.exportPython),console.log("üîç a.exportPandapowerResults:",e?.exportPandapowerResults),Array.isArray(e)&&e.length>0||"object"==typeof e&&null!==e&&!Array.isArray(e)){function getUserEmail(){try{const e=localStorage.getItem("user");if(e){const t=JSON.parse(e);if(t&&t.email)return t.email}if("function"==typeof getCurrentUser){const e=getCurrentUser();if(e&&e.email)return e.email}if(window.getCurrentUser&&"function"==typeof window.getCurrentUser){const e=window.getCurrentUser();if(e&&e.email)return e.email}if(window.authHandler&&window.authHandler.getCurrentUser){const e=window.authHandler.getCurrentUser();if(e&&e.email)return e.email}return"unknown@user.com"}catch(e){return console.warn("Error getting user email:",e),"unknown@user.com"}}const r=getUserEmail();console.log("Load Flow - User email:",r),console.log("=== Load Flow Debug ==="),console.log("localStorage user:",localStorage.getItem("user")),console.log("localStorage token:",localStorage.getItem("token")),console.log("Final userEmail:",r),console.log("======================");const a="object"==typeof e&&!Array.isArray(e)&&null!==e;console.log("=== Load Flow Parameters Debug ==="),console.log("Parameters format:",a?"OBJECT":"ARRAY"),console.log("Parameters value:",e),console.log("exportPython value:",a?e.exportPython:"N/A (array format)"),console.log("exportPython type:",typeof e.exportPython),console.log("exportPython === true:",!0===e.exportPython),console.log("exportPython === false:",!1===e.exportPython),console.log("All keys in a:",Object.keys(e)),console.log("===================================");const s=!!a&&!0===e.exportPython,v=!!a&&!0===e.exportPandapowerResults;console.log("üîç Final exportPython value being sent:",s),console.log("üîç Final exportPandapowerResults value being sent:",v),m.simulationParameters.push({typ:"PowerFlowPandaPower Parameters",frequency:a?e.frequency:e[0],algorithm:a?e.algorithm:e[1],calculate_voltage_angles:a?e.calculate_voltage_angles:e[2],initialization:a?e.initialization:e[3],exportPython:s,exportPandapowerResults:v,user_email:r});const g=performance.now(),h=[],x=[];let y=0;console.log(`Processing ${d.length} cells...`),console.log(`Initial memory check - cellsArray length: ${d.length}`),console.log("=== DIRECT RESULT CLEANUP ===");const k=performance.now();let $=0;u.beginUpdate();try{for(let G=d.length-1;G>=0;G--){const B=d[G];if(B&&B.getValue){const z=B.getValue(),Y=B.getStyle();if(Y&&Y.includes("Result")){console.log(`Removing result cell by style: ${B.id} - Style: ${Y}`),u.remove(u.getCell(B.id)),$++;continue}if(z&&"string"==typeof z){const H=z.toLowerCase();(H.includes("u[pu]")&&H.includes("p[mw]")||H.includes("u[degree]")&&H.includes("q[mvar]")||H.includes("pf:")||H.includes("q/p:")||H.includes("loading[%]")||H.includes("i_hv[ka]")||H.includes("i_mv[ka]")||H.includes("i_lv[ka]")||H.includes("i_from[ka]")||H.includes("i_to[ka]")||H.includes("pl[mw]")||H.includes("vm[pu]")||H.includes("va[degree]")||H.includes("um[pu]")||H.includes("p[mw]:")||H.includes("q[mvar]:")||H.includes("q_mvar:")||H.includes("vm_internal_pu:")||H.includes("va_internal_degree:")||H.includes("vm_pu:")||H.includes("va_degree:")||H.includes("firing angle[degree]:")||H.includes("x[ohm]:")||H.includes("q[mvar]:")||H.includes("p_from[mw]:")||H.includes("q_from[mvar]:")||H.includes("p_to[mw]:")||H.includes("q_to[mvar]:")||H.includes("p_l[mw]:")||H.includes("q_l[mvar]:")||H.includes("vm_from[pu]:")||H.includes("va_from[degree]:")||H.includes("vm_to[pu]:")||H.includes("va_to[degree]:")||H.includes("p_a[mw]:")||H.includes("q_a[mvar]:")||H.includes("p_b[mw]:")||H.includes("q_b[mvar]:")||H.includes("p_c[mw]:")||H.includes("q_c[mvar]:")||H.includes("pl[mw]:")||H.includes("ql[mvar]:")||H.includes("ikss[ka]")||H.includes("ip[ka]")||H.includes("ith[ka]")||H.includes("rk[ohm]")||H.includes("xk[ohm]"))&&(console.log(`Removing result cell by content: ${B.id} - Value snippet: ${z.substring(0,80).replace(/\n/g," ")}...`),u.remove(u.getCell(B.id)),$++)}}}}finally{u.endUpdate()}const C=performance.now()-k;if(console.log(`Direct cleanup completed: ${$} cells removed in ${C.toFixed(2)}ms`),console.log("=== END DIRECT CLEANUP ==="),$>0){console.log("Forcing graph refresh after result cleanup...");try{n.refresh(),n.view&&n.view.validate&&n.view.validate(),n.repaint&&n.repaint()}catch(K){console.warn("Graph refresh error (non-critical):",K)}d=u.getDescendants(),console.log(`Updated cellsArray length after cleanup and refresh: ${d.length}`)}const E=new Map;d.forEach(e=>{const t=e.getStyle(),n=e.getValue();if(t?.includes("Result"))return x.push(e),void y++;if(n&&"string"==typeof n){const t=n.toLowerCase();if(t.includes("u[pu]")&&t.includes("p[mw]")||t.includes("u[degree]")&&t.includes("q[mvar]")||t.includes("pf:")||t.includes("q/p:")||t.includes("loading[%]")||t.includes("i_hv[ka]")||t.includes("i_mv[ka]")||t.includes("i_lv[ka]")||t.includes("i_from[ka]")||t.includes("i_to[ka]")||t.includes("pl[mw]")||t.includes("vm[pu]")||t.includes("va[degree]")||t.includes("um[pu]")||t.includes("p[mw]:")||t.includes("q[mvar]:")||t.includes("q_mvar:")||t.includes("vm_internal_pu:")||t.includes("va_internal_degree:")||t.includes("vm_pu:")||t.includes("va_degree:")||t.includes("firing angle[degree]:")||t.includes("x[ohm]:")||t.includes("q[mvar]:")||t.includes("p_from[mw]:")||t.includes("q_from[mvar]:")||t.includes("p_to[mw]:")||t.includes("q_to[mvar]:")||t.includes("p_l[mw]:")||t.includes("q_l[mvar]:")||t.includes("vm_from[pu]:")||t.includes("va_from[degree]:")||t.includes("vm_to[pu]:")||t.includes("va_to[degree]:")||t.includes("p_a[mw]:")||t.includes("q_a[mvar]:")||t.includes("p_b[mw]:")||t.includes("q_b[mvar]:")||t.includes("p_c[mw]:")||t.includes("q_c[mvar]:")||t.includes("pl[mw]:")||t.includes("ql[mvar]:")||t.includes("ikss[ka]")||t.includes("ip[ka]")||t.includes("ith[ka]")||t.includes("rk[ohm]")||t.includes("xk[ohm]"))return console.log(`Removing result cell by content: ${e.id} - Value snippet: ${n.substring(0,80).replace(/\n/g," ")}...`),x.push(e),void y++}let r=E.get(t);r||(r=(e=>{if(!e)return null;const t=e.split(";").map(e=>e.split("="));return Object.fromEntries(t)})(t),E.set(t,r)),r?.shapeELXXX&&"NotEditableLine"!==r.shapeELXXX&&h.push({cell:e,style:r,componentType:r.shapeELXXX})});const S=performance.now();if(x.length>0){console.log(`Removing ${x.length} result cells from previous simulation...`);try{u.beginUpdate(),x.forEach(e=>{const t=u.getCell(e.id);t&&u.remove(t)})}finally{u.endUpdate()}console.log(`Successfully removed ${x.length} result cells`)}else console.log("No result cells to remove (first run or already clean)");const P=performance.now()-S,N=performance.now()-g;console.log(`Cell processing: ${N.toFixed(2)}ms (removed ${y} result cells in ${P.toFixed(2)}ms, found ${h.length} valid cells)`);const V=performance.now();let O=0;console.log(`Starting component processing for ${h.length} valid cells...`);const F=performance.now(),q=new Map;h.forEach(({cell:e,componentType:t})=>{const n=e.id;q.set(n,{name:e.mxObjectId.replace("#","_"),id:n,userFriendlyName:getUserFriendlyName(e),bus:"Line"===t||"DCLine"===t?getConnectedBusId(e,!0):getConnectedBusId(e)})});const A=performance.now()-F;console.log(`Pre-compute completed in ${A.toFixed(2)}ms, starting component switch processing...`);const L={};h.forEach(({cell:e,style:t,componentType:n},r)=>{const a=performance.now();O++;const o=q.get(e.id);switch(n){case"External Grid":const t={...o,typ:"External Grid"+l.externalGrid++,...getCachedAttributes(e,{vm_pu:"vm_pu",va_degree:"va_degree",s_sc_max_mva:"s_sc_max_mva",s_sc_min_mva:"s_sc_min_mva",rx_max:"rx_max",rx_min:"rx_min",r0x0_max:"r0x0_max",x0x_max:"x0x_max",in_service:{name:"in_service",optional:!0}})};m.externalGrid.push(t);break;case"Generator":const n={...o,typ:"Generator",...getCachedAttributes(e,{p_mw:"p_mw",vm_pu:"vm_pu",sn_mva:"sn_mva",scaling:"scaling",vn_kv:"vn_kv",xdss_pu:"xdss_pu",rdss_ohm:"rdss_ohm",cos_phi:"cos_phi",pg_percent:"pg_percent",power_station_trafo:"power_station_trafo",in_service:{name:"in_service",optional:!0}})};m.generator.push(n),l.generator++;break;case"Static Generator":const r={...o,typ:"Static Generator",userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),...getAttributesAsObject(e,{p_mw:"p_mw",q_mvar:"q_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",k:"k",rx:"rx",generator_type:"generator_type",lrc_pu:"lrc_pu",max_ik_ka:"max_ik_ka",kappa:"kappa",current_source:"current_source",in_service:{name:"in_service",optional:!0}})};m.staticGenerator.push(r),l.staticGenerator++;break;case"Asymmetric Static Generator":const a={...o,typ:"Asymmetric Static Generator"+l.asymmetricGenerator++,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),...getAttributesAsObject(e,{p_a_mw:"p_a_mw",p_b_mw:"p_b_mw",p_c_mw:"p_c_mw",q_a_mvar:"q_a_mvar",q_b_mvar:"q_b_mvar",q_c_mvar:"q_c_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",in_service:{name:"in_service",optional:!0}})};m.asymmetricGenerator.push(a);break;case"Bus":const s={typ:"Bus"+l.busbar++,name:e.mxObjectId.replace("#","_"),id:e.id,vn_kv:e.value.attributes[2].nodeValue,userFriendlyName:o.userFriendlyName};m.busbar.push(s);break;case"Transformer":const{hv_bus:i,lv_bus:c}=((e,t=!1)=>{const n=e.edges[0],r=e.edges[1],a=n.target.mxObjectId!==e.mxObjectId?n.target:n.source,o=r.target.mxObjectId!==e.mxObjectId?r.target:r.source,isBus=e=>!(!e||!e.style)&&(e.style.includes("shape=mxgraph.electrical.transmission.busbar")||e.style.includes("Bus")||e.value&&e.value.nodeName&&e.value.nodeName.includes("Bus"));return t&&(isBus(a)||console.warn(`Transformer "${e.id}" HV side is connected to "${a.id}" which may not be a Bus. PandaPower requires explicit Bus connections.`),isBus(o)||console.warn(`Transformer "${e.id}" LV side is connected to "${o.id}" which may not be a Bus. PandaPower requires explicit Bus connections.`)),{hv_bus:a.mxObjectId.replace("#","_"),lv_bus:o.mxObjectId.replace("#","_")}})(e),_={typ:"Transformer"+l.transformer++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),hv_bus:i,lv_bus:c,...getAttributesAsObject(e,{sn_mva:"sn_mva",vn_hv_kv:"vn_hv_kv",vn_lv_kv:"vn_lv_kv",vkr_percent:"vkr_percent",vk_percent:"vk_percent",pfe_kw:"pfe_kw",i0_percent:"i0_percent",vector_group:{name:"vector_group",optional:!0},vk0_percent:{name:"vk0_percent",optional:!0},vkr0_percent:{name:"vkr0_percent",optional:!0},mag0_percent:{name:"mag0_percent",optional:!0},si0_hv_partial:{name:"si0_hv_partial",optional:!0},parallel:{name:"parallel",optional:!0},shift_degree:{name:"shift_degree",optional:!0},tap_side:{name:"tap_side",optional:!0},tap_pos:{name:"tap_pos",optional:!0},tap_neutral:{name:"tap_neutral",optional:!0},tap_max:{name:"tap_max",optional:!0},tap_min:{name:"tap_min",optional:!0},tap_step_percent:{name:"tap_step_percent",optional:!0},tap_step_degree:{name:"tap_step_degree",optional:!0},tap_phase_shifter:{name:"tap_phase_shifter",optional:!0},in_service:{name:"in_service",optional:!0}})};m.transformer.push(_);break;case"Three Winding Transformer":const u=(e=>{const[t,n,r]=e.edges,getConnectedBus=t=>(t.target.mxObjectId!==e.mxObjectId?t.target.mxObjectId:t.source.mxObjectId).replace("#","_");return{hv_bus:getConnectedBus(r),mv_bus:getConnectedBus(n),lv_bus:getConnectedBus(t)}})(e),d={typ:"Three Winding Transformer"+l.threeWindingTransformer++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),...u,...getAttributesAsObject(e,{sn_hv_mva:"sn_hv_mva",sn_mv_mva:"sn_mv_mva",sn_lv_mva:"sn_lv_mva",vn_hv_kv:"vn_hv_kv",vn_mv_kv:"vn_mv_kv",vn_lv_kv:"vn_lv_kv",vk_hv_percent:"vk_hv_percent",vk_mv_percent:"vk_mv_percent",vk_lv_percent:"vk_lv_percent",vkr_hv_percent:"vkr_hv_percent",vkr_mv_percent:"vkr_mv_percent",vkr_lv_percent:"vkr_lv_percent",pfe_kw:"pfe_kw",i0_percent:"i0_percent",vk0_hv_percent:"vk0_hv_percent",vk0_mv_percent:"vk0_mv_percent",vk0_lv_percent:"vk0_lv_percent",vkr0_hv_percent:"vkr0_hv_percent",vkr0_mv_percent:"vkr0_mv_percent",vkr0_lv_percent:"vkr0_lv_percent",vector_group:"vector_group",shift_mv_degree:{name:"shift_mv_degree",optional:!0},shift_lv_degree:{name:"shift_lv_degree",optional:!0},tap_step_percent:{name:"tap_step_percent",optional:!0},tap_side:{name:"tap_side",optional:!0},tap_neutral:{name:"tap_neutral",optional:!0},tap_min:{name:"tap_min",optional:!0},tap_max:{name:"tap_max",optional:!0},tap_pos:{name:"tap_pos",optional:!0},tap_at_star_point:{name:"tap_at_star_point",optional:!0},in_service:{name:"in_service",optional:!0}})};m.threeWindingTransformer.push(d);break;case"Shunt Reactor":const p={typ:"Shunt Reactor"+l.shuntReactor++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{p_mw:"p_mw",q_mvar:"q_mvar",vn_kv:"vn_kv",step:{name:"step",optional:!0},max_step:{name:"max_step",optional:!0},in_service:{name:"in_service",optional:!0}})};m.shuntReactor.push(p);break;case"Capacitor":const v={typ:"Capacitor"+l.capacitor++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{q_mvar:"q_mvar",loss_factor:"loss_factor",vn_kv:"vn_kv",step:{name:"step",optional:!0},max_step:{name:"max_step",optional:!0},in_service:{name:"in_service",optional:!0}})};m.capacitor.push(v);break;case"Load":const g={typ:"Load"+l.load++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{p_mw:"p_mw",q_mvar:"q_mvar",const_z_percent:"const_z_percent",const_i_percent:"const_i_percent",sn_mva:"sn_mva",scaling:"scaling",type:"type",in_service:{name:"in_service",optional:!0}})};m.load.push(g);break;case"Asymmetric Load":const h={typ:"Asymmetric Load"+l.asymmetricLoad++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{p_a_mw:"p_a_mw",p_b_mw:"p_b_mw",p_c_mw:"p_c_mw",q_a_mvar:"q_a_mvar",q_b_mvar:"q_b_mvar",q_c_mvar:"q_c_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",in_service:{name:"in_service",optional:!0}})};m.asymmetricLoad.push(h);break;case"Impedance":try{const t={typ:"Impedance"+l.impedance++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),...getImpedanceConnections(e),...getAttributesAsObject(e,{rft_pu:"rft_pu",xft_pu:"xft_pu",sn_mva:"sn_mva",in_service:{name:"in_service",optional:!0}})};m.impedance.push(t)}catch(e){alert(e.message)}break;case"Ward":const f={typ:"Ward"+l.ward++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{ps_mw:"ps_mw",qs_mvar:"qs_mvar",pz_mw:"pz_mw",qz_mvar:"qz_mvar",in_service:{name:"in_service",optional:!0}})};m.ward.push(f);break;case"Extended Ward":const b={typ:"Extended Ward"+l.extendedWard++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{ps_mw:"ps_mw",qs_mvar:"qs_mvar",pz_mw:"pz_mw",qz_mvar:"qz_mvar",r_ohm:"r_ohm",x_ohm:"x_ohm",vm_pu:"vm_pu",in_service:{name:"in_service",optional:!0}})};m.extendedWard.push(b);break;case"Motor":const w={typ:"Motor"+l.motor++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{pn_mech_mw:"pn_mech_mw",cos_phi:"cos_phi",efficiency_percent:"efficiency_percent",loading_percent:"loading_percent",scaling:"scaling",cos_phi_n:"cos_phi_n",efficiency_n_percent:"efficiency_n_percent",Irc_pu:"Irc_pu",rx:"rx",vn_kv:"vn_kv",efficiency_percent:"efficiency_percent",loading_percent:"loading_percent",scaling:"scaling",in_service:{name:"in_service",optional:!0}})};m.motor.push(w);break;case"Storage":const x={typ:"Storage"+l.storage++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{p_mw:"p_mw",max_e_mwh:"max_e_mwh",q_mvar:"q_mvar",sn_mva:"sn_mva",soc_percent:"soc_percent",min_e_mwh:"min_e_mwh",scaling:"scaling",type:"type",in_service:{name:"in_service",optional:!0}})};m.storage.push(x);break;case"SVC":const y={typ:"SVC"+l.SVC++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{x_l_ohm:"x_l_ohm",x_cvar_ohm:"x_cvar_ohm",set_vm_pu:"set_vm_pu",thyristor_firing_angle_degree:"thyristor_firing_angle_degree",controllable:"controllable",min_angle_degree:"min_angle_degree",max_angle_degree:"max_angle_degree",in_service:{name:"in_service",optional:!0}})};m.SVC.push(y);break;case"TCSC":const k={typ:"TCSC"+l.TCSC++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{x_l_ohm:"x_l_ohm",x_cvar_ohm:"x_cvar_ohm",set_p_to_mw:"set_p_to_mw",thyristor_firing_angle_degree:"thyristor_firing_angle_degree",controllable:"controllable",min_angle_degree:"min_angle_degree",max_angle_degree:"max_angle_degree",in_service:{name:"in_service",optional:!0}})};m.TCSC.push(k);break;case"SSC":const $={typ:"SSC"+l.SSC++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{r_ohm:"r_ohm",x_ohm:"x_ohm",set_vm_pu:"set_vm_pu",vm_internal_pu:"vm_internal_pu",va_internal_degree:"va_internal_degree",controllable:"controllable",in_service:{name:"in_service",optional:!0}})};m.SSC.push($);break;case"DC Line":const C={typ:"DC Line"+l.dcLine++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),bus:getConnectedBusId(e),...getAttributesAsObject(e,{p_mw:"p_mw",loss_percent:"loss_percent",loss_mw:"loss_mw",vm_from_pu:"vm_from_pu",vm_to_pu:"vm_to_pu",in_service:{name:"in_service",optional:!0}})};m.dcLine.push(C);break;case"Line":const E={typ:"Line"+l.line++,name:e.mxObjectId.replace("#","_"),id:e.id,userFriendlyName:(()=>{if(e.value&&e.value.attributes)for(let t=0;t<e.value.attributes.length;t++)if("name"===e.value.attributes[t].nodeName)return e.value.attributes[t].nodeValue;return e.mxObjectId.replace("#","_")})(),...getConnectedBuses(e),...getAttributesAsObject(e,{length_km:"length_km",parallel:{name:"parallel",optional:!0},df:{name:"df",optional:!0},in_service:{name:"in_service",optional:!0},r_ohm_per_km:"r_ohm_per_km",x_ohm_per_km:"x_ohm_per_km",c_nf_per_km:"c_nf_per_km",g_us_per_km:"g_us_per_km",max_i_ka:"max_i_ka",type:"type",r0_ohm_per_km:{name:"r0_ohm_per_km",optional:!0},x0_ohm_per_km:{name:"x0_ohm_per_km",optional:!0},c0_nf_per_km:{name:"c0_nf_per_km",optional:!0},endtemp_degree:{name:"endtemp_degree",optional:!0}})};try{!function validateBusConnections(e){if(!e.source?.mxObjectId)throw new Error("Error: cell.source or its mxObjectId is null or undefined");if(!e.target?.mxObjectId)throw new Error("Error: cell.target or its mxObjectId is null or undefined")}(e),setCellStyle(e,{strokeColor:"black"})}catch(t){console.error(t.message),setCellStyle(e,{strokeColor:"red"}),alert("The line is not connected to the bus. Please check the line highlighted in red and connect it to the appropriate bus.")}m.line.push(E)}const s=performance.now()-a;L[n]||(L[n]={time:0,count:0}),L[n].time+=s,L[n].count++}),m.transformer.length>0&&(m.transformer=updateTransformerBusConnections(m.transformer,m.busbar,n)),m.threeWindingTransformer.length>0&&(m.threeWindingTransformer=updateThreeWindingTransformerConnections(m.threeWindingTransformer,m.busbar,n));const j=performance.now(),M=[];let R=0;const addComponents=e=>{for(let t=0;t<e.length;t++)M[R++]=e[t]};addComponents(m.simulationParameters),addComponents(m.externalGrid),addComponents(m.generator),addComponents(m.staticGenerator),addComponents(m.asymmetricGenerator),addComponents(m.busbar),addComponents(m.transformer),addComponents(m.threeWindingTransformer),addComponents(m.shuntReactor),addComponents(m.capacitor),addComponents(m.load),addComponents(m.asymmetricLoad),addComponents(m.impedance),addComponents(m.ward),addComponents(m.extendedWard),addComponents(m.motor),addComponents(m.storage),addComponents(m.SSC),addComponents(m.SVC),addComponents(m.TCSC),addComponents(m.dcLine),addComponents(m.line);const I=performance.now()-j,T=performance.now()-V;console.log(`Component processing: ${T.toFixed(2)}ms (pre-compute: ${A.toFixed(2)}ms, processed ${O} components)`),console.log("=== COMPONENT TYPE BREAKDOWN ==="),Object.entries(L).sort(([,e],[,t])=>t.time-e.time).forEach(([e,{time:t,count:n}])=>{console.log(`${e}: ${t.toFixed(2)}ms (${n} items, ${(t/n).toFixed(2)}ms/item)`)});const X=performance.now(),W=Object.assign({},M),U=performance.now()-X,Q={};Object.keys(W).forEach(e=>{W[e]&&"object"==typeof W[e]&&(Q[e]=JSON.stringify(W[e]).length)});const D=performance.now()-o;console.log("=== PERFORMANCE BREAKDOWN ==="),console.log(`Cell processing: ${N.toFixed(2)}ms (cell removal: ${P.toFixed(2)}ms)`),console.log(`Component processing: ${T.toFixed(2)}ms (pre-compute: ${A.toFixed(2)}ms)`),console.log(`Array building: ${I.toFixed(2)}ms`),console.log(`Object creation: ${U.toFixed(2)}ms`),console.log(`Total data processing: ${D.toFixed(2)}ms`),console.log(`Payload size: ${JSON.stringify(W).length} bytes`),console.log(`Components: ${O}, Result cells removed: ${y}`),console.log("Payload composition:",Q),console.log("üîç About to send to backend - First element (simulationParameters):",W[0]),console.log("üîç exportPython value in payload:",W[0]?.exportPython),console.log("üîç exportPandapowerResults value in payload:",W[0]?.exportPandapowerResults),async function processNetworkData(e,t,n,r){try{const a=n.getStylesheet();a.getCellStyle("labelstyle")||(a.putCellStyle("labelstyle",p.label),a.putCellStyle("lineStyle",p.line)),console.log("üîç Payload obj[0] (simulationParameters):",t[0]),console.log("üîç exportPython value:",t[0]?.exportPython),console.log("üîç Full payload keys:",Object.keys(t));const o=await fetch(e,{mode:"cors",method:"post",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate, br"},body:JSON.stringify(t)});if(200!==o.status)throw new Error("server");const l=await o.json();if(console.log("Received data size:",JSON.stringify(l).length,"bytes"),console.log("Response keys:",Object.keys(l)),console.log("Has pandapower_python?","pandapower_python"in l),function handleNetworkErrors(e){if(e.error&&e.diagnostic)return console.log("Power flow failed with diagnostic information:",e),window.DiagnosticReportDialog?new window.DiagnosticReportDialog(e.diagnostic,{message:e.message,exception:e.exception}).show():alert(`Power flow calculation failed: ${e.message}\n\nException: ${e.exception}`),!0;if(e.error&&!e.diagnostic)return console.error("Power flow calculation failed:",e.error),alert(`Power flow calculation failed:\n\n${e.error}`),!0;const t={line:"Line",bus:"Bus",ext_grid:"External Grid",trafo3w:"Three-winding transformer: nominal voltage does not match",overload:"One of the element is overloaded. The load flow did not converge. Contact electrisim@electrisim.com"};if(!e[0])return!1;const n=Array.isArray(e[0])?e[0][0]:e[0];if("trafo3w"===n||"overload"===n)return alert(t[n]),!0;if(t[n]){for(let r=1;r<e.length;r++)alert(`${t[n]}${e[r][0]} ${e[r][1]} = ${e[r][2]} (restriction: ${e[r][3]})\nPower Flow did not converge`);return!0}return!1}(l))return;l.pandapower_python?(console.log("‚úÖ Exporting Pandapower Python code to file..."),console.log("Python code length:",l.pandapower_python.length,"characters"),(e=>{console.log("üîΩ downloadPandapowerPython() called"),console.log("Python code to download:",e?e.substring(0,100)+"...":"NULL/UNDEFINED");try{if(!e||0===e.length)return console.error("‚ùå Cannot download: Python code is empty or undefined"),void alert("Cannot download: Python code is empty");const t=new Blob([e],{type:"text/plain"});console.log("Blob created, size:",t.size,"bytes");const n=URL.createObjectURL(t),r=document.createElement("a");r.href=n;const a=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,-5);r.download=`Pandapower_Model_${a}.py`,console.log("Download filename:",r.download),document.body.appendChild(r),console.log("Link added to DOM, triggering click..."),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n),console.log("‚úÖ Pandapower Python code file downloaded successfully!")}catch(e){console.error("‚ùå Error downloading Pandapower Python code:",e),alert("Failed to download Pandapower Python code file. Error: "+e.message)}})(l.pandapower_python)):console.log("‚ÑπÔ∏è No Python code export requested or available in response"),console.log("üîç Checking for Pandapower results export..."),console.log("  - obj exists:",!!t),console.log("  - obj[0] exists:",!(!t||!t[0])),console.log("  - obj[0]:",t?t[0]:"obj is null"),console.log("  - exportPandapowerResults value:",t&&t[0]?t[0].exportPandapowerResults:"N/A"),t&&t[0]&&t[0].exportPandapowerResults?(console.log("‚úÖ Exporting Pandapower results to file..."),(e=>{console.log("üîΩ downloadPandapowerResults() called");try{let t="========================================\n";if(t+="   Pandapower Load Flow Results\n",t+="========================================\n\n",t+=`Generated: ${(new Date).toISOString()}\n\n`,e.externalgrids&&e.externalgrids.length>0){t+="--- EXTERNAL GRIDS ---\n";const n=[20,12,12,12,10];t+=createTableRow(["Name","P [MW]","Q [MVAr]","PF","Q/P"],n)+"\n",t+=createTableSeparator(n)+"\n",e.externalgrids.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A",e.pf?e.pf.toFixed(3):"N/A",e.q_p?e.q_p.toFixed(3):"N/A"];t+=createTableRow(r,n)+"\n"}),t+="\n"}if(e.busbars&&e.busbars.length>0){t+="--- BUSES ---\n";const n=[20,12,14];t+=createTableRow(["Name","U [pu]","U [degree]"],n)+"\n",t+=createTableSeparator(n)+"\n",e.busbars.forEach(e=>{const r=[e.name||"N/A",e.vm_pu?e.vm_pu.toFixed(3):"N/A",e.va_degree?e.va_degree.toFixed(3):"N/A"];t+=createTableRow(r,n)+"\n"}),t+="\n"}if(e.lines&&e.lines.length>0){t+="--- LINES ---\n";const n=[20,13,14,13,12,13,12,13];t+=createTableRow(["Name","P_from [MW]","Q_from [MVAr]","I_from [kA]","P_to [MW]","Q_to [MVAr]","I_to [kA]","Loading [%]"],n)+"\n",t+=createTableSeparator(n)+"\n",e.lines.forEach(e=>{const r=[e.name||"N/A",e.p_from_mw?e.p_from_mw.toFixed(3):"N/A",e.q_from_mvar?e.q_from_mvar.toFixed(3):"N/A",e.i_from_ka?e.i_from_ka.toFixed(3):"N/A",e.p_to_mw?e.p_to_mw.toFixed(3):"N/A",e.q_to_mvar?e.q_to_mvar.toFixed(3):"N/A",e.i_to_ka?e.i_to_ka.toFixed(3):"N/A",e.loading_percent?e.loading_percent.toFixed(1):"N/A"];t+=createTableRow(r,n)+"\n"}),t+="\n"}if(e.transformers&&e.transformers.length>0){t+="--- TRANSFORMERS ---\n";const n=[20,13,13,12,13,12,12,13,12];t+=createTableRow(["Name","P_HV [MW]","Q_HV [MVAr]","P_LV [MW]","Q_LV [MVAr]","I_HV [kA]","I_LV [kA]","Loading [%]","Loss [MW]"],n)+"\n",t+=createTableSeparator(n)+"\n",e.transformers.forEach(e=>{const r=[e.name||"N/A",e.p_hv_mw?e.p_hv_mw.toFixed(3):"N/A",e.q_hv_mvar?e.q_hv_mvar.toFixed(3):"N/A",e.p_lv_mw?e.p_lv_mw.toFixed(3):"N/A",e.q_lv_mvar?e.q_lv_mvar.toFixed(3):"N/A",e.i_hv_ka?e.i_hv_ka.toFixed(3):"N/A",e.i_lv_ka?e.i_lv_ka.toFixed(3):"N/A",e.loading_percent?e.loading_percent.toFixed(1):"N/A",e.pl_mw?e.pl_mw.toFixed(3):"N/A"];t+=createTableRow(r,n)+"\n"}),t+="\n"}if(e.generators&&e.generators.length>0){t+="--- GENERATORS ---\n";const n=[20,12,12,10,14];t+=createTableRow(["Name","P [MW]","Q [MVAr]","U [pu]","U [degree]"],n)+"\n",t+=createTableSeparator(n)+"\n",e.generators.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A",e.vm_pu?e.vm_pu.toFixed(3):"N/A",e.va_degree?e.va_degree.toFixed(3):"N/A"];t+=createTableRow(r,n)+"\n"}),t+="\n"}if(e.staticgenerators&&e.staticgenerators.length>0){t+="--- STATIC GENERATORS ---\n";const n=[20,12,12];t+=createTableRow(["Name","P [MW]","Q [MVAr]"],n)+"\n",t+=createTableSeparator(n)+"\n",e.staticgenerators.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A"];t+=createTableRow(r,n)+"\n"}),t+="\n"}if(e.loads&&e.loads.length>0){t+="--- LOADS ---\n";const n=[20,12,12];t+=createTableRow(["Name","P [MW]","Q [MVAr]"],n)+"\n",t+=createTableSeparator(n)+"\n",e.loads.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A"];t+=createTableRow(r,n)+"\n"}),t+="\n"}if(e.shunts&&e.shunts.length>0){t+="--- SHUNT REACTORS ---\n";const n=[20,12,12,10];t+=createTableRow(["Name","P [MW]","Q [MVAr]","U [pu]"],n)+"\n",t+=createTableSeparator(n)+"\n",e.shunts.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A",e.vm_pu?e.vm_pu.toFixed(3):"N/A"];t+=createTableRow(r,n)+"\n"}),t+="\n"}if(e.capacitors&&e.capacitors.length>0){t+="--- CAPACITORS ---\n";const n=[20,12,12,10];t+=createTableRow(["Name","P [MW]","Q [MVAr]","U [pu]"],n)+"\n",t+=createTableSeparator(n)+"\n",e.capacitors.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A",e.vm_pu?e.vm_pu.toFixed(3):"N/A"];t+=createTableRow(r,n)+"\n"}),t+="\n"}t+="========================================\n",t+="          End of Results\n",t+="========================================\n";const n=new Blob([t],{type:"text/plain;charset=utf-8"}),r=URL.createObjectURL(n),a=document.createElement("a");a.href=r;const o=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,-5);a.download=`Pandapower_Results_${o}.txt`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r),console.log("‚úÖ Pandapower results file downloaded successfully!")}catch(e){console.error("‚ùå Error downloading Pandapower results:",e),alert("Failed to download Pandapower results file. Error: "+e.message)}})(l)):(console.log("‚ÑπÔ∏è Pandapower results export not requested or flag not set"),console.log("  Condition breakdown:"),console.log("    - obj:",!!t),console.log("    - obj[0]:",!(!t||!t[0])),console.log("    - obj[0].exportPandapowerResults:",!!(t&&t[0]&&t[0].exportPandapowerResults)));const s=performance.now();console.log("Starting result visualization..."),n.getModel().beginUpdate();try{const e=[];Object.entries(f).forEach(([t,a])=>{l[t]&&e.push({type:t,operation:()=>a(l[t],n,r),dataSize:l[t].length})});for(const{type:t,operation:n,dataSize:r}of e){const e=performance.now();n();const a=performance.now()-e;console.log(`${t} processing: ${a.toFixed(2)}ms (${r} items)`),r>50&&a>100&&await new Promise(e=>setTimeout(e,0))}}finally{n.getModel().endUpdate();const e=performance.now()-s;console.log(`Total result visualization: ${e.toFixed(2)}ms`)}}catch(e){if("server"===e.message)return}finally{void 0!==b&&b.spinner&&b.spinner.stop()}}("https://03dht3kc-5000.euw.devtunnels.ms/",W,n,w),console.log(`Simulation completed. Cache sizes - cells: ${i.size}, names: ${c.size}, attributes: ${_.size}`),i.clear(),c.clear(),_.clear(),console.log("Caches cleared for next simulation")}})}globalThis.simulationRunCount||(globalThis.simulationRunCount=0),globalThis.loadFlowPandaPower=loadFlowPandaPower;export{loadFlowPandaPower};