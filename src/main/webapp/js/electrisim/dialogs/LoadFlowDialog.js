import{Dialog as e}from"../Dialog.js";import{ensureSubscriptionFunctions as t}from"../ensureSubscriptionFunctions.js";console.log("ðŸ”¥ LoadFlowDialog.js LOADED - Version 2024-10-18 14:30 - WITH NEW OPENDSS PARAMETERS");export class LoadFlowDialog extends e{constructor(e){super("Load Flow Parameters","Calculate"),console.log("ðŸ”¥ LoadFlowDialog constructor called - OpenDSS params include: mode, loadmodel, controlmode"),console.log("   - this.inputs from parent:",this.inputs),console.log("   - this.inputs is Map:",this.inputs instanceof Map),console.log("   - this.inputs size:",this.inputs.size),this.ui=e||window.App?.main?.editor?.editorUi,this.graph=this.ui?.editor?.graph,this.pandapowerParameters=[{id:"frequency",label:"Frequency",type:"radio",options:[{value:"50",label:"50 Hz",default:!0},{value:"60",label:"60 Hz"}]},{id:"algorithm",label:"Algorithm",type:"radio",options:[{value:"nr",label:"Newton-Raphson",default:!0},{value:"iwamoto_nr",label:"Iwamoto"},{value:"bfsw",label:"Backward Forward Sweep"},{value:"gs",label:"Gauss-Seidel"},{value:"fdbx",label:"FDBX"},{value:"fdxb",label:"FDXB"}]},{id:"calculate_voltage_angles",label:"Calculate Voltage Angles",type:"radio",options:[{value:"auto",label:"Auto",default:!0},{value:!0,label:"True"},{value:!1,label:"False"}]},{id:"initialization",label:"Initialization",type:"radio",options:[{value:"auto",label:"Auto",default:!0},{value:"flat",label:"Flat"},{value:"dc",label:"DC"}]},{id:"maxIterations",label:"Max Iterations",type:"number",value:"100"},{id:"tolerance",label:"Tolerance",type:"number",value:"1e-6"},{id:"enforceLimits",label:"Enforce Q Limits",type:"checkbox",value:!1},{id:"exportPython",label:"Export Pandapower Python Code (download .py file)",type:"checkbox",value:!1},{id:"exportPandapowerResults",label:"Export Pandapower Results (download .txt file)",type:"checkbox",value:!1}],this.opendssParameters=[{id:"frequency",label:"Base Frequency",type:"radio",options:[{value:"50",label:"50 Hz",default:!0},{value:"60",label:"60 Hz"}]},{id:"mode",label:"Solution Mode",type:"radio",options:[{value:"Snapshot",label:"Snapshot (Single Solution)",default:!0},{value:"Daily",label:"Daily (24-hour simulation)"},{value:"Dutycycle",label:"Dutycycle (Time-varying)"},{value:"Yearly",label:"Yearly"}]},{id:"algorithm",label:"Solution Algorithm",type:"radio",options:[{value:"Normal",label:"Normal (Fast current injection)",default:!0},{value:"Newton",label:"Newton (Robust for difficult circuits)"}]},{id:"loadmodel",label:"Load Model",type:"radio",options:[{value:"Powerflow",label:"Powerflow (Iterative with power injections)",default:!0},{value:"Admittance",label:"Admittance (Direct solution)"}]},{id:"maxIterations",label:"Max Iterations",type:"number",value:"100"},{id:"tolerance",label:"Convergence Tolerance",type:"number",value:"0.0001"},{id:"controlmode",label:"Control Mode",type:"radio",options:[{value:"Static",label:"Static (No control actions)",default:!0},{value:"Event",label:"Event (Time-based controls)"},{value:"Time",label:"Time (Continuous controls)"}]},{id:"exportCommands",label:"Export OpenDSS Commands (download .txt file)",type:"checkbox",value:!1},{id:"exportOpenDSSResults",label:"Export OpenDSS Results (download .txt file)",type:"checkbox",value:!1}],this.currentTab="pandapower",this.parameters=this.pandapowerParameters}getDescription(){return"<strong>Configure load flow calculation parameters</strong><br>Choose between Pandapower and OpenDSS engines."}createTabInterface(){const e=document.createElement("div");Object.assign(e.style,{display:"flex",flexDirection:"column",width:"100%",marginBottom:"16px"});const t=document.createElement("div");Object.assign(t.style,{display:"flex",borderBottom:"2px solid #e9ecef",marginBottom:"16px"});const o=this.createTabHeader("Pandapower","pandapower",!0),n=this.createTabHeader("OpenDSS","opendss",!1);return t.appendChild(o),t.appendChild(n),e.appendChild(t),e}createTabHeader(e,t,o){const n=document.createElement("div");return n.setAttribute("data-tab-id",t),Object.assign(n.style,{padding:"12px 24px",cursor:"pointer",borderBottom:o?"2px solid #007bff":"2px solid transparent",color:o?"#007bff":"#6c757d",fontWeight:o?"600":"400",backgroundColor:o?"#f8f9fa":"transparent",borderTopLeftRadius:"4px",borderTopRightRadius:"4px",transition:"all 0.2s ease"}),n.textContent=e,n.onclick=()=>this.switchTab(t),n.onmouseenter=()=>{o||(n.style.backgroundColor="#e9ecef",n.style.color="#495057")},n.onmouseleave=()=>{o||(n.style.backgroundColor="transparent",n.style.color="#6c757d")},n}switchTab(e){console.log("ðŸ”¥ðŸ”¥ðŸ”¥ SWITCHING TAB ðŸ”¥ðŸ”¥ðŸ”¥"),console.log("   FROM:",this.currentTab,"TO:",e),console.log("   Stack trace:",(new Error).stack),this.currentTab=e,console.log("âš ï¸ ABOUT TO CLEAR INPUTS MAP - THIS WILL LOSE CHECKBOX STATE!"),console.log("   Inputs before clear:",Array.from(this.inputs.keys())),this.inputs.clear(),console.log("ðŸ”¥ Cleared inputs map"),"pandapower"===e?(this.parameters=this.pandapowerParameters,console.log("ðŸ”¥ Loaded Pandapower parameters")):(this.parameters=this.opendssParameters,console.log("ðŸ”¥ Loaded OpenDSS parameters:",this.opendssParameters.map(e=>e.id)));const t=this.container.querySelectorAll("[data-tab-id]");console.log("Found tabs:",t.length,"for tabId:",e),t.forEach(t=>{const o=t.getAttribute("data-tab-id"),n=o===e;console.log("Tab:",o,"isActive:",n),t.style.borderBottomColor=n?"#007bff":"transparent",t.style.color=n?"#007bff":"#6c757d",t.style.fontWeight=n?"600":"400",t.style.backgroundColor=n?"#f8f9fa":"transparent"}),this.recreateForm()}recreateForm(){console.log("ðŸ”¥ recreateForm() called");const e=this.container.querySelector('[data-form-container="true"]');if(console.log("ðŸ”¥ scrollableContent found:",!!e),e){const t=e.querySelector("form");if(console.log("ðŸ”¥ existingForm found:",!!t),t){console.log("ðŸ”¥ Replacing form with new parameters");const o=this.createForm();e.replaceChild(o,t),console.log("ðŸ”¥ Form replaced successfully")}else console.error("ðŸ”¥ ERROR: No form found inside scrollableContent!")}else console.error("ðŸ”¥ ERROR: scrollableContent not found! Container:",this.container)}createForm(){console.log("ðŸ”¥ createForm() called with",this.parameters.length,"parameters"),console.log("ðŸ”¥ Parameter IDs:",this.parameters.map(e=>e.id));const e=document.createElement("form");return Object.assign(e.style,{display:"flex",flexDirection:"column",gap:"8px",width:"100%",boxSizing:"border-box"}),this.parameters.forEach((t,o)=>{console.log(`ðŸ”¥ Creating form field ${o}:`,t.id,t.label);const n=document.createElement("div");Object.assign(n.style,{marginBottom:"4px"});const l=document.createElement("label");let a;Object.assign(l.style,{display:"block",marginBottom:"2px",fontWeight:"600",fontSize:"13px",color:"#495057"}),l.textContent=t.label,n.appendChild(l),a="radio"===t.type?this.createRadioGroup(t):"checkbox"===t.type?this.createCheckbox(t):this.createTextInput(t),n.appendChild(a),e.appendChild(n)}),e}createRadioGroup(e){const t=document.createElement("div");return Object.assign(t.style,{display:"flex",flexDirection:"column",gap:"6px"}),e.options.forEach((o,n)=>{const l=document.createElement("div");Object.assign(l.style,{display:"flex",alignItems:"center",gap:"8px"});const a=document.createElement("input");a.type="radio",a.name=e.id,a.value=o.value,a.checked=o.default||!1,a.id=`${e.id}_${n}`,Object.assign(a.style,{width:"16px",height:"16px",accentColor:"#007bff"});const i=document.createElement("label");i.htmlFor=`${e.id}_${n}`,i.textContent=o.label,Object.assign(i.style,{fontSize:"13px",color:"#6c757d",cursor:"pointer"}),l.appendChild(a),l.appendChild(i),t.appendChild(l),0===n&&this.inputs.set(e.id,t)}),t}createCheckbox(e){const t=document.createElement("div");Object.assign(t.style,{display:"flex",alignItems:"center",gap:"8px"});const o=document.createElement("input");o.type="checkbox",o.id=e.id,o.checked=e.value,o.setAttribute("data-param-id",e.id),Object.assign(o.style,{width:"16px",height:"16px",accentColor:"#007bff"}),o.addEventListener("change",t=>{if(console.log("âœ…âœ…âœ… CHECKBOX CHANGE EVENT FIRED âœ…âœ…âœ…"),console.log(`   - Checkbox ID: ${e.id}`),console.log(`   - New value: ${t.target.checked}`),console.log(`   - Element ID: ${t.target.id}`),console.log(`   - Instance ID: ${t.target.getAttribute("data-instance-id")}`),console.log(`   - Timestamp: ${(new Date).toISOString()}`),console.log("   - Element in inputs map:",this.inputs.get(e.id)===t.target),console.log("   - Inputs map has key:",this.inputs.has(e.id)),this.inputs.has(e.id)){const o=this.inputs.get(e.id);console.log("   - Map checkbox instance ID:",o.getAttribute("data-instance-id")),console.log("   - Same element:",o===t.target)}setTimeout(()=>{console.log(`   - [Verification 100ms later] Checkbox ${e.id} is still ${t.target.checked}`),console.log(`   - [Verification] Instance ID: ${t.target.getAttribute("data-instance-id")}`)},100)}),this.inputs.set(e.id,o),o.setAttribute("data-instance-id",`checkbox_${Date.now()}_${Math.random()}`),console.log(`ðŸ“ Created checkbox ${e.id}, stored in inputs map, initial checked=${o.checked}`),console.log("   - Stored element:",this.inputs.get(e.id)),console.log("   - Checkbox ID:",o.id),console.log("   - Instance ID:",o.getAttribute("data-instance-id"));const n=document.createElement("label");return n.htmlFor=e.id,n.textContent=e.label,Object.assign(n.style,{fontSize:"13px",color:"#6c757d",cursor:"pointer"}),t.appendChild(o),t.appendChild(n),t}createTextInput(e){const t=document.createElement("input");return t.type=e.type,t.id=e.id,t.value=e.value,Object.assign(t.style,{width:"100%",padding:"6px 10px",border:"1px solid #ced4da",borderRadius:"4px",fontSize:"13px",fontFamily:"inherit",backgroundColor:"#ffffff"}),t.addEventListener("focus",()=>{t.style.borderColor="#007bff",t.style.outline="none",t.style.boxShadow="0 0 0 2px rgba(0, 102, 204, 0.2)"}),t.addEventListener("blur",()=>{t.style.borderColor="#ced4da",t.style.boxShadow="none"}),this.inputs.set(e.id,t),t}getFormValues(){const e={};return console.log("ðŸ“‹ getFormValues() called"),console.log("Current tab:",this.currentTab),console.log("Parameters count:",this.parameters.length),console.log("Inputs map size:",this.inputs.size),console.log("Inputs map keys:",Array.from(this.inputs.keys())),this.parameters.forEach(t=>{if("radio"===t.type){const o=this.inputs.get(t.id);if(o){const n=o.querySelector(`input[name="${t.id}"]:checked`);e[t.id]=n?n.value:t.options[0].value}}else if("checkbox"===t.type){let o=this.inputs.get(t.id);console.log(`Checkbox ${t.id} from inputs map:`,o?`exists, checked=${o.checked}`:"NOT FOUND"),o&&console.log("  - Instance ID from map:",o.getAttribute("data-instance-id")),o||(o=document.getElementById(t.id),console.log(`  Fallback DOM lookup for ${t.id}:`,o?`found, checked=${o.checked}`:"NOT FOUND"),o&&console.log("  - Instance ID from DOM:",o.getAttribute("data-instance-id"))),!o&&this.container&&(o=this.container.querySelector(`input[type="checkbox"]#${t.id}`),console.log(`  Container lookup for ${t.id}:`,o?`found, checked=${o.checked}`:"NOT FOUND"),o&&console.log("  - Instance ID from container:",o.getAttribute("data-instance-id"))),o?(e[t.id]=o.checked,console.log(`  âœ… Final value for ${t.id}:`,o.checked),console.log("  âœ… Instance ID:",o.getAttribute("data-instance-id"))):(e[t.id]=t.value||!1,console.log(`  âš ï¸ Using default value for ${t.id}:`,t.value||!1))}else{const o=this.inputs.get(t.id);e[t.id]=o?o.value:t.value}}),e.engine=this.currentTab,console.log("ðŸ“‹ Collected values:",e),e}show(e){console.log("ðŸš€ LoadFlowDialog.show() called"),console.log("   - this.inputs before clear:",this.inputs),console.log("   - this.inputs size before clear:",this.inputs.size),this.inputs.clear(),console.log("ðŸ”„ Inputs map cleared at dialog show"),console.log("   - this.inputs after clear:",this.inputs),console.log("   - this.inputs is Map:",this.inputs instanceof Map);const t=document.createElement("div");if(Object.assign(t.style,{fontFamily:"Arial, sans-serif",fontSize:"14px",lineHeight:"1.5",color:"#333",padding:"0",margin:"0",width:"100%",boxSizing:"border-box",display:"flex",flexDirection:"column",minHeight:"0",maxHeight:"100%"}),this.getDescription){const e=document.createElement("div");Object.assign(e.style,{padding:"6px 10px",backgroundColor:"#e3f2fd",border:"1px solid #bbdefb",borderRadius:"4px",fontSize:"12px",color:"#1565c0",marginBottom:"12px"}),e.innerHTML=this.getDescription(),t.appendChild(e)}const o=this.createTabInterface();t.appendChild(o);const n=document.createElement("div");n.setAttribute("data-form-container","true"),Object.assign(n.style,{flex:"1",overflowY:"auto",paddingRight:"5px",marginBottom:"16px",minHeight:"300px",maxHeight:"450px"});const l=this.createForm();if(n.appendChild(l),t.appendChild(n),console.log("ðŸ“‹ After createForm() - inputs map state:"),console.log("   - Size:",this.inputs.size),console.log("   - Keys:",Array.from(this.inputs.keys())),console.log("   - Has exportPython:",this.inputs.has("exportPython")),this.inputs.has("exportPython")){const e=this.inputs.get("exportPython");console.log("   - exportPython checkbox:",e),console.log("   - exportPython checkbox.checked:",e.checked),console.log("   - exportPython checkbox.id:",e.id)}const a=document.createElement("div");Object.assign(a.style,{display:"flex",gap:"8px",justifyContent:"flex-end",paddingTop:"16px",borderTop:"1px solid #e9ecef",flexShrink:"0"});const i=this.createButton("Cancel","#6c757d","#5a6268"),s=this.createButton(this.submitButtonText,"#007bff","#0056b3");i.onclick=e=>{e.preventDefault(),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},s.onclick=async t=>{t.preventDefault();try{console.log("LoadFlowDialog: Starting subscription check...");const t=await this.checkSubscriptionStatus();if(console.log("LoadFlowDialog: Subscription check result:",t),!t)return console.log("LoadFlowDialog: No subscription, showing modal..."),this.modalOverlay&&this.modalOverlay.parentNode&&document.body.removeChild(this.modalOverlay),void(window.showSubscriptionModal?(console.log("LoadFlowDialog: Calling showSubscriptionModal"),window.showSubscriptionModal()):(console.error("LoadFlowDialog: Subscription modal not available"),alert("A subscription is required to use the Load Flow calculation feature.")));console.log("LoadFlowDialog: Subscription check passed, proceeding with calculation..."),console.log("=== PRE-CALLBACK DEBUG ==="),console.log("Current tab:",this.currentTab),console.log("Inputs map size before getFormValues:",this.inputs.size),console.log("Inputs map keys:",Array.from(this.inputs.keys()));const o=this.container?this.container.querySelectorAll('input[type="checkbox"]'):[];if(console.log("All checkboxes in container:",o.length),o.forEach((e,t)=>{console.log(`  Checkbox ${t}: id="${e.id}", checked=${e.checked}, instance="${e.getAttribute("data-instance-id")}"`)}),this.inputs.has("exportPython")){const e=this.inputs.get("exportPython");console.log("exportPython checkbox found in inputs map:"),console.log("  - checked:",e.checked),console.log("  - id:",e.id),console.log("  - type:",e.type),console.log("  - instance ID:",e.getAttribute("data-instance-id")),console.log("  - Element still in DOM:",document.body.contains(e));const t=document.getElementById("exportPython");t&&t!==e&&(console.warn("âš ï¸ FOUND DIFFERENT CHECKBOX IN DOM WITH SAME ID!"),console.log("  - DOM checkbox checked:",t.checked),console.log("  - DOM checkbox instance ID:",t.getAttribute("data-instance-id")),console.log("  - Map checkbox instance ID:",e.getAttribute("data-instance-id")))}else{console.warn("âŒ exportPython checkbox NOT FOUND in inputs map!"),console.log("Attempting direct DOM lookup...");const e=document.getElementById("exportPython");e?(console.log("âœ… Found via DOM lookup:"),console.log("  - checked:",e.checked),console.log("  - id:",e.id),console.log("  - instance ID:",e.getAttribute("data-instance-id"))):console.error("âŒ NOT FOUND via DOM lookup either!")}const n=this.getFormValues();console.log(`${this.title} collected values:`,n),console.log("exportPython in values:","exportPython"in n),console.log("exportPython value:",n.exportPython),console.log("exportPython type:",typeof n.exportPython),console.log("=== END PRE-CALLBACK DEBUG ==="),e&&(console.log("Calling callback with values:",n),e(n)),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()}catch(e){console.error("LoadFlowDialog: Error checking subscription status:",e),alert("Unable to verify subscription status. Please try again.")}},a.appendChild(i),a.appendChild(s),t.appendChild(a),this.container=t,this.createModalOverlay(),this.displayDialog()}createModalOverlay(){this.modalOverlay=document.createElement("div"),Object.assign(this.modalOverlay.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:"10000",display:"flex",justifyContent:"center",alignItems:"center"});const e=document.createElement("div");Object.assign(e.style,{backgroundColor:"white",borderRadius:"8px",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.3)",width:"600px",maxWidth:"90vw",maxHeight:"85vh",minHeight:"600px",overflow:"hidden",display:"flex",flexDirection:"column"});const t=document.createElement("div");Object.assign(t.style,{padding:"16px 20px",backgroundColor:"#f8f9fa",borderBottom:"1px solid #e9ecef",fontWeight:"600",fontSize:"16px",color:"#495057"}),t.textContent=this.title,e.appendChild(t);const o=document.createElement("div");Object.assign(o.style,{padding:"20px",flex:"1",display:"flex",flexDirection:"column",minHeight:"0"}),o.appendChild(this.container),e.appendChild(o),this.modalOverlay.appendChild(e),document.body.appendChild(this.modalOverlay),this.modalOverlay.addEventListener("click",e=>{e.target===this.modalOverlay&&this.destroy()})}displayDialog(){console.log("LoadFlowDialog displayed with tabbed interface")}destroy(){this.modalOverlay&&this.modalOverlay.parentNode&&document.body.removeChild(this.modalOverlay),this.modalOverlay=null,this.container=null}createButton(e,t,o){const n=document.createElement("button");return n.textContent=e,Object.assign(n.style,{padding:"8px 16px",border:"none",borderRadius:"4px",fontSize:"14px",fontWeight:"500",cursor:"pointer",backgroundColor:t,color:"white",transition:"background-color 0.2s ease"}),n.addEventListener("mouseenter",()=>{n.style.backgroundColor=o}),n.addEventListener("mouseleave",()=>{n.style.backgroundColor=t}),n}async checkSubscriptionStatus(){console.log("LoadFlowDialog.checkSubscriptionStatus() called");try{console.log("LoadFlowDialog: Ensuring subscription functions are available...");const e=await t();if(console.log("LoadFlowDialog: Functions status:",e),window.checkSubscriptionStatus){console.log("LoadFlowDialog: Using window.checkSubscriptionStatus");const e=await window.checkSubscriptionStatus();return console.log("LoadFlowDialog: window.checkSubscriptionStatus result:",e),e}if(window.SubscriptionManager&&window.SubscriptionManager.checkSubscriptionStatus){console.log("LoadFlowDialog: Using SubscriptionManager.checkSubscriptionStatus");const e=await window.SubscriptionManager.checkSubscriptionStatus();return console.log("LoadFlowDialog: SubscriptionManager result:",e),e}return console.warn("LoadFlowDialog: No subscription check function available"),!1}catch(e){return console.error("LoadFlowDialog: Error in checkSubscriptionStatus:",e),!1}}}