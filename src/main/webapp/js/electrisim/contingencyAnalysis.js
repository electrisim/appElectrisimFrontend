import{ContingencyDialog as e}from"./dialogs/ContingencyDialog.js";const getConnectedBusId=(e,t=!1)=>{if(t)return{busFrom:e.source?.mxObjectId?.replace("#","_"),busTo:e.target?.mxObjectId?.replace("#","_")};const r=e.edges[0];if(!r)return null;if(!r.target&&!r.source)return null;const n=r.target&&r.target.mxObjectId!==e.mxObjectId?r.target?r.target.mxObjectId:null:r.source?r.source.mxObjectId:null;return n?n.replace("#","_"):null},parseCellStyle=e=>{if(!e)return null;const t=e.split(";").map(e=>e.split("="));return Object.fromEntries(t)},getAttributesAsObject=(e,t)=>{const r={};return e&&e.value&&e.value.attributes?(Object.entries(t).forEach(([t,n])=>{if(e.value.attributes[t])r[n]=e.value.attributes[t].value;else switch(console.warn(`Missing attribute: ${t} for component, using default`),n){case"type":r[n]="wye";break;case"scaling":case"sn_mva":r[n]="1.0";break;case"in_service":r[n]="true";break;case"const_z_percent":case"const_i_percent":case"q_mvar":case"p_mw":r[n]="0.0";break;default:r[n]=""}}),r):(console.warn("Cell is missing required properties"),r)},setCellStyle=(e,t)=>{if(!e)return;const r=e.getStyle()||"",n=Object.entries(t).map(([e,t])=>`${e}=${t}`).join(";");r?e.setStyle(r+";"+n):e.setStyle(n)},t={fontSize:"11",fontFamily:"Arial",align:"center",verticalAlign:"middle",fillColor:"#ffffff",strokeColor:"#000000",strokeWidth:"1",fontColor:"#000000"},r={strokeColor:"#000000",strokeWidth:"2",startArrow:"none",endArrow:"none"},n={bus:(e,t,r)=>{e&&Array.isArray(e)&&e.forEach(e=>{try{const t=e.bus_id||e.id,n=r.getModel().getCell(t);if(n){const t=e.vm_pu||e.voltage_pu||1,r=e.va_degree||e.angle_degree||0;let o="#00FF00";t<.95||t>1.05?o="#FF0000":(t<.97||t>1.03)&&(o="#FFA500"),setCellStyle(n,{fillColor:o,strokeColor:"#000000"});const s=`V: ${t.toFixed(3)} pu\nθ: ${r.toFixed(2)}°`;n.setAttribute("results",s)}}catch(e){console.error("Error processing bus data:",e)}})},line:(e,t,r)=>{e&&Array.isArray(e)&&e.forEach(e=>{try{const t=e.line_id||e.id,n=r.getModel().getCell(t);if(n){const t=e.loading_percent||0,r=e.p_from_mw||0,o=e.q_from_mvar||0;let s="#00FF00";t>100?s="#FF0000":t>90&&(s="#FFA500"),setCellStyle(n,{strokeColor:s,strokeWidth:t>100?"3":"2"});const a=`Loading: ${t.toFixed(1)}%\nP: ${r.toFixed(2)} MW\nQ: ${o.toFixed(2)} Mvar`;n.setAttribute("results",a)}}catch(e){console.error("Error processing line data:",e)}})},transformer:(e,t,r)=>{e&&Array.isArray(e)&&e.forEach(e=>{try{const t=e.trafo_id||e.id,n=r.getModel().getCell(t);if(n){const t=e.loading_percent||0,r=e.p_hv_mw||0,o=e.q_hv_mvar||0;let s="#00FF00";t>100?s="#FF0000":t>90&&(s="#FFA500"),setCellStyle(n,{fillColor:s,strokeColor:"#000000"});const a=`Loading: ${t.toFixed(1)}%\nP: ${r.toFixed(2)} MW\nQ: ${o.toFixed(2)} Mvar`;n.setAttribute("results",a)}}catch(e){console.error("Error processing transformer data:",e)}})},generator:(e,t,r)=>{e&&Array.isArray(e)&&e.forEach(e=>{try{const t=e.gen_id||e.id,n=r.getModel().getCell(t);if(n){const t=e.p_mw||0,r=e.q_mvar||0,o=!1!==e.in_service;setCellStyle(n,{fillColor:o?"#00FF00":"#FF0000",strokeColor:"#000000"});const s=`P: ${t.toFixed(2)} MW\nQ: ${r.toFixed(2)} Mvar\nStatus: ${o?"ON":"OFF"}`;n.setAttribute("results",s)}}catch(e){console.error("Error processing generator data:",e)}})},load:(e,t,r)=>{e&&Array.isArray(e)&&e.forEach(e=>{try{const t=e.load_id||e.id,n=r.getModel().getCell(t);if(n){const t=e.p_mw||0,r=e.q_mvar||0,o=!1!==e.in_service;setCellStyle(n,{fillColor:o?"#00FF00":"#FF0000",strokeColor:"#000000"});const s=`P: ${t.toFixed(2)} MW\nQ: ${r.toFixed(2)} Mvar\nStatus: ${o?"ON":"OFF"}`;n.setAttribute("results",s)}}catch(e){console.error("Error processing load data:",e)}})}};function contingencyAnalysisPandaPower(o,s,a){const i={simulationParameters:[],externalGrid:[],generator:[],staticGenerator:[],asymmetricGenerator:[],busbar:[],transformer:[],threeWindingTransformer:[],shuntReactor:[],capacitor:[],load:[],asymmetricLoad:[],impedance:[],ward:[],extendedWard:[],motor:[],storage:[],SVC:[],TCSC:[],SSC:[],dcLine:[],line:[]};let l=o,c=s;s.isEnabled()&&!s.isCellLocked(s.getDefaultParent())&&new e(o).show(function(e){if(l.spinner.spin(document.body,"Running Contingency Analysis..."),o.length>0){function getUserEmail(){try{const e=localStorage.getItem("user");if(e){const t=JSON.parse(e);if(t&&t.email)return t.email}if("function"==typeof getCurrentUser){const e=getCurrentUser();if(e&&e.email)return e.email}if(window.getCurrentUser&&"function"==typeof window.getCurrentUser){const e=window.getCurrentUser();if(e&&e.email)return e.email}if(window.authHandler&&window.authHandler.getCurrentUser){const e=window.authHandler.getCurrentUser();if(e&&e.email)return e.email}return"unknown@user.com"}catch(e){return console.warn("Error getting user email:",e),"unknown@user.com"}}const b=getUserEmail();console.log("Contingency Analysis - User email:",b),i.simulationParameters.push({typ:"ContingencyAnalysisPandaPower Parameters",contingency_type:o[0],element_type:o[1],elements_to_analyze:o[2],voltage_limits:o[3],thermal_limits:o[4],min_vm_pu:o[5],max_vm_pu:o[6],max_loading_percent:o[7],post_contingency_actions:o[8],analysis_mode:o[9],user_email:b})}const a=s.getModel(),d=s.getDefaultParent(),u=a.getChildren(d);console.log("Total cells found:",u.length),console.log("Graph model:",a),console.log("Parent:",d);const m={};u.forEach(e=>{const t=parseCellStyle(e.getStyle()),r=t?.shapeELXXX||"NO_TYPE";m[r]=(m[r]||0)+1}),console.log("Cell types found:",m),console.log("First 5 cells details:"),u.slice(0,5).forEach((e,t)=>{const r=parseCellStyle(e.getStyle());console.log(`Cell ${t}:`,{id:e.id,mxObjectId:e.mxObjectId,componentType:r?.shapeELXXX,style:e.style,edges:e.edges?.length||0})});const _=new Set;u.forEach(e=>{if(e.getStyle()?.includes("Result"))return void a.remove(a.getCell(e.id));const t=parseCellStyle(e.getStyle());if(!t)return;const r=t.shapeELXXX;if(console.log("Processing cell:",r,"ID:",e.id,"mxObjectId:",e.mxObjectId),r&&"NotEditableLine"!==r)try{let t;if("Line"===r||"DCLine"===r){const r=getConnectedBusId(e,!0);t={name:e.mxObjectId?.replace("#","_")||e.id,id:e.id,busFrom:r?.busFrom,busTo:r?.busTo},r?.busFrom&&!_.has(r.busFrom)&&(_.add(r.busFrom),i.busbar.push({typ:"Bus",name:r.busFrom,id:r.busFrom,vn_kv:"230"}),console.log("Added unique bus for line:",r.busFrom)),r?.busTo&&!_.has(r.busTo)&&(_.add(r.busTo),i.busbar.push({typ:"Bus",name:r.busTo,id:r.busTo,vn_kv:"230"}),console.log("Added unique bus for line:",r.busTo))}else{const r=getConnectedBusId(e);t={name:e.mxObjectId?.replace("#","_")||e.id,id:e.id,bus:r},r&&!_.has(r)&&(_.add(r),i.busbar.push({typ:"Bus",name:r,id:r,vn_kv:e.value?.attributes?.[2]?.nodeValue||"230"}),console.log("Added unique bus for component:",r))}switch(r){case"Bus":case"Bus Bar":console.log("Skipping explicit Bus component - handled automatically");break;case"External Grid":if(console.log("Processing External Grid:",t),console.log("External Grid cell attributes:",e.value?.attributes),t.bus){const r=getAttributesAsObject(e,{vm_pu:"vm_pu",va_degree:"va_degree",s_sc_max_mva:"s_sc_max_mva",s_sc_min_mva:"s_sc_min_mva",rx_max:"rx_max",rx_min:"rx_min",r0x0_max:"r0x0_max",x0x_max:"x0x_max"});i.externalGrid.push({typ:"ExternalGrid",name:t.name,id:t.id,bus:t.bus,...r}),console.log("Added external grid:",t.name,"attributes:",r)}break;case"Generator":case"Synchronous Generator":if(console.log("Processing Generator:",t),console.log("Generator cell attributes:",e.value?.attributes),t.bus){const r=getAttributesAsObject(e,{p_mw:"p_mw",vm_pu:"vm_pu",sn_mva:"sn_mva",scaling:"scaling",vn_kv:"vn_kv",xdss_pu:"xdss_pu",rdss_ohm:"rdss_ohm",cos_phi:"cos_phi",pg_percent:"pg_percent",power_station_trafo:"power_station_trafo"});i.generator.push({typ:"Generator",name:t.name,id:t.id,bus:t.bus,...r}),console.log("Added generator:",t.name,"attributes:",r)}break;case"Load":case"Static Load":if(console.log("Processing Load:",t),console.log("Load cell attributes:",e.value?.attributes),t.bus){const r=getAttributesAsObject(e,{p_mw:"p_mw",q_mvar:"q_mvar",const_z_percent:"const_z_percent",const_i_percent:"const_i_percent",sn_mva:"sn_mva",scaling:"scaling",type:"type",in_service:"in_service"});i.load.push({typ:"Load",name:t.name,id:t.id,bus:t.bus,...r}),console.log("Added load:",t.name,"attributes:",r)}break;case"Line":case"Transmission Line":if(console.log("Processing Line:",t),console.log("Line cell attributes:",e.value?.attributes),t.busFrom&&t.busTo){const r=getAttributesAsObject(e,{std_type:"std_type",length_km:"length_km",r_ohm_per_km:"r_ohm_per_km",x_ohm_per_km:"x_ohm_per_km",c_nf_per_km:"c_nf_per_km",g_us_per_km:"g_us_per_km",max_i_ka:"max_i_ka",df:"df",parallel:"parallel",type:"type",in_service:"in_service"});i.line.push({typ:"Line",name:t.name,id:t.id,busFrom:t.busFrom,busTo:t.busTo,...r}),console.log("Added line:",t.name,"attributes:",r)}break;case"Transformer":case"Two Winding Transformer":if(console.log("Processing Transformer:",t),console.log("Transformer cell attributes:",e.value?.attributes),t.busFrom&&t.busTo){const r=getAttributesAsObject(e,{std_type:"std_type",sn_mva:"sn_mva",vn_hv_kv:"vn_hv_kv",vn_lv_kv:"vn_lv_kv",vk_percent:"vk_percent",vkr_percent:"vkr_percent",pfe_kw:"pfe_kw",i0_percent:"i0_percent",shift_degree:"shift_degree",tap_side:"tap_side",tap_neutral:"tap_neutral",tap_min:"tap_min",tap_max:"tap_max",tap_step_percent:"tap_step_percent",tap_step_degree:"tap_step_degree",tap_pos:"tap_pos",tap_phase_shifter:"tap_phase_shifter",parallel:"parallel",df:"df",in_service:"in_service"});i.transformer.push({typ:"Transformer",name:t.name,id:t.id,hv_bus:t.busFrom,lv_bus:t.busTo,...r}),console.log("Added transformer:",t.name,"attributes:",r)}break;default:console.log("Unknown cell type:",r,"Style:",e.style)}}catch(e){console.error("Error processing cell:",r,e)}else console.log("Skipping component type:",r)}),console.log("Component arrays summary:"),console.log("Buses:",i.busbar.length),console.log("External grids:",i.externalGrid.length),console.log("Generators:",i.generator.length),console.log("Loads:",i.load.length),console.log("Lines:",i.line.length),console.log("Transformers:",i.transformer.length);const g=[...i.simulationParameters,...i.externalGrid,...i.generator,...i.staticGenerator,...i.asymmetricGenerator,...i.busbar,...i.transformer,...i.threeWindingTransformer,...i.shuntReactor,...i.capacitor,...i.load,...i.asymmetricLoad,...i.impedance,...i.ward,...i.extendedWard,...i.motor,...i.storage,...i.SSC,...i.SVC,...i.TCSC,...i.dcLine,...i.line],p=Object.assign({},g);console.log("Contingency Analysis data being sent to backend:"),console.log(JSON.stringify(p,null,2)),async function processNetworkData(e,o,s,a){try{s.getStylesheet().putCellStyle("labelstyle",t),s.getStylesheet().putCellStyle("lineStyle",r);const i=await fetch(e,{mode:"cors",method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(200!==i.status)throw new Error("server");const l=await i.json();if(console.log("Contingency Analysis dataJson"),console.log(l),(e=>e.error?(console.error("Network error:",e.error),alert("Network error: "+e.error),!0):!!(e.errors&&e.errors.length>0)&&(console.error("Multiple network errors:",e.errors),alert("Network errors: "+e.errors.join(", ")),!0))(l))return;Object.entries(n).forEach(([e,t])=>{l[e]&&t(l[e],s,a)}),l.summary&&function displayContingencySummary(e){try{let t="Contingency Analysis Results:\n\n";e.contingencies_analyzed&&(t+=`Total Contingencies Analyzed: ${e.contingencies_analyzed}\n`),e.violations&&(t+=`Violations Found: ${e.violations.length}\n`,e.violations.length>0&&(t+="\nViolations:\n",e.violations.forEach((e,r)=>{t+=`${r+1}. ${e.type}: ${e.element} - ${e.description}\n`}))),e.critical_contingencies&&(t+=`\nCritical Contingencies: ${e.critical_contingencies.length}\n`,e.critical_contingencies.length>0&&(t+="\nCritical Cases:\n",e.critical_contingencies.forEach((e,r)=>{t+=`${r+1}. ${e.name}: ${e.description}\n`}))),console.log(t)}catch(e){console.error("Error displaying contingency summary:",e)}}(l.summary)}catch(e){if("server"===e.message)return;console.error("Error processing contingency analysis data:",e)}finally{void 0!==l&&l.spinner&&l.spinner.stop()}}("https://03dht3kc-5000.euw.devtunnels.ms/",p,s,c)})}globalThis.contingencyAnalysisPandaPower=contingencyAnalysisPandaPower;export{contingencyAnalysisPandaPower};