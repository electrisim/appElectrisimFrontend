import{Dialog as e}from"./Dialog.js";import{rowDefsTransformerLibrary as t,gridOptionsTransformerLibrary as a,columnDefsTransformerLibrary as r}from"./transformerLibraryDialog.js";import{LibraryDialogManager as i}from"./LibraryDialogManager.js";export const defaultTransformerData={name:"Transformer",sn_mva:0,vn_hv_kv:0,vn_lv_kv:0,vk_percent:0,vkr_percent:0,pfe_kw:0,i0_percent:0,shift_degree:0,tap_side:"hv",tap_neutral:0,tap_min:-10,tap_max:10,tap_step_percent:1,tap_step_degree:0,tap_pos:0,tap_phase_shifter:!1,in_service:!0,vector_group:"Dyn",vk0_percent:0,vkr0_percent:0,mag0_percent:0,mag0_rx:0,si0_hv_partial:0,parallel:1};export class TransformerDialog extends e{constructor(e){super("Transformer Parameters","Apply"),this.ui=e||window.App?.main?.editor?.editorUi,this.graph=this.ui?.editor?.graph,this.currentTab="loadflow",this.data={...defaultTransformerData},this.inputs=new Map,this.loadFlowParameters=[{id:"name",label:"Name",symbol:"name",description:"Name identifier for the transformer",type:"text",value:this.data.name},{id:"sn_mva",label:"Rated Apparent Power",symbol:"sn_mva",unit:"MVA",description:"Rated apparent power (>0)",type:"number",value:this.data.sn_mva.toString(),step:"0.1",min:"0"},{id:"vn_hv_kv",label:"HV Rated Voltage",symbol:"vn_hv_kv",unit:"kV",description:"Rated voltage on high voltage side (>0)",type:"number",value:this.data.vn_hv_kv.toString(),step:"0.1",min:"0"},{id:"vn_lv_kv",label:"LV Rated Voltage",symbol:"vn_lv_kv",unit:"kV",description:"Rated voltage on low voltage side (>0)",type:"number",value:this.data.vn_lv_kv.toString(),step:"0.1",min:"0"},{id:"in_service",label:"In Service",symbol:"in_service",description:"Specifies if the transformer is in service (True/False)",type:"checkbox",value:this.data.in_service},{id:"vector_group",label:"Vector Group",symbol:"vector_group",description:"Vector group of the transformer (e.g., Dyn, Yd, Yy)",type:"select",value:this.data.vector_group,options:["Dyn","Yd","Yy","Dd","Yz","Dz","YNd"]},{id:"shift_degree",label:"Angle Shift",symbol:"shift_degree",unit:"degrees",description:"Angle shift in degrees",type:"number",value:this.data.shift_degree.toString(),step:"0.1"},{id:"parallel",label:"Parallel Transformers",symbol:"parallel",description:"Number of parallel transformer systems (optional, default: 1)",type:"number",value:this.data.parallel.toString(),step:"1",min:"1"},{id:"tap_side",label:"Tap Side",symbol:"tap_side",description:"Where the tap changer is located (hv for high voltage or lv for low voltage)",type:"select",value:this.data.tap_side,options:["hv","lv"]},{id:"tap_neutral",label:"Tap Neutral Position",symbol:"tap_neutral",description:"Tap position where no voltage shift is present",type:"number",value:this.data.tap_neutral.toString(),step:"1"},{id:"tap_min",label:"Minimum Tap Position",symbol:"tap_min",description:"Minimum tap position",type:"number",value:this.data.tap_min.toString(),step:"1"},{id:"tap_max",label:"Maximum Tap Position",symbol:"tap_max",description:"Maximum tap position",type:"number",value:this.data.tap_max.toString(),step:"1"},{id:"tap_step_percent",label:"Tap Step Size",symbol:"tap_step_percent",unit:"%",description:"Tap step size in percent (>0)",type:"number",value:this.data.tap_step_percent.toString(),step:"0.1",min:"0"},{id:"tap_step_degree",label:"Tap Step Angle",symbol:"tap_step_degree",unit:"degrees",description:"Tap step size for voltage angle in degree, only considered in load flow if calculate_voltage_angles = True",type:"number",value:this.data.tap_step_degree.toString(),step:"0.1"},{id:"tap_pos",label:"Current Tap Position",symbol:"tap_pos",description:"Current tap position of the transformer. Defaults to tap_neutral if not set",type:"number",value:this.data.tap_pos.toString(),step:"1"},{id:"tap_phase_shifter",label:"Phase Shifter",symbol:"tap_phase_shifter",description:"Whether the transformer is an ideal phase shifter (True/False)",type:"checkbox",value:this.data.tap_phase_shifter}],this.shortCircuitParameters=[{id:"vk_percent",label:"Short Circuit Voltage",symbol:"vk_percent",unit:"%",description:"Short circuit voltage in percent (>0)",type:"number",value:this.data.vk_percent.toString(),step:"0.1",min:"0"},{id:"vkr_percent",label:"Real Part of SC Voltage",symbol:"vkr_percent",unit:"%",description:"Real part of short circuit voltage in percent (>=0)",type:"number",value:this.data.vkr_percent.toString(),step:"0.1",min:"0"},{id:"pfe_kw",label:"Iron Losses",symbol:"pfe_kw",unit:"kW",description:"Iron losses in kW (>=0)",type:"number",value:this.data.pfe_kw.toString(),step:"0.1",min:"0"},{id:"i0_percent",label:"Open Loop Losses",symbol:"i0_percent",unit:"%",description:"Open loop losses in percent (>=0)",type:"number",value:this.data.i0_percent.toString(),step:"0.1",min:"0"},{id:"vk0_percent",label:"Zero Sequence SC Voltage",symbol:"vk0_percent",unit:"%",description:"Zero sequence short circuit voltage in percent (>=0). If not specified, defaults to vk_percent",type:"number",value:this.data.vk0_percent.toString(),step:"0.1",min:"0"},{id:"vkr0_percent",label:"Zero Sequence SC Voltage Real Part",symbol:"vkr0_percent",unit:"%",description:"Zero sequence real part of short circuit voltage in percent (>=0). If not specified, defaults to vkr_percent",type:"number",value:this.data.vkr0_percent.toString(),step:"0.1",min:"0"},{id:"mag0_percent",label:"Zero Sequence Magnetizing Current",symbol:"mag0_percent",unit:"%",description:"Zero sequence magnetizing current in percent (>=0)",type:"number",value:this.data.mag0_percent.toString(),step:"0.1",min:"0"},{id:"mag0_rx",label:"Zero Sequence Magnetizing R/X Ratio",symbol:"mag0_rx",unit:"",description:"Zero sequence magnetizing r/x ratio (>=0)",type:"number",value:this.data.mag0_rx.toString(),step:"0.1",min:"0"},{id:"si0_hv_partial",label:"Zero Sequence Partial Current",symbol:"si0_hv_partial",unit:"%",description:"Zero sequence partial current on HV side in percent (>=0)",type:"number",value:this.data.si0_hv_partial.toString(),step:"0.1",min:"0"}]}getDescription(){return'<strong>Configure Transformer Parameters</strong><br>Set parameters for two-winding transformer. See the <a href="https://electrisim.com/documentation#transformer" target="_blank">Electrisim documentation</a>.'}show(e){this.callback=e,this.showTabDialog()}showTabDialog(){this.ui=this.ui||window.App?.main?.editor?.editorUi;const e=document.createElement("div");Object.assign(e.style,{fontFamily:"Arial, sans-serif",fontSize:"14px",lineHeight:"1.5",color:"#333",padding:"0",margin:"0",width:"100%",height:"100%",boxSizing:"border-box",display:"flex",flexDirection:"column"});const t=document.createElement("div");Object.assign(t.style,{padding:"6px 10px",backgroundColor:"#e3f2fd",border:"1px solid #bbdefb",borderRadius:"4px",fontSize:"12px",color:"#1565c0",marginBottom:"12px"}),t.innerHTML=this.getDescription(),e.appendChild(t);const a=document.createElement("div");Object.assign(a.style,{display:"flex",borderBottom:"2px solid #e9ecef",marginBottom:"16px"});const r=this.createTab("Load Flow","loadflow","loadflow"===this.currentTab),i=this.createTab("Short Circuit","shortcircuit","shortcircuit"===this.currentTab);a.appendChild(r),a.appendChild(i),e.appendChild(a);const o=document.createElement("div");Object.assign(o.style,{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:"0",scrollbarWidth:"thin",scrollbarColor:"#c1c1c1 #f1f1f1",paddingRight:"8px"});const n=this.createTabContent("loadflow",this.loadFlowParameters),s=this.createTabContent("shortcircuit",this.shortCircuitParameters);o.appendChild(n),o.appendChild(s),e.appendChild(o);const l=document.createElement("div");Object.assign(l.style,{display:"flex",gap:"8px",justifyContent:"space-between",marginTop:"16px",paddingTop:"16px",borderTop:"1px solid #e9ecef"});const p=document.createElement("div");Object.assign(p.style,{display:"flex",gap:"8px"});const d=this.createButton("Library","#28a745","#218838");d.onclick=e=>{e.preventDefault(),this.showLibrary()},p.appendChild(d);const c=document.createElement("div");Object.assign(c.style,{display:"flex",gap:"8px"});const u=this.createButton("Cancel","#6c757d","#5a6268"),h=this.createButton("Apply","#007bff","#0056b3");if(u.onclick=e=>{e.preventDefault(),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},h.onclick=e=>{e.preventDefault();const t=this.getFormValues();console.log("Transformer values:",t),this.callback&&this.callback(t),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},c.appendChild(u),c.appendChild(h),l.appendChild(p),l.appendChild(c),e.appendChild(l),this.container=e,r.onclick=()=>this.switchTab("loadflow",r,[i],n,[s]),i.onclick=()=>this.switchTab("shortcircuit",i,[r],s,[n]),this.ui&&"function"==typeof this.ui.showDialog){const t=window.innerHeight-80;this.ui.showDialog(e,1e3,t,!0,!1)}else this.showModalFallback(e)}createTab(e,t,a){const r=document.createElement("div");return Object.assign(r.style,{padding:"12px 20px",cursor:"pointer",borderBottom:a?"2px solid #007bff":"2px solid transparent",backgroundColor:a?"#f8f9fa":"transparent",color:a?"#007bff":"#333",fontWeight:a?"600":"400",transition:"all 0.2s ease"}),r.textContent=e,r.setAttribute("data-tab",t),r.addEventListener("mouseenter",()=>{a||(r.style.backgroundColor="#f8f9fa",r.style.color="#007bff")}),r.addEventListener("mouseleave",()=>{a||(r.style.backgroundColor="transparent",r.style.color="#333")}),r}createTabContent(e,t){const a=document.createElement("div");a.dataset.tab=e,Object.assign(a.style,{display:e===this.currentTab?"block":"none"});const r=document.createElement("form");return Object.assign(r.style,{display:"flex",flexDirection:"column",gap:"16px"}),t.forEach(e=>{const t=document.createElement("div");Object.assign(t.style,{display:"grid",gridTemplateColumns:"1fr 200px",gap:"20px",alignItems:"start",padding:"16px",backgroundColor:"#f8f9fa",border:"1px solid #e9ecef",borderRadius:"8px",minHeight:"80px"});const a=document.createElement("div");Object.assign(a.style,{display:"flex",flexDirection:"column",justifyContent:"center",minHeight:"60px"});const i=document.createElement("label");Object.assign(i.style,{fontWeight:"600",fontSize:"14px",color:"#495057",marginBottom:"6px",lineHeight:"1.2"});let o=e.label;e.symbol&&(o+=` (${e.symbol})`),e.unit&&(o+=` [${e.unit}]`),i.textContent=o,i.htmlFor=e.id;const n=document.createElement("div");Object.assign(n.style,{fontSize:"12px",color:"#6c757d",lineHeight:"1.4",fontStyle:"italic",marginBottom:"4px"}),n.textContent=e.description,a.appendChild(i),a.appendChild(n);const s=document.createElement("div");let l;Object.assign(s.style,{display:"flex",alignItems:"center",justifyContent:"flex-end",minHeight:"60px",width:"200px"}),"checkbox"===e.type?(l=document.createElement("input"),l.type="checkbox",l.checked=e.value,Object.assign(l.style,{width:"24px",height:"24px",accentColor:"#007bff",cursor:"pointer",margin:"0"})):"select"===e.type?(l=document.createElement("select"),e.options.forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=t,t===e.value&&(a.selected=!0),l.appendChild(a)}),Object.assign(l.style,{width:"180px",padding:"10px 14px",border:"2px solid #ced4da",borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",backgroundColor:"#ffffff",boxSizing:"border-box",transition:"all 0.2s ease",outline:"none"}),l.addEventListener("focus",()=>{l.style.borderColor="#007bff",l.style.boxShadow="0 0 0 3px rgba(0, 123, 255, 0.15)",l.style.transform="translateY(-1px)"}),l.addEventListener("blur",()=>{l.style.borderColor="#ced4da",l.style.boxShadow="none",l.style.transform="translateY(0)"}),l.addEventListener("mouseenter",()=>{l!==document.activeElement&&(l.style.borderColor="#adb5bd",l.style.backgroundColor="#f8f9fa")}),l.addEventListener("mouseleave",()=>{l!==document.activeElement&&(l.style.borderColor="#ced4da",l.style.backgroundColor="#ffffff")})):(l=document.createElement("input"),l.type=e.type,l.value=e.value,e.step&&(l.step=e.step),void 0!==e.min&&(l.min=e.min),void 0!==e.max&&(l.max=e.max),Object.assign(l.style,{width:"180px",padding:"10px 14px",border:"2px solid #ced4da",borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",backgroundColor:"#ffffff",boxSizing:"border-box",transition:"all 0.2s ease",outline:"none"}),l.addEventListener("focus",()=>{l.style.borderColor="#007bff",l.style.boxShadow="0 0 0 3px rgba(0, 123, 255, 0.15)",l.style.transform="translateY(-1px)"}),l.addEventListener("blur",()=>{l.style.borderColor="#ced4da",l.style.boxShadow="none",l.style.transform="translateY(0)"}),l.addEventListener("mouseenter",()=>{l!==document.activeElement&&(l.style.borderColor="#adb5bd",l.style.backgroundColor="#f8f9fa")}),l.addEventListener("mouseleave",()=>{l!==document.activeElement&&(l.style.borderColor="#ced4da",l.style.backgroundColor="#ffffff")})),l.id=e.id,this.inputs.set(e.id,l),s.appendChild(l),t.appendChild(a),t.appendChild(s),r.appendChild(t)}),a.appendChild(r),a}switchTab(e,t,a,r,i){this.currentTab=e,t.style.borderBottom="2px solid #007bff",t.style.backgroundColor="#f8f9fa",t.style.color="#007bff",t.style.fontWeight="600",t.classList.add("active"),a.forEach(e=>{e.style.borderBottom="2px solid transparent",e.style.backgroundColor="transparent",e.style.color="#333",e.style.fontWeight="400",Object.assign(e.style,{color:"#6c757d",fontWeight:"400"}),e.classList.remove("active")}),r.style.display="block",i.forEach(e=>{e.style.display="none"})}getFormValues(){const e={};return[...this.loadFlowParameters,...this.shortCircuitParameters].forEach(t=>{const a=this.inputs.get(t.id);a&&("number"===t.type?e[t.id]=parseFloat(a.value)||0:"checkbox"===t.type?e[t.id]=a.checked:e[t.id]=a.value)}),e}createButton(e,t,a){const r=document.createElement("button");return r.textContent=e,Object.assign(r.style,{padding:"8px 16px",backgroundColor:t,color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500",transition:"background-color 0.2s"}),r.addEventListener("mouseenter",()=>{r.style.backgroundColor=a}),r.addEventListener("mouseleave",()=>{r.style.backgroundColor=t}),r}destroy(){super.destroy(),window._globalDialogShowing&&delete window._globalDialogShowing}showLibrary(){const e=(new i).createLibraryDialog("Transformer Library",t,r,a,e=>{this.loadTransformerData(e),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},()=>{this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()});if(this.ui&&"function"==typeof this.ui.showDialog){const t=window.innerHeight-80;this.ui.showDialog(e,1800,t,!0,!1)}}loadTransformerData(e){const t={name:e.name||"Transformer",sn_mva:e.sn_mva||0,vn_hv_kv:e.vn_hv_kv||0,vn_lv_kv:e.vn_lv_kv||0,vk_percent:e.vk_percent||0,vkr_percent:e.vkr_percent||0,pfe_kw:e.pfe_kw||0,i0_percent:e.i0_percent||0,shift_degree:e.shift_degree||0,tap_side:e.tap_side||"hv",tap_neutral:e.tap_neutral||0,tap_min:e.tap_min||-10,tap_max:e.tap_max||10,tap_step_percent:e.tap_step_percent||1,tap_step_degree:e.tap_step_degree||0,tap_pos:e.tap_pos||0,tap_phase_shifter:"True"===e.tap_phase_shifter||!0===e.tap_phase_shifter,in_service:!0};Object.keys(t).forEach(e=>{if(this.inputs.has(e)){const a=this.inputs.get(e),r=t[e];"checkbox"===a.type?a.checked=Boolean(r):"SELECT"===a.tagName?a.value=r:a.value=r.toString()}}),console.log("Loaded transformer data:",t)}populateDialog(e){if(e&&e.attributes)for(let t=0;t<e.attributes.length;t++){const a=e.attributes[t],r=a.name,i=a.value,o=this.loadFlowParameters.find(e=>e.id===r);o&&("checkbox"===o.type?o.value="true"===i||!0===i:o.value=i);const n=this.shortCircuitParameters.find(e=>e.id===r);n&&("checkbox"===n.type?n.value="true"===i||!0===i:n.value=i)}}}export const rowDefsTransformerBase=[{name:"Transformer",sn_mva:0,vn_hv_kv:0,vn_lv_kv:0,vk_percent:0,vkr_percent:0,pfe_kw:0,i0_percent:0,shift_degree:0,tap_side:"hv",tap_neutral:0,tap_min:-10,tap_max:10,tap_step_percent:1,tap_step_degree:0,tap_pos:0,tap_phase_shifter:!1}];export const columnDefsTransformerBase=[{field:"name",minWidth:300},{field:"sn_mva",headerTooltip:"rated apparent power in MVA",maxWidth:140,valueParser:e=>parseFloat(e.newValue)||0},{field:"vn_hv_kv",headerTooltip:"rated voltage on high voltage side in kV",maxWidth:140,valueParser:e=>parseFloat(e.newValue)||0},{field:"vn_lv_kv",headerTooltip:"rated voltage on low voltage side in kV",maxWidth:140,valueParser:e=>parseFloat(e.newValue)||0},{field:"vk_percent",headerTooltip:"short circuit voltage in percent",maxWidth:140,valueParser:e=>parseFloat(e.newValue)||0},{field:"vkr_percent",headerTooltip:"real part of short circuit voltage in percent",maxWidth:140,valueParser:e=>parseFloat(e.newValue)||0},{field:"pfe_kw",headerTooltip:"iron losses in kW",maxWidth:140,valueParser:e=>parseFloat(e.newValue)||0},{field:"i0_percent",headerTooltip:"open loop losses in percent",maxWidth:140,valueParser:e=>parseFloat(e.newValue)||0},{field:"shift_degree",headerTooltip:"angle shift in degrees",maxWidth:140,valueParser:e=>parseFloat(e.newValue)||0},{field:"tap_side",headerTooltip:'where the tap changer is located ("hv" for high voltage or "lv" for low voltage)',maxWidth:100},{field:"tap_neutral",headerTooltip:"tap position where no voltage shift is present",maxWidth:150,valueParser:e=>parseFloat(e.newValue)||0},{field:"tap_min",headerTooltip:"minimum tap position",maxWidth:150,valueParser:e=>parseFloat(e.newValue)||0},{field:"tap_max",headerTooltip:"maximum tap position",maxWidth:150,valueParser:e=>parseFloat(e.newValue)||0},{field:"tap_step_percent",headerTooltip:"tap step size in percent",maxWidth:150,valueParser:e=>parseFloat(e.newValue)||0},{field:"tap_step_degree",headerTooltip:"tap step size for voltage angle in degree, only considered in load flow if calculate_voltage_angles = True",maxWidth:150,valueParser:e=>parseFloat(e.newValue)||0},{field:"tap_pos",headerTooltip:"current tap position of the transformer. Defaults to tap_neutral if not set",maxWidth:150,valueParser:e=>parseFloat(e.newValue)||0},{field:"tap_phase_shifter",headerTooltip:"whether the transformer is an ideal phase shifter",maxWidth:150}];export const gridOptionsTransformerBase={columnDefs:columnDefsTransformerBase,defaultColDef:{editable:!0},rowData:rowDefsTransformerBase,singleClickEdit:!0,stopEditingWhenGridLosesFocus:!0};globalThis.rowDefsTransformerBase=rowDefsTransformerBase,globalThis.columnDefsTransformerBase=columnDefsTransformerBase,globalThis.gridOptionsTransformerBase=gridOptionsTransformerBase,globalThis.numberParser=function numberParser(e){return Number(e.newValue)>=0?Number(e.newValue):(alert("The value "+e+" must be number (dot separated) and >= 0"),Number(e.oldValue))},globalThis.negativeNumberParser=function negativeNumberParser(e){return Number(e.newValue)<=0?Number(e.newValue):(alert("The value "+e+" must be number (dot separated) and <= 0"),Number(e.oldValue))},globalThis.TransformerDialog=TransformerDialog;