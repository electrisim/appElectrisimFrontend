import{DIALOG_STYLES as e}from"./utils/dialogStyles.js";import{LoadFlowDialog as n}from"./dialogs/LoadFlowDialog.js";const formatBusId=e=>e?e.replace("#","_"):null,createOpenDSSTableRow=(e,n)=>e.map((e,o)=>String(e).padEnd(n[o]," ")).join(" | "),createOpenDSSTableSeparator=e=>e.map(e=>"-".repeat(e)).join("-+-"),getConnectedBusId=(e,n=!1)=>{if(n)return{busFrom:formatBusId(e.source?.mxObjectId),busTo:formatBusId(e.target?.mxObjectId)};const o=e.edges?e.edges[0]:null;if(!o)return null;if(!o.target&&!o.source)return null;const r=o.target&&o.target.mxObjectId!==e.mxObjectId?o.target.mxObjectId:o.source.mxObjectId;return formatBusId(r)},getTransformerConnections=(e,n)=>{const getBusVoltageLevel=(e,n)=>{if(!e||!n)return 0;const o=n.getModel().cells;for(const n in o){const r=o[n];if(r&&r.mxObjectId===e.replace("_","#")){const e=r.getStyle?r.getStyle():"";if(e&&e.includes("shapeELXXX=Bus")&&r.value&&r.value.attributes)for(let e=0;e<r.value.attributes.length;e++){const n=r.value.attributes[e];if("vn_kv"===n.nodeName)return parseFloat(n.nodeValue)||0}}}return 0};if(e.edges&&e.edges.length>=2){const o=e.edges[0],r=e.edges[1],s=formatBusId(o.target&&o.target.mxObjectId!==e.mxObjectId?o.target.mxObjectId:o.source.mxObjectId),t=formatBusId(r.target&&r.target.mxObjectId!==e.mxObjectId?r.target.mxObjectId:r.source.mxObjectId);return getBusVoltageLevel(s,n)>=getBusVoltageLevel(t,n)?{busFrom:s,busTo:t}:{busFrom:t,busTo:s}}if(e.edges&&1===e.edges.length){const o=e.edges[0];if(o.source&&o.target){const e=formatBusId(o.source.mxObjectId),r=formatBusId(o.target.mxObjectId);return getBusVoltageLevel(e,n)>=getBusVoltageLevel(r,n)?{busFrom:e,busTo:r}:{busFrom:r,busTo:e}}}return{busFrom:null,busTo:null}},parseCellStyle=e=>{if(!e)return null;const n=e.split(";").map(e=>e.split("="));return Object.fromEntries(n)},getAttributesAsObject=(e,n)=>{const o={};if(!e||!e.value||!e.value.attributes)return console.warn("Cell is missing required properties"),o;const r=e.value.attributes;for(const[e,s]of Object.entries(n)){const n="object"==typeof s&&s.optional,t="object"==typeof s?s.name:s;let a=!1;for(let n=0;n<r.length;n++)if(r[n].nodeName===t){o[e]=r[n].nodeValue,a=!0;break}a||n||(console.warn(`Missing required attribute ${e} with name ${t}`),o[e]=null)}return o};function loadFlowOpenDss(e,n,o){let r=e,s=n;if(window.LoadFlowDialog&&window.LoadFlowDialog.prototype&&window.LoadFlowDialog.prototype.createTabHeader&&"function"==typeof e.showLoadFlowDialog)console.log("âœ“ Using new tabbed dialog"),n.isEnabled()&&!n.isCellLocked(n.getDefaultParent())&&e.showLoadFlowDialog("","Calculate",function(e){console.log("New tabbed LoadFlowDialog callback received:",e),"opendss"===e.engine?executeOpenDSSLoadFlow(e,r,s):(console.log("Processing Pandapower calculation with values:",e),console.log("exportPython value received:",e.exportPython),console.log("Passing values object directly to executePandapowerLoadFlow"),executePandapowerLoadFlow(e,r,s))});else if(console.log("âœ— Falling back to direct dialog creation"),window.LoadFlowDialog){console.log("Creating LoadFlowDialog directly...");try{new window.LoadFlowDialog(e).show(function(e){console.log("Direct LoadFlowDialog callback received:",e),"opendss"===e.engine?executeOpenDSSLoadFlow(e,r,s):(console.log("Processing Pandapower calculation with values:",e),console.log("exportPython value received:",e.exportPython),console.log("Passing values object directly to executePandapowerLoadFlow"),executePandapowerLoadFlow(e,r,s))})}catch(o){console.error("Error creating LoadFlowDialog directly:",o),"function"==typeof e.showLoadFlowDialogOpenDSS?(console.log("Final fallback to OpenDSS dialog"),n.isEnabled()&&!n.isCellLocked(n.getDefaultParent())&&e.showLoadFlowDialogOpenDSS("","Calculate",function(e,n){console.log("Legacy OpenDSS dialog callback received"),executeOpenDSSLoadFlow(e,r,s)})):alert("Load Flow dialog is not available. Please refresh the page and try again.")}}else console.log("LoadFlowDialog not available, checking for OpenDSS dialog..."),"function"==typeof e.showLoadFlowDialogOpenDSS?(console.log("Using OpenDSS dialog as fallback"),n.isEnabled()&&!n.isCellLocked(n.getDefaultParent())&&e.showLoadFlowDialogOpenDSS("","Calculate",function(e,n){console.log("Legacy OpenDSS dialog callback received"),executeOpenDSSLoadFlow(e,r,s)})):(console.error("No dialog available"),alert("Load Flow dialog is not available. Please refresh the page and try again."))}const o={busbars:(e,n,o,r)=>{Array.isArray(e)?e.forEach(e=>{try{const t=r?r.get(e.id):null;if(!t)return void console.warn(`Could not find cell with mxObjectId: ${e.id}`);const a=`${e.name?e.name.replace("_","#"):"Unknown"}\n        U[pu]: ${e.vm_pu?e.vm_pu.toFixed(3):"N/A"}\n        U[degree]: ${e.va_degree?e.va_degree.toFixed(3):"N/A"}`,i=n.insertVertex(t,null,a,0,2.7,0,0,"shapeELXXX=Result",!0);processCellStyles(n,i),function processVoltageColor(e,n,o){if(!o)return;const r=parseFloat(o.toFixed(2));let t=null;r>=1.1||r<=.9?t=s.DANGER:r>1.05&&r<=1.1||r>.9&&r<=.95?t=s.WARNING:(r>1&&r<=1.05||r>.95&&r<=1)&&(t=s.GOOD),t&&updateCellColor(e,n,t)}(o,t,e.vm_pu)}catch(n){console.error(`Error processing busbar ${e.id}:`,n)}}):console.warn("busbars data is not an array:",e)},lines:(e,n,o,r)=>{Array.isArray(e)?e.forEach(e=>{try{const s=r?r.get(e.id):null;if(!s)return void console.warn(`Could not find cell with mxObjectId: ${e.id}`);const t=`${e.name?e.name.replace("_","#"):"Unknown"}\n        P_from[MW]: ${e.p_from_mw?e.p_from_mw.toFixed(3):"N/A"}\n        Q_from[MVar]: ${e.q_from_mvar?e.q_from_mvar.toFixed(3):"N/A"}\n        i_from[kA]: ${e.i_from_ka?e.i_from_ka.toFixed(3):"N/A"}\n\n        Loading[%]: ${e.loading_percent?e.loading_percent.toFixed(1):"N/A"}\n\n        P_to[MW]: ${e.p_to_mw?e.p_to_mw.toFixed(3):"N/A"}\n        Q_to[MVar]: ${e.q_to_mvar?e.q_to_mvar.toFixed(3):"N/A"}\n        i_to[kA]: ${e.i_to_ka?e.i_to_ka.toFixed(3):"N/A"}`,a=n.insertVertex(s,null,t,0,0,0,0,"shapeELXXX=Result",!0);processCellStyles(n,a,!0),processLoadingColor(o,s,e.loading_percent)}catch(n){console.error(`Error processing line ${e.id}:`,n)}}):console.warn("lines data is not an array:",e)},externalgrids:(e,n,o)=>{Array.isArray(e)?e.forEach(e=>{try{const r=o?o.get(e.id):null;if(!r)return void console.warn(`Could not find cell with mxObjectId: ${e.id}`);const s=`${e.name?e.name.replace("_","#"):"Unknown"}\n        \n        P[MW]: ${e.p_mw?e.p_mw.toFixed(3):"N/A"}\n        Q[MVar]: ${e.q_mvar?e.q_mvar.toFixed(3):"N/A"}\n        PF: ${e.pf?e.pf.toFixed(3):"N/A"}\n        Q/P: ${e.q_p?e.q_p.toFixed(3):"N/A"}`,t=n.insertVertex(r,null,s,-.15,1.1,0,0,"shapeELXXX=Result",!0);processCellStyles(n,t)}catch(n){console.error(`Error processing external grid ${e.id}:`,n)}}):console.warn("externalgrids data is not an array:",e)},generators:(e,n,o)=>{Array.isArray(e)?e.forEach(e=>{try{const r=o?o.get(e.id):null;if(!r)return void console.warn(`Could not find cell with mxObjectId: ${e.id}`);const s=`${e.name?e.name.replace("_","#"):"Unknown"}\n        P[MW]: ${e.p_mw?e.p_mw.toFixed(3):"N/A"}\n        Q[MVar]: ${e.q_mvar?e.q_mvar.toFixed(3):"N/A"}\n        U[degree]: ${e.va_degree?e.va_degree.toFixed(3):"N/A"}\n        Um[pu]: ${e.vm_pu?e.vm_pu.toFixed(3):"N/A"}`,t=n.insertVertex(r,null,s,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(n,t)}catch(n){console.error(`Error processing generator ${e.id}:`,n)}}):console.warn("generators data is not an array:",e)},loads:(e,n,o)=>{Array.isArray(e)?e.forEach(e=>{try{const r=o?o.get(e.id):null;if(!r)return void console.warn(`Could not find cell with mxObjectId: ${e.id}`);const s=`${e.name?e.name.replace("_","#"):"Unknown"}\n        P[MW]: ${e.p_mw?e.p_mw.toFixed(3):"N/A"}\n        Q[MVar]: ${e.q_mvar?e.q_mvar.toFixed(3):"N/A"}`,t=n.insertVertex(r,null,s,-.15,1.7,0,0,"shapeELXXX=Result",!0);processCellStyles(n,t)}catch(n){console.error(`Error processing load ${e.id}:`,n)}}):console.warn("loads data is not an array:",e)},transformers:(e,n,o,r)=>{Array.isArray(e)?e.forEach(e=>{try{const s=r?r.get(e.id):null;if(!s)return void console.warn(`Could not find cell with mxObjectId: ${e.id}`);const t=`${e.name?e.name.replace("_","#"):"Unknown"}\n        P_HV[MW]: ${void 0!==e.p_hv_mw?e.p_hv_mw.toFixed(3):"N/A"}\n        Q_HV[MVAr]: ${void 0!==e.q_hv_mvar?e.q_hv_mvar.toFixed(3):"N/A"}\n        i_HV[kA]: ${e.i_hv_ka?e.i_hv_ka.toFixed(3):"N/A"}\n        \n        P_LV[MW]: ${void 0!==e.p_lv_mw?e.p_lv_mw.toFixed(3):"N/A"}\n        Q_LV[MVAr]: ${void 0!==e.q_lv_mvar?e.q_lv_mvar.toFixed(3):"N/A"}\n        i_LV[kA]: ${e.i_lv_ka?e.i_lv_ka.toFixed(3):"N/A"}\n        \n        Losses[MW]: ${void 0!==e.pl_mw?e.pl_mw.toFixed(3):"N/A"}\n        loading[%]: ${e.loading_percent?e.loading_percent.toFixed(1):"N/A"}`,a=n.insertVertex(s,null,t,-.15,1.1,0,0,"shapeELXXX=Result",!0);processCellStyles(n,a),processLoadingColor(o,s,e.loading_percent)}catch(n){console.error(`Error processing transformer ${e.id}:`,n)}}):console.warn("transformers data is not an array:",e)},shunts:(e,n,o)=>{Array.isArray(e)?e.forEach(e=>{try{const r=o?o.get(e.id):null;if(!r)return void console.warn(`Could not find cell with mxObjectId: ${e.id}`);const s=`${e.name?e.name.replace("_","#"):"Unknown"}\n        P[MW]: ${void 0!==e.p_mw&&null!==e.p_mw?e.p_mw.toFixed(3):"N/A"}\n        Q[MVar]: ${void 0!==e.q_mvar&&null!==e.q_mvar?e.q_mvar.toFixed(3):"N/A"}\n        Um[pu]: ${void 0!==e.vm_pu&&null!==e.vm_pu?e.vm_pu.toFixed(3):"N/A"}`,t=n.insertVertex(r,null,s,-.15,1.1,0,0,"shapeELXXX=Result",!0);processCellStyles(n,t)}catch(n){console.error(`Error processing shunt ${e.id}:`,n)}}):console.warn("shunts data is not an array:",e)},capacitors:(e,n,o)=>{Array.isArray(e)?e.forEach(e=>{try{const r=o?o.get(e.id):null;if(!r)return void console.warn(`Could not find cell with mxObjectId: ${e.id}`);const s=`${e.name?e.name.replace("_","#"):"Unknown"}\n        P[MW]: ${e.p_mw?e.p_mw.toFixed(3):"N/A"}\n        Q[MVar]: ${e.q_mvar?e.q_mvar.toFixed(3):"N/A"}\n        Um[pu]: ${e.vm_pu?e.vm_pu.toFixed(3):"N/A"}`,t=n.insertVertex(r,null,s,-.15,1.1,0,0,"shapeELXXX=Result",!0);processCellStyles(n,t)}catch(n){console.error(`Error processing capacitor ${e.id}:`,n)}}):console.warn("capacitors data is not an array:",e)},storages:(e,n,o)=>{Array.isArray(e)?e.forEach(e=>{try{const r=o?o.get(e.id):null;if(!r)return void console.warn(`Could not find cell with mxObjectId: ${e.id}`);const s=`${e.name?e.name.replace("_","#"):"Unknown"}\n        P[MW]: ${e.p_mw?e.p_mw.toFixed(3):"N/A"}\n        Q[MVar]: ${e.q_mvar?e.q_mvar.toFixed(3):"N/A"}`,t=n.insertVertex(r,null,s,-.15,1.1,0,0,"shapeELXXX=Result",!0);processCellStyles(n,t)}catch(n){console.error(`Error processing storage ${e.id}:`,n)}}):console.warn("storages data is not an array:",e)},pvsystems:(e,n,o)=>{Array.isArray(e)?e.forEach(e=>{try{const r=o?o.get(e.id):null;if(!r)return void console.warn(`Could not find cell with mxObjectId: ${e.id}`);const s=`${e.name?e.name.replace("_","#"):"Unknown"}\n        P[MW]: ${e.p_mw?e.p_mw.toFixed(3):"N/A"}\n        Q[MVar]: ${e.q_mvar?e.q_mvar.toFixed(3):"N/A"}\n        Um[pu]: ${e.vm_pu?e.vm_pu.toFixed(3):"N/A"}\n        U[degree]: ${e.va_degree?e.va_degree.toFixed(3):"N/A"}\n        Irradiance: ${e.irradiance?e.irradiance.toFixed(3):"N/A"}\n        Temperature: ${e.temperature?e.temperature.toFixed(3):"N/A"}`,t=n.insertVertex(r,null,s,0,3,0,0,"shapeELXXX=Result",!0);processCellStyles(n,t)}catch(n){console.error(`Error processing PVSystem ${e.id}:`,n)}}):console.warn("pvsystems data is not an array:",e)}},r={label:{[mxConstants.STYLE_FONTSIZE]:"6",[mxConstants.STYLE_ALIGN]:"ALIGN_LEFT"},line:{[mxConstants.STYLE_FONTSIZE]:"6",[mxConstants.STYLE_STROKE_OPACITY]:"0",[mxConstants.STYLE_STROKECOLOR]:"white",[mxConstants.STYLE_STROKEWIDTH]:"0",[mxConstants.STYLE_OVERFLOW]:"hidden"}},s={DANGER:"red",WARNING:"orange",GOOD:"green"};function processCellStyles(e,n,o=!1){o?(Object.entries(r.line).forEach(([o,r])=>{e.setCellStyles(o,r,[n])}),e.orderCells(!0,[n])):Object.entries(r.label).forEach(([o,r])=>{e.setCellStyles(o,r,[n])})}function processLoadingColor(e,n,o){if(!o)return;const r=parseFloat(o.toFixed(1));let t=null;r>100?t=s.DANGER:r>80?t=s.WARNING:r>0&&(t=s.GOOD),t&&updateCellColor(e,n,t)}function updateCellColor(e,n,o){const r=e.getModel().getStyle(n),s=mxUtils.setStyle(r,mxConstants.STYLE_STROKECOLOR,o);e.setCellStyle(s,[n])}function executeOpenDSSLoadFlow(e,n,s){let t;n.spinner.spin(document.body,"Waiting for OpenDSS results..."),t=Array.isArray(e)?e:[e.frequency||"50",e.mode||"Snapshot",e.algorithm||"Normal",e.loadmodel||"Powerflow",e.maxIterations||"100",e.tolerance||"0.0001",e.controlmode||"Static",e.exportCommands||!1],console.log("OpenDSS parameters (converted to array):",t);const a=function getUserEmail(){try{const e=localStorage.getItem("user");if(e){const n=JSON.parse(e);if(n&&n.email)return n.email}return"unknown@user.com"}catch(e){return"unknown@user.com"}}();console.log("OpenDSS - User email:",a);const i={typ:"PowerFlowOpenDss Parameters",frequency:t[0],mode:t[1],algorithm:t[2],loadmodel:t[3],maxIterations:t[4],tolerance:t[5],controlmode:t[6],exportCommands:t[7]||!1,exportOpenDSSResults:e.exportOpenDSSResults||!1,user_email:a};console.log("OpenDSS data object:",i);let l=collectNetworkDataStructured(s);console.log("Network data collected:",l),0===l.length&&window.App&&window.App.editor&&window.App.editor.graph&&(console.log("Trying global graph as fallback..."),l=collectNetworkDataStructured(window.App.editor.graph),console.log("Global graph network data:",l));const _=[i,...l];console.log("Complete OpenDSS data:",_),async function processNetworkData(e,n,s,t,a,i=!1){try{s.getStylesheet().putCellStyle("labelstyle",r.label),s.getStylesheet().putCellStyle("lineStyle",r.line);const a={};Array.isArray(n)?n.forEach((e,n)=>{a[n.toString()]=e}):a[0]=n,console.log("Sending to OpenDSS backend:",a);const l=performance.now(),_=await fetch(e,{mode:"cors",method:"post",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip"},body:JSON.stringify(a)});if(200!==_.status)throw new Error("server");const c=await _.json(),m=performance.now()-l;if(console.log(`OpenDSS backend response received in ${m.toFixed(0)}ms`),console.log("OpenDSS backend response:",c),function handleNetworkErrors(e){return!!e.error&&(alert("OpenDSS calculation error: "+e.error),!0)}(c))return;console.log("Processing OpenDSS results...");const p=performance.now(),d=new Map,u=s.getModel().cells,v=performance.now();for(const e in u){const n=u[e];n&&n.mxObjectId&&d.set(n.mxObjectId,n)}const g=performance.now()-v;console.log(`Built cell ID map with ${d.size} entries in ${g.toFixed(1)}ms`);let x=0;const w=s.getModel();w.beginUpdate();try{c.busbars&&Array.isArray(c.busbars)&&(console.log(`Processing ${c.busbars.length} busbars`),o.busbars(c.busbars,s,t,d),x+=c.busbars.length),c.lines&&Array.isArray(c.lines)&&(console.log(`Processing ${c.lines.length} lines`),o.lines(c.lines,s,t,d),x+=c.lines.length),c.loads&&Array.isArray(c.loads)&&(console.log(`Processing ${c.loads.length} loads`),o.loads(c.loads,s,d),x+=c.loads.length),c.generators&&Array.isArray(c.generators)&&(console.log(`Processing ${c.generators.length} generators`),o.generators(c.generators,s,d),x+=c.generators.length),c.transformers&&Array.isArray(c.transformers)&&(console.log(`Processing ${c.transformers.length} transformers`),o.transformers(c.transformers,s,t,d),x+=c.transformers.length),c.externalgrids&&Array.isArray(c.externalgrids)&&(console.log(`Processing ${c.externalgrids.length} external grids`),o.externalgrids(c.externalgrids,s,d),x+=c.externalgrids.length),c.shunts&&Array.isArray(c.shunts)&&(console.log(`Processing ${c.shunts.length} shunts`),o.shunts(c.shunts,s,d),x+=c.shunts.length),c.capacitors&&Array.isArray(c.capacitors)&&(console.log(`Processing ${c.capacitors.length} capacitors`),o.capacitors(c.capacitors,s,d),x+=c.capacitors.length),c.storages&&Array.isArray(c.storages)&&(console.log(`Processing ${c.storages.length} storages`),o.storages(c.storages,s,d),x+=c.storages.length),c.pvsystems&&Array.isArray(c.pvsystems)&&(console.log(`Processing ${c.pvsystems.length} PVSystems`),o.pvsystems(c.pvsystems,s,d),x+=c.pvsystems.length)}finally{w.endUpdate()}const b=performance.now()-p;console.log(`Processed ${x} elements in ${b.toFixed(0)}ms (${(b/x).toFixed(1)}ms per element)`),console.log(`Total round-trip time: ${(m+b).toFixed(0)}ms`),0===x?(console.warn("No results were processed from the OpenDSS backend response"),console.log("Available keys in response:",Object.keys(c)),console.log("OpenDSS calculation completed but no results were processed")):(console.log(`Successfully processed ${x} OpenDSS results`),console.log(`OpenDSS calculation completed successfully! Processed ${x} results.`)),i&&c.opendss_commands&&(console.log("Exporting OpenDSS commands to file..."),(e=>{try{const n=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o;const s=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,-5);r.download=`OpenDSS_Model_${s}.txt`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),console.log("OpenDSS commands file downloaded successfully")}catch(e){console.error("Error downloading OpenDSS commands:",e),alert("Failed to download OpenDSS commands file. Please check the console for details.")}})(c.opendss_commands)),console.log("ðŸ” Checking for OpenDSS results export..."),console.log("  - obj exists:",!!n),console.log("  - obj[0] exists:",!(!n||!n[0])),console.log("  - obj[0]:",n?n[0]:"obj is null"),console.log("  - exportOpenDSSResults value:",n&&n[0]?n[0].exportOpenDSSResults:"N/A"),n&&n[0]&&n[0].exportOpenDSSResults?(console.log("âœ… Exporting OpenDSS results to file..."),(e=>{try{let n="========================================\n";if(n+="     OpenDSS Load Flow Results\n",n+="========================================\n\n",n+=`Generated: ${(new Date).toISOString()}\n\n`,e.externalgrids&&e.externalgrids.length>0){n+="--- EXTERNAL GRIDS ---\n";const o=[20,12,12,12,10];n+=createOpenDSSTableRow(["Name","P [MW]","Q [MVAr]","PF","Q/P"],o)+"\n",n+=createOpenDSSTableSeparator(o)+"\n",e.externalgrids.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A",e.pf?e.pf.toFixed(3):"N/A",e.q_p?e.q_p.toFixed(3):"N/A"];n+=createOpenDSSTableRow(r,o)+"\n"}),n+="\n"}if(e.busbars&&e.busbars.length>0){n+="--- BUSES ---\n";const o=[20,12,14];n+=createOpenDSSTableRow(["Name","U [pu]","U [degree]"],o)+"\n",n+=createOpenDSSTableSeparator(o)+"\n",e.busbars.forEach(e=>{const r=[e.name||"N/A",e.vm_pu?e.vm_pu.toFixed(3):"N/A",e.va_degree?e.va_degree.toFixed(3):"N/A"];n+=createOpenDSSTableRow(r,o)+"\n"}),n+="\n"}if(e.lines&&e.lines.length>0){n+="--- LINES ---\n";const o=[20,13,14,13,12,13,12,13];n+=createOpenDSSTableRow(["Name","P_from [MW]","Q_from [MVAr]","I_from [kA]","P_to [MW]","Q_to [MVAr]","I_to [kA]","Loading [%]"],o)+"\n",n+=createOpenDSSTableSeparator(o)+"\n",e.lines.forEach(e=>{const r=[e.name||"N/A",e.p_from_mw?e.p_from_mw.toFixed(3):"N/A",e.q_from_mvar?e.q_from_mvar.toFixed(3):"N/A",e.i_from_ka?e.i_from_ka.toFixed(3):"N/A",e.p_to_mw?e.p_to_mw.toFixed(3):"N/A",e.q_to_mvar?e.q_to_mvar.toFixed(3):"N/A",e.i_to_ka?e.i_to_ka.toFixed(3):"N/A",e.loading_percent?e.loading_percent.toFixed(1):"N/A"];n+=createOpenDSSTableRow(r,o)+"\n"}),n+="\n"}if(e.transformers&&e.transformers.length>0){n+="--- TRANSFORMERS ---\n";const o=[20,13,13,12,13,12,12,13,12];n+=createOpenDSSTableRow(["Name","P_HV [MW]","Q_HV [MVAr]","P_LV [MW]","Q_LV [MVAr]","I_HV [kA]","I_LV [kA]","Loading [%]","Loss [MW]"],o)+"\n",n+=createOpenDSSTableSeparator(o)+"\n",e.transformers.forEach(e=>{const r=[e.name||"N/A",void 0!==e.p_hv_mw?e.p_hv_mw.toFixed(3):"N/A",void 0!==e.q_hv_mvar?e.q_hv_mvar.toFixed(3):"N/A",void 0!==e.p_lv_mw?e.p_lv_mw.toFixed(3):"N/A",void 0!==e.q_lv_mvar?e.q_lv_mvar.toFixed(3):"N/A",e.i_hv_ka?e.i_hv_ka.toFixed(3):"N/A",e.i_lv_ka?e.i_lv_ka.toFixed(3):"N/A",e.loading_percent?e.loading_percent.toFixed(1):"N/A",void 0!==e.pl_mw?e.pl_mw.toFixed(3):"N/A"];n+=createOpenDSSTableRow(r,o)+"\n"}),n+="\n"}if(e.generators&&e.generators.length>0){n+="--- GENERATORS ---\n";const o=[20,12,12,10,14];n+=createOpenDSSTableRow(["Name","P [MW]","Q [MVAr]","U [pu]","U [degree]"],o)+"\n",n+=createOpenDSSTableSeparator(o)+"\n",e.generators.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A",e.vm_pu?e.vm_pu.toFixed(3):"N/A",e.va_degree?e.va_degree.toFixed(3):"N/A"];n+=createOpenDSSTableRow(r,o)+"\n"}),n+="\n"}if(e.loads&&e.loads.length>0){n+="--- LOADS ---\n";const o=[20,12,12];n+=createOpenDSSTableRow(["Name","P [MW]","Q [MVAr]"],o)+"\n",n+=createOpenDSSTableSeparator(o)+"\n",e.loads.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A"];n+=createOpenDSSTableRow(r,o)+"\n"}),n+="\n"}if(e.shunts&&e.shunts.length>0){n+="--- SHUNT REACTORS ---\n";const o=[20,12,12,10];n+=createOpenDSSTableRow(["Name","P [MW]","Q [MVAr]","U [pu]"],o)+"\n",n+=createOpenDSSTableSeparator(o)+"\n",e.shunts.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A",e.vm_pu?e.vm_pu.toFixed(3):"N/A"];n+=createOpenDSSTableRow(r,o)+"\n"}),n+="\n"}if(e.capacitors&&e.capacitors.length>0){n+="--- CAPACITORS ---\n";const o=[20,12,12,10];n+=createOpenDSSTableRow(["Name","P [MW]","Q [MVAr]","U [pu]"],o)+"\n",n+=createOpenDSSTableSeparator(o)+"\n",e.capacitors.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A",e.vm_pu?e.vm_pu.toFixed(3):"N/A"];n+=createOpenDSSTableRow(r,o)+"\n"}),n+="\n"}if(e.pvsystems&&e.pvsystems.length>0){n+="--- PV SYSTEMS ---\n";const o=[20,12,12,10,14,12,14];n+=createOpenDSSTableRow(["Name","P [MW]","Q [MVAr]","U [pu]","U [degree]","Irradiance","Temp [Â°C]"],o)+"\n",n+=createOpenDSSTableSeparator(o)+"\n",e.pvsystems.forEach(e=>{const r=[e.name||"N/A",e.p_mw?e.p_mw.toFixed(3):"N/A",e.q_mvar?e.q_mvar.toFixed(3):"N/A",e.vm_pu?e.vm_pu.toFixed(3):"N/A",e.va_degree?e.va_degree.toFixed(3):"N/A",void 0!==e.irradiance?e.irradiance.toFixed(3):"N/A",void 0!==e.temperature?e.temperature.toFixed(1):"N/A"];n+=createOpenDSSTableRow(r,o)+"\n"}),n+="\n"}n+="========================================\n",n+="          End of Results\n",n+="========================================\n";const o=new Blob([n],{type:"text/plain;charset=utf-8"}),r=URL.createObjectURL(o),s=document.createElement("a");s.href=r;const t=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,-5);s.download=`OpenDSS_Results_${t}.txt`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r),console.log("OpenDSS results file downloaded successfully")}catch(e){console.error("Error downloading OpenDSS results:",e),alert("Failed to download OpenDSS results file. Please check the console for details.")}})(c)):(console.log("â„¹ï¸ OpenDSS results export not requested or flag not set"),console.log("  Condition breakdown:"),console.log("    - obj:",!!n),console.log("    - obj[0]:",!(!n||!n[0])),console.log("    - obj[0].exportOpenDSSResults:",!!(n&&n[0]&&n[0].exportOpenDSSResults)))}catch(e){if("server"===e.message){try{a&&a.spinner&&a.spinner.stop()}catch(e){console.error("Error stopping spinner:",e)}return}console.error("Error processing OpenDSS network data:",e),alert("Error processing OpenDSS network data: "+e+"\n\nCheck input data or contact electrisim@electrisim.com")}finally{console.log("Stopping spinner in finally block...");try{a&&a.spinner?(console.log("Spinner found, stopping..."),a.spinner.stop(),console.log("Spinner stopped successfully")):console.warn("Spinner not found on app parameter")}catch(e){console.error("Error stopping spinner:",e)}}}("https://03dht3kc-5000.euw.devtunnels.ms/",_,s,s,n,t[7]||!1)}function collectNetworkDataStructured(e){globalThis.openDssRunCount||(globalThis.openDssRunCount=0),globalThis.openDssRunCount++;const n=globalThis.openDssRunCount,o=performance.now();console.log(`=== OPENDSS DATA COLLECTION #${n} STARTED ===`),new Map;const r=new Map,s=new Map,t=new Map;console.log("Starting fresh data collection with clean caches");const a=[];let i=1,l=null;if(e&&e.getModel&&e.getModel().cells&&(l=e.getModel().cells,console.log("Method 1 - getModel().cells:",l)),!l&&e&&e.getModel&&e.getModel().getChildCells)try{l=e.getModel().getChildCells(e.getDefaultParent()),console.log("Method 2 - getChildCells():",l)}catch(e){console.log("Method 2 failed:",e)}if(!l&&e&&e.getSelectionCells)try{l=e.getSelectionCells(),console.log("Method 3 - getSelectionCells():",l)}catch(e){console.log("Method 3 failed:",e)}if(!l&&e&&e.getAllCells)try{l=e.getAllCells(),console.log("Method 4 - getAllCells():",l)}catch(e){console.log("Method 4 failed:",e)}if(!l)return console.error("Could not access graph cells data"),a;const _=performance.now();console.log(`Processing ${Object.keys(l).length} cells for OpenDSS...`),console.log("=== CLEANING UP PREVIOUS RESULTS ===");const c=performance.now(),m=[];let p=0;for(const e in l){const n=l[e];if(!n)continue;const o=n.getStyle?n.getStyle():"",r=n.getValue?n.getValue():"";if(o&&o.includes("Result"))m.push(n);else if(r&&"string"==typeof r){const e=r.toLowerCase();(e.includes("u[pu]")&&e.includes("p[mw]")||e.includes("u[degree]")&&e.includes("q[mvar]")||e.includes("pf:")||e.includes("q/p:")||e.includes("loading[%]")||e.includes("i_hv[ka]")||e.includes("i_mv[ka]")||e.includes("i_lv[ka]")||e.includes("i_from[ka]")||e.includes("i_to[ka]")||e.includes("pl[mw]")||e.includes("vm[pu]")||e.includes("va[degree]")||e.includes("um[pu]")||e.includes("p[mw]:")||e.includes("q[mvar]:")||e.includes("q_mvar:")||e.includes("vm_internal_pu:")||e.includes("va_internal_degree:")||e.includes("vm_pu:")||e.includes("va_degree:")||e.includes("firing angle[degree]:")||e.includes("x[ohm]:")||e.includes("q[mvar]:")||e.includes("p_from[mw]:")||e.includes("q_from[mvar]:")||e.includes("p_to[mw]:")||e.includes("q_to[mvar]:")||e.includes("p_l[mw]:")||e.includes("q_l[mvar]:")||e.includes("vm_from[pu]:")||e.includes("va_from[degree]:")||e.includes("vm_to[pu]:")||e.includes("va_to[degree]:")||e.includes("p_a[mw]:")||e.includes("q_a[mvar]:")||e.includes("p_b[mw]:")||e.includes("q_b[mvar]:")||e.includes("p_c[mw]:")||e.includes("q_c[mvar]:")||e.includes("pl[mw]:")||e.includes("ql[mvar]:")||e.includes("ikss[ka]")||e.includes("ip[ka]")||e.includes("ith[ka]")||e.includes("rk[ohm]")||e.includes("xk[ohm]"))&&(console.log(`Removing result cell by content: ${n.id} - Value snippet: ${r.substring(0,80).replace(/\n/g," ")}...`),m.push(n))}}if(m.length>0){console.log(`Removing ${m.length} result cells from previous analysis...`);try{if(e&&e.getModel){const n=e.getModel();n.beginUpdate();try{m.forEach(e=>{const o=n.getCell(e.id);o&&(n.remove(o),p++)})}finally{n.endUpdate()}console.log(`Successfully removed ${p} result cells`)}}catch(e){console.error("Error during result cleanup:",e)}}else console.log("No result cells to remove (first run or already clean)");const d=performance.now()-c;console.log(`Result cleanup completed: ${p} cells removed in ${d.toFixed(2)}ms`),console.log("=== END RESULT CLEANUP ===");let u=0;const v=[];for(const e in l){const n=l[e];n&&n.value&&v.push({cellId:e,cell:n})}console.log(`Found ${v.length} valid cells to process`);const g=performance.now();for(const{cellId:n,cell:o}of v){const r=o.value;let s=null;u++;const t=o.getStyle();if(t){const a=parseCellStyle(t);if(a&&"Bus"===a.shapeELXXX)s={typ:"Bus"+(i-1),name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,vn_kv:getBusVoltage(r),userFriendlyName:"Bus"},i++;else if(a&&"Line"===a.shapeELXXX){const e=getConnectedBusId(o,!0),r=getAttributesAsObject(o,{length_km:"length_km",parallel:"parallel",df:"df",r_ohm_per_km:"r_ohm_per_km",x_ohm_per_km:"x_ohm_per_km",c_nf_per_km:"c_nf_per_km",g_us_per_km:"g_us_per_km",max_i_ka:"max_i_ka",type:"type",in_service:{name:"in_service",optional:!0},r0_ohm_per_km:{name:"r0_ohm_per_km",optional:!0},x0_ohm_per_km:{name:"x0_ohm_per_km",optional:!0},c0_nf_per_km:{name:"c0_nf_per_km",optional:!0},endtemp_degree:{name:"endtemp_degree",optional:!0}});let t=!0;void 0!==r.in_service&&("boolean"==typeof r.in_service?t=r.in_service:"string"==typeof r.in_service&&(t="true"===r.in_service.toLowerCase())),s={typ:"Line",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,busFrom:e?.busFrom,busTo:e?.busTo,r_ohm_per_km:r.r_ohm_per_km||.122,x_ohm_per_km:r.x_ohm_per_km||.112,length_km:r.length_km||1,c_nf_per_km:r.c_nf_per_km||304,parallel:r.parallel||1,df:r.df||1,g_us_per_km:r.g_us_per_km||0,max_i_ka:r.max_i_ka||1,type:r.type||"OH",in_service:t,r0_ohm_per_km:r.r0_ohm_per_km||0,x0_ohm_per_km:r.x0_ohm_per_km||0,c0_nf_per_km:r.c0_nf_per_km||0,endtemp_degree:r.endtemp_degree||20},s.busFrom&&s.busTo?(console.log(`Line ${s.name}: busFrom=${s.busFrom}, busTo=${s.busTo}`),console.log(`Line parameters: R1=${s.r_ohm_per_km}, X1=${s.x_ohm_per_km}, Length=${s.length_km}km`)):console.warn(`Line ${s.name} missing bus connections: busFrom=${s.busFrom}, busTo=${s.busTo}`)}else if(a&&"Transformer"===a.shapeELXXX){const r=getTransformerConnections(o,e),t=getAttributesAsObject(o,{sn_mva:"sn_mva",vn_hv_kv:"vn_hv_kv",vn_lv_kv:"vn_lv_kv",vk_percent:"vk_percent",vkr_percent:"vkr_percent",pfe_kw:"pfe_kw",i0_percent:"i0_percent",shift_degree:"shift_degree",tap_side:"tap_side",tap_neutral:"tap_neutral",tap_min:"tap_min",tap_max:"tap_max",tap_step_percent:"tap_step_percent",tap_step_degree:"tap_step_degree",tap_pos:"tap_pos",tap_phase_shifter:"tap_phase_shifter",in_service:{name:"in_service",optional:!0}}),a=void 0===t.in_service||("string"==typeof t.in_service?"true"===t.in_service.toLowerCase():Boolean(t.in_service));s={typ:"Transformer",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,busFrom:r?.busFrom,busTo:r?.busTo,sn_mva:t.sn_mva||1,vk_percent:t.vk_percent||7,vkr_percent:t.vkr_percent||.5,vn_hv_kv:t.vn_hv_kv||110,vn_lv_kv:t.vn_lv_kv||20,pfe_kw:t.pfe_kw||0,i0_percent:t.i0_percent||0,shift_degree:t.shift_degree||0,tap_side:t.tap_side||"hv",tap_neutral:t.tap_neutral||0,tap_min:t.tap_min||-10,tap_max:t.tap_max||10,tap_step_percent:t.tap_step_percent||1.5,tap_step_degree:t.tap_step_degree||0,tap_pos:t.tap_pos||0,tap_phase_shifter:t.tap_phase_shifter||!1,in_service:a},s.busFrom&&s.busTo?console.log(`Transformer ${s.name}: busFrom=${s.busFrom}, busTo=${s.busTo}`):console.warn(`Transformer ${s.name} missing bus connections: busFrom=${s.busFrom}, busTo=${s.busTo}`)}else if(a&&"Generator"===a.shapeELXXX){const e=getAttributesAsObject(o,{p_mw:"p_mw",vm_pu:"vm_pu",sn_mva:"sn_mva",scaling:"scaling",vn_kv:"vn_kv",xdss_pu:"xdss_pu",rdss_ohm:"rdss_ohm",cos_phi:"cos_phi",pg_percent:"pg_percent",power_station_trafo:"power_station_trafo",q_mvar:"q_mvar",va_degree:"va_degree",max_p_mw:"max_p_mw",min_p_mw:"min_p_mw",max_q_mvar:"max_q_mvar",min_q_mvar:"min_q_mvar",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?"true"===e.in_service.toLowerCase():Boolean(e.in_service));s={typ:"Generator",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),p_mw:e.p_mw||10,q_mvar:e.q_mvar||0,vm_pu:e.vm_pu||1,sn_mva:e.sn_mva||10,scaling:e.scaling||1,vn_kv:e.vn_kv||20,xdss_pu:e.xdss_pu||.2,rdss_ohm:e.rdss_ohm||0,cos_phi:e.cos_phi||.9,pg_percent:e.pg_percent||100,power_station_trafo:e.power_station_trafo||!1,va_degree:e.va_degree||0,max_p_mw:e.max_p_mw||10,min_p_mw:e.min_p_mw||0,max_q_mvar:e.max_q_mvar||5,min_q_mvar:e.min_q_mvar||-5,in_service:r},s.bus?console.log(`Generator ${s.name}: bus=${s.bus}, P=${s.p_mw}MW, Q=${s.q_mvar}MVar`):console.warn(`Generator ${s.name} missing bus connection`)}else if(a&&"Load"===a.shapeELXXX){const e=getAttributesAsObject(o,{p_mw:"p_mw",q_mvar:"q_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",const_p_percent:"const_p_percent",const_q_percent:"const_q_percent",const_i_percent:"const_i_percent",const_z_percent:"const_z_percent",const_y_percent:"const_y_percent",const_s_percent:"const_s_percent",const_s_percent_abs:"const_s_percent_abs",const_s_percent_abs_degree:"const_s_percent_abs_degree",const_s_percent_abs_degree_abs:"const_s_percent_abs_degree_abs",const_s_percent_abs_degree_abs_degree:"const_s_percent_abs_degree_abs_degree",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?"true"===e.in_service.toLowerCase():Boolean(e.in_service));s={typ:"Load",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),p_mw:e.p_mw||1,q_mvar:e.q_mvar||0,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"const_p",const_p_percent:e.const_p_percent||100,const_q_percent:e.const_q_percent||100,const_i_percent:e.const_i_percent||100,const_z_percent:e.const_z_percent||100,const_y_percent:e.const_y_percent||100,in_service:r,const_s_percent:e.const_s_percent||100,const_s_percent_abs:e.const_s_percent_abs||100,const_s_percent_abs_degree:e.const_s_percent_abs_degree||0,const_s_percent_abs_degree_abs:e.const_s_percent_abs_degree_abs||100,const_s_percent_abs_degree_abs_degree:e.const_s_percent_abs_degree_abs_degree||0},s.bus?console.log(`Load ${s.name}: bus=${s.bus}, P=${s.p_mw}MW, Q=${s.q_mvar}MVar`):console.warn(`Load ${s.name} missing bus connection`)}else if(a&&"Shunt Reactor"===a.shapeELXXX){const e=getAttributesAsObject(o,{p_mw:"p_mw",q_mvar:"q_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",step:"step",step_degree:"step_degree",step_min:"step_min",step_max:"step_max",step_pos:"step_pos",step_phase_shifter:"step_phase_shifter",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"Shunt Reactor",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),p_mw:e.p_mw||0,q_mvar:e.q_mvar||1,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"const_q",step:e.step||1,step_degree:e.step_degree||0,step_min:e.step_min||0,step_max:e.step_max||1,step_pos:e.step_pos||1,step_phase_shifter:e.step_phase_shifter||!1,in_service:r},s.bus?console.log(`Shunt Reactor ${s.name}: bus=${s.bus}, Q=${s.q_mvar}MVar`):console.warn(`Shunt Reactor ${s.name} missing bus connection`)}else if(a&&"Capacitor"===a.shapeELXXX){const e=getAttributesAsObject(o,{q_mvar:"q_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",step:"step",step_degree:"step_degree",step_min:"step_min",step_max:"step_max",step_pos:"step_pos",step_phase_shifter:"step_phase_shifter",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"Capacitor",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),q_mvar:e.q_mvar||1,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"const_q",step:e.step||1,step_degree:e.step_degree||0,step_min:e.step_min||0,step_max:e.step_max||1,step_pos:e.step_pos||1,step_phase_shifter:e.step_phase_shifter||!1,in_service:r},s.bus?console.log(`Capacitor ${s.name}: bus=${s.bus}, Q=${s.q_mvar}MVar`):console.warn(`Capacitor ${s.name} missing bus connection`)}else if(a&&"Storage"===a.shapeELXXX){const e=getAttributesAsObject(o,{p_mw:"p_mw",q_mvar:"q_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",max_e_mwh:"max_e_mwh",max_p_mw:"max_p_mw",min_p_mw:"min_p_mw",max_q_mvar:"max_q_mvar",min_q_mvar:"min_q_mvar",soc_percent:"soc_percent",min_e_mwh:"min_e_mwh",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"Storage",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),p_mw:e.p_mw||0,q_mvar:e.q_mvar||0,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"storage",max_e_mwh:e.max_e_mwh||1,max_p_mw:e.max_p_mw||1,min_p_mw:e.min_p_mw||-1,max_q_mvar:e.max_q_mvar||1,min_q_mvar:e.min_q_mvar||-1,soc_percent:e.soc_percent||50,min_e_mwh:e.min_e_mwh||0,in_service:r},s.bus?console.log(`Storage ${s.name}: bus=${s.bus}, P=${s.p_mw}MW, Q=${s.q_mvar}MVar`):console.warn(`Storage ${s.name} missing bus connection`)}else if(a&&"PVSystem"===a.shapeELXXX){const e=getAttributesAsObject(o,{irradiance:"irradiance",pmpp:"pmpp",temperature:"temperature",phases:"phases",kv:"kv",pf:"pf",kvar:"kvar",kva:"kva",cutin:"cutin",cutout:"cutout",effcurve:"effcurve",ptcurve:"ptcurve",r:"r",x:"x",conn:"conn",model:"model",vmaxpu:"vmaxpu",vminpu:"vminpu",yearly:"yearly",daily:"daily",duty:"duty",tyearly:"tyearly",tdaily:"tdaily",tduty:"tduty",class_:"class",debugtrace:"debugtrace",spectrum:"spectrum",pminkvarmax:"pminkvarmax",pminnovars:"pminnovars",pmpp_percent:"pmpp_percent",amplimit:"amplimit",amplimitgain:"amplimitgain",balanced:"balanced",basefreq:"basefreq",controlmode:"controlmode",dutystart:"dutystart",dynamiceq:"dynamiceq",dynout:"dynout",kp:"kp",kvarmax:"kvarmax",kvarmaxabs:"kvarmaxabs",kvdc:"kvdc",limitcurrent:"limitcurrent",pfpriority:"pfpriority",pitol:"pitol",safemode:"safemode",safevoltage:"safevoltage",varfollowinverter:"varfollowinverter",wattpriority:"wattpriority",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"PVSystem",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),irradiance:e.irradiance||1,pmpp:e.pmpp||100,temperature:e.temperature||25,phases:e.phases||3,kv:e.kv||20,pf:e.pf||1,kvar:e.kvar||0,kva:e.kva||120,cutin:e.cutin||.1,cutout:e.cutout||.1,conn:e.conn||"wye",model:e.model||1,vmaxpu:e.vmaxpu||1.1,vminpu:e.vminpu||.9,yearly:e.yearly||"",daily:e.daily||"",duty:e.duty||"",tyearly:e.tyearly||"",tdaily:e.tdaily||"",tduty:e.tduty||"",class_:e.class_||1,debugtrace:e.debugtrace||!1,spectrum:e.spectrum||"default",pminkvarmax:e.pminkvarmax||0,pminnovars:e.pminnovars||0,pmpp_percent:e.pmpp_percent||100,amplimit:e.amplimit||1,amplimitgain:e.amplimitgain||.8,balanced:e.balanced||!1,basefreq:e.basefreq||60,controlmode:e.controlmode||"GFL",dutystart:e.dutystart||0,dynamiceq:e.dynamiceq||"",dynout:e.dynout||"",kp:e.kp||.1,kvarmax:e.kvarmax||120,kvarmaxabs:e.kvarmaxabs||120,kvdc:e.kvdc||20,limitcurrent:e.limitcurrent||!1,pfpriority:e.pfpriority||!1,pitol:e.pitol||.01,safemode:e.safemode||!1,safevoltage:e.safevoltage||.8,varfollowinverter:e.varfollowinverter||!1,wattpriority:e.wattpriority||!1,in_service:r},s.bus?console.log(`PVSystem ${s.name}: bus=${s.bus}, Pmpp=${s.pmpp}kW, Irradiance=${s.irradiance}kW/mÂ²`):console.warn(`PVSystem ${s.name} missing bus connection`)}else if(a&&"External Grid"===a.shapeELXXX){const e=getAttributesAsObject(o,{vm_pu:"vm_pu",va_degree:"va_degree",s_sc_max_mva:"s_sc_max_mva",s_sc_min_mva:"s_sc_min_mva",rx_max:"rx_max",rx_min:"rx_min",r0x0_max:"r0x0_max",x0x_max:"x0x_max",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"External Grid",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),vm_pu:e.vm_pu||1,va_degree:e.va_degree||0,s_sc_max_mva:e.s_sc_max_mva||1e3,s_sc_min_mva:e.s_sc_min_mva||1e3,rx_max:e.rx_max||.1,rx_min:e.rx_min||.1,r0x0_max:e.r0x0_max||.1,x0x_max:e.x0x_max||1,in_service:r},s.bus?console.log(`External Grid ${s.name}: bus=${s.bus}, vm_pu=${s.vm_pu}, va_degree=${s.va_degree}`):console.warn(`External Grid ${s.name} missing bus connection`)}else if(a&&"Three Winding Transformer"===a.shapeELXXX){const r=getTransformerConnections(o,e);s={typ:"Three Winding Transformer",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,busFrom:r?.busFrom,busTo:r?.busTo,...getAttributesAsObject(o,{sn_hv_mva:"sn_hv_mva",sn_mv_mva:"sn_mv_mva",sn_lv_mva:"sn_lv_mva",vn_hv_kv:"vn_hv_kv",vn_mv_kv:"vn_mv_kv",vn_lv_kv:"vn_lv_kv",vk_hv_percent:"vk_hv_percent",vk_mv_percent:"vk_mv_percent",vk_lv_percent:"vk_lv_percent",vkr_hv_percent:"vkr_hv_percent",vkr_mv_percent:"vkr_mv_percent",vkr_lv_percent:"vkr_lv_percent",pfe_kw:"pfe_kw",i0_percent:"i0_percent",shift_hv_degree:"shift_hv_degree",shift_mv_degree:"shift_mv_degree",shift_lv_degree:"shift_lv_degree",in_service:{name:"in_service",optional:!0}})},s.busFrom&&s.busTo?console.log(`Three Winding Transformer ${s.name}: busFrom=${s.busFrom}, busTo=${s.busTo}`):console.warn(`Three Winding Transformer ${s.name} missing bus connections: busFrom=${s.busFrom}, busTo=${s.busTo}`)}else if(a&&"Impedance"===a.shapeELXXX){const e=getAttributesAsObject(o,{r_ohm:"r_ohm",x_ohm:"x_ohm",sn_mva:"sn_mva",scaling:"scaling",type:"type",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"Impedance",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),r_ohm:e.r_ohm||0,x_ohm:e.x_ohm||0,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"impedance",in_service:r},s.bus?console.log(`Impedance ${s.name}: bus=${s.bus}, R=${s.r_ohm}Î©, X=${s.x_ohm}Î©`):console.warn(`Impedance ${s.name} missing bus connection`)}else if(a&&"Ward"===a.shapeELXXX){const e=getAttributesAsObject(o,{pz_mw:"pz_mw",qz_mvar:"qz_mvar",ps_mw:"ps_mw",qs_mvar:"qs_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"Ward",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),pz_mw:e.pz_mw||0,qz_mvar:e.qz_mvar||0,ps_mw:e.ps_mw||0,qs_mvar:e.qs_mvar||0,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"ward",in_service:r},s.bus?console.log(`Ward ${s.name}: bus=${s.bus}, PZ=${s.pz_mw}MW, QZ=${s.qz_mvar}MVar`):console.warn(`Ward ${s.name} missing bus connection`)}else if(a&&"Extended Ward"===a.shapeELXXX){const e=getAttributesAsObject(o,{pz_mw:"pz_mw",qz_mvar:"qz_mvar",ps_mw:"ps_mw",qs_mvar:"qs_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",r_ohm:"r_ohm",x_ohm:"x_ohm",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"Extended Ward",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),pz_mw:e.pz_mw||0,qz_mvar:e.qz_mvar||0,ps_mw:e.ps_mw||0,qs_mvar:e.qs_mvar||0,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"extended_ward",r_ohm:e.r_ohm||0,x_ohm:e.x_ohm||0,in_service:r},s.bus?console.log(`Extended Ward ${s.name}: bus=${s.bus}, PZ=${s.pz_mw}MW, QZ=${s.qz_mvar}MVar`):console.warn(`Extended Ward ${s.name} missing bus connection`)}else if(a&&"Motor"===a.shapeELXXX){const e=getAttributesAsObject(o,{pn_mw:"pn_mw",cos_phi_n:"cos_phi_n",efficiency_percent:"efficiency_percent",scaling:"scaling",type:"type",lrc_pu:"lrc_pu",max_ik_ka:"max_ik_ka",kappa:"kappa",current_source:"current_source",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"Motor",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),pn_mw:e.pn_mw||1,cos_phi_n:e.cos_phi_n||.9,efficiency_percent:e.efficiency_percent||95,scaling:e.scaling||1,type:e.type||"motor",lrc_pu:e.lrc_pu||0,max_ik_ka:e.max_ik_ka||1,kappa:e.kappa||1,current_source:e.current_source||!1,in_service:r},s.bus?console.log(`Motor ${s.name}: bus=${s.bus}, Pn=${s.pn_mw}MW, cos_phi=${s.cos_phi_n}`):console.warn(`Motor ${s.name} missing bus connection`)}else if(a&&"SVC"===a.shapeELXXX){const e=getAttributesAsObject(o,{q_mvar:"q_mvar",vm_set_pu:"vm_set_pu",vm_mag_pu:"vm_mag_pu",thyristor_firing_angle_degree:"thyristor_firing_angle_degree",sn_mva:"sn_mva",scaling:"scaling",type:"type",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"SVC",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),q_mvar:e.q_mvar||1,vm_set_pu:e.vm_set_pu||1,vm_mag_pu:e.vm_mag_pu||1,thyristor_firing_angle_degree:e.thyristor_firing_angle_degree||90,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"svc",in_service:r},s.bus?console.log(`SVC ${s.name}: bus=${s.bus}, Q=${s.q_mvar}MVar, vm_set_pu=${s.vm_set_pu}`):console.warn(`SVC ${s.name} missing bus connection`)}else if(a&&"TCSC"===a.shapeELXXX){const e=getAttributesAsObject(o,{x_l_ohm:"x_l_ohm",x_c_ohm:"x_c_ohm",x_par_ohm:"x_par_ohm",sn_mva:"sn_mva",scaling:"scaling",type:"type",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"TCSC",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),x_l_ohm:e.x_l_ohm||0,x_c_ohm:e.x_c_ohm||0,x_par_ohm:e.x_par_ohm||0,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"tcsc",in_service:r},s.bus?console.log(`TCSC ${s.name}: bus=${s.bus}, XL=${s.x_l_ohm}Î©, XC=${s.x_c_ohm}Î©`):console.warn(`TCSC ${s.name} missing bus connection`)}else if(a&&"SSC"===a.shapeELXXX){const e=getAttributesAsObject(o,{p_mw:"p_mw",q_mvar:"q_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"SSC",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),p_mw:e.p_mw||0,q_mvar:e.q_mvar||0,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"ssc",in_service:r},s.bus?console.log(`SSC ${s.name}: bus=${s.bus}, P=${s.p_mw}MW, Q=${s.q_mvar}MVar`):console.warn(`SSC ${s.name} missing bus connection`)}else if(a&&"DC Line"===a.shapeELXXX){const e=getConnectedBusId(o,!0),r=getAttributesAsObject(o,{p_mw:"p_mw",v_kv:"v_kv",max_p_mw:"max_p_mw",min_p_mw:"min_p_mw",max_q_mvar:"max_q_mvar",min_q_mvar:"min_q_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",in_service:{name:"in_service",optional:!0}}),t=void 0===r.in_service||("string"==typeof r.in_service?!["false","no","0"].includes(r.in_service.toLowerCase()):Boolean(r.in_service));s={typ:"DC Line",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,busFrom:e?.busFrom,busTo:e?.busTo,p_mw:r.p_mw||1,v_kv:r.v_kv||100,max_p_mw:r.max_p_mw||1,min_p_mw:r.min_p_mw||0,max_q_mvar:r.max_q_mvar||1,min_q_mvar:r.min_q_mvar||-1,sn_mva:r.sn_mva||1,scaling:r.scaling||1,type:r.type||"dc_line",in_service:t},s.busFrom&&s.busTo?console.log(`DC Line ${s.name}: busFrom=${s.busFrom}, busTo=${s.busTo}, P=${s.p_mw}MW`):console.warn(`DC Line ${s.name} missing bus connections: busFrom=${s.busFrom}, busTo=${s.busTo}`)}else if(a&&"Static Generator"===a.shapeELXXX){const e=getAttributesAsObject(o,{p_mw:"p_mw",q_mvar:"q_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",max_p_mw:"max_p_mw",min_p_mw:"min_p_mw",max_q_mvar:"max_q_mvar",min_q_mvar:"min_q_mvar",vm_pu:"vm_pu",va_degree:"va_degree",k:"k",rx:"rx",generator_type:"generator_type",lrc_pu:"lrc_pu",max_ik_ka:"max_ik_ka",kappa:"kappa",current_source:"current_source",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"Static Generator",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),p_mw:e.p_mw||1,q_mvar:e.q_mvar||0,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"static_generator",max_p_mw:e.max_p_mw||1,min_p_mw:e.min_p_mw||0,max_q_mvar:e.max_q_mvar||1,min_q_mvar:e.min_q_mvar||-1,vm_pu:e.vm_pu||1,va_degree:e.va_degree||0,k:e.k||1,rx:e.rx||.1,generator_type:e.generator_type||"static_generator",lrc_pu:e.lrc_pu||0,max_ik_ka:e.max_ik_ka||1,kappa:e.kappa||1,current_source:e.current_source||!1,in_service:r},s.bus?console.log(`Static Generator ${s.name}: bus=${s.bus}, P=${s.p_mw}MW, Q=${s.q_mvar}MVar`):console.warn(`Static Generator ${s.name} missing bus connection`)}else if(a&&"Asymmetric Static Generator"===a.shapeELXXX){const e=getAttributesAsObject(o,{p_a_mw:"p_a_mw",p_b_mw:"p_b_mw",p_c_mw:"p_c_mw",q_a_mvar:"q_a_mvar",q_b_mvar:"q_b_mvar",q_c_mvar:"q_c_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",max_p_mw:"max_p_mw",min_p_mw:"min_p_mw",max_q_mvar:"max_q_mvar",min_q_mvar:"min_q_mvar",vm_pu:"vm_pu",va_degree:"va_degree",k:"k",rx:"rx",generator_type:"generator_type",lrc_pu:"lrc_pu",max_ik_ka:"max_ik_ka",kappa:"kappa",current_source:"current_source",in_service:{name:"in_service",optional:!0}}),r=void 0===e.in_service||("string"==typeof e.in_service?!["false","no","0"].includes(e.in_service.toLowerCase()):Boolean(e.in_service));s={typ:"Asymmetric Static Generator",name:o.mxObjectId||o.id?(o.mxObjectId||o.id).replace("#","_"):`mxCell_${n}`,id:o.mxObjectId||o.id?o.mxObjectId||o.id:`mxCell_${n}`,bus:getConnectedBusId(o),p_a_mw:e.p_a_mw||1,p_b_mw:e.p_b_mw||1,p_c_mw:e.p_c_mw||1,q_a_mvar:e.q_a_mvar||0,q_b_mvar:e.q_b_mvar||0,q_c_mvar:e.q_c_mvar||0,sn_mva:e.sn_mva||1,scaling:e.scaling||1,type:e.type||"asymmetric_static_generator",max_p_mw:e.max_p_mw||1,min_p_mw:e.min_p_mw||0,max_q_mvar:e.max_q_mvar||1,min_q_mvar:e.min_q_mvar||-1,vm_pu:e.vm_pu||1,va_degree:e.va_degree||0,k:e.k||1,rx:e.rx||.1,generator_type:e.generator_type||"asymmetric_static_generator",lrc_pu:e.lrc_pu||0,max_ik_ka:e.max_ik_ka||1,kappa:e.kappa||1,current_source:e.current_source||!1,in_service:r},s.bus?console.log(`Asymmetric Static Generator ${s.name}: bus=${s.bus}, P_A=${s.p_a_mw}MW, P_B=${s.p_b_mw}MW, P_C=${s.p_c_mw}MW`):console.warn(`Asymmetric Static Generator ${s.name} missing bus connection`)}}s&&s.typ&&a.push(s)}const x=performance.now()-g,w=performance.now()-_,b=performance.now()-o;return console.log("=== OPENDSS DATA COLLECTION PERFORMANCE SUMMARY ==="),console.log(`Run #${n} - Cell processing: ${w.toFixed(2)}ms`),console.log(`Component processing: ${x.toFixed(2)}ms`),console.log(`Total processing: ${b.toFixed(2)}ms`),console.log(`Components processed: ${u}`),console.log(`Network elements collected: ${a.length}`),console.log(`Data collection completed. Cache sizes - cells: ${r.size}, names: ${s.size}, attributes: ${t.size}`),r.clear(),s.clear(),t.clear(),console.log("Caches cleared for next data collection"),console.log(`Collected ${a.length} network elements:`,a),a}function getBusVoltage(e){if(e&&e.attributes){for(let n=0;n<e.attributes.length;n++){const o=e.attributes[n];if("vn_kv"===o.nodeName){const e=o.nodeValue;if(e&&""!==e&&"null"!==e&&"undefined"!==e)return e}}if("string"==typeof e){if(e.includes("110kV"))return"110";if(e.includes("20kV"))return"20";if(e.includes("30kV"))return"30";if(e.includes("10kV"))return"10"}}return null}function executePandapowerLoadFlow(e,n,o){if(console.log("âœ… executePandapowerLoadFlow called with parameters:",e),console.log("âœ… exportPython value:",e.exportPython),console.log("âœ… exportPandapowerResults value:",e.exportPandapowerResults),n.spinner.spin(document.body,"Waiting for Pandapower results..."),"object"==typeof e&&!Array.isArray(e)&&e.frequency)console.log("âœ… Parameters is already an object, passing directly to core logic"),console.log("âœ… Preserving exportPython:",e.exportPython),executePandapowerCoreLogic(e,n,o);else{console.log("âš ï¸ Converting array format to object (legacy path)");const r=[e.frequency||e[0]||"50",e.algorithm||e[1]||"nr",e.calculate_voltage_angles||e[2]||"auto",e.initialization||e[3]||"auto"];console.log("Converted pandapower parameters:",r),executePandapowerCoreLogic(r,n,o)}}function executePandapowerCoreLogic(e,n,o){let r;console.log("âš ï¸ executePandapowerCoreLogic called - THIS SHOULD NOT BE USED FOR NORMAL LOAD FLOW!"),console.log("Executing pandapower core logic with parameters:",e),console.log("exportPython in parameters:",e.exportPython),Array.isArray(e)?(console.log("âš ï¸ Array format detected - converting to object (exportPython will be false)"),r={frequency:e[0]||"50",algorithm:e[1]||"nr",calculate_voltage_angles:e[2]||"auto",initialization:e[3]||"auto",exportPython:!1,engine:"pandapower"}):"object"==typeof e&&null!==e?(console.log("âœ… Object format detected - preserving all properties including exportPython"),console.log("âœ… exportPython value:",e.exportPython),console.log("âœ… exportPandapowerResults value:",e.exportPandapowerResults),r={frequency:e.frequency||"50",algorithm:e.algorithm||"nr",calculate_voltage_angles:e.calculate_voltage_angles||"auto",initialization:e.initialization||"auto",exportPython:e.exportPython||!1,exportPandapowerResults:e.exportPandapowerResults||!1,enforceLimits:e.enforceLimits||!1,engine:e.engine||"pandapower"},console.log("âœ… Final paramObject.exportPython:",r.exportPython),console.log("âœ… Final paramObject.exportPandapowerResults:",r.exportPandapowerResults)):(console.warn("âš ï¸ Unexpected parameters format:",typeof e),r={frequency:"50",algorithm:"nr",calculate_voltage_angles:"auto",initialization:"auto",exportPython:!1,engine:"pandapower"});const s=window.LoadFlowDialog.prototype.show;console.log("Original LoadFlowDialog.prototype.show:",s);try{window.LoadFlowDialog.prototype.show=function(e){console.log("Overridden LoadFlowDialog.show called, immediately calling callback with param OBJECT:",r),console.log("âœ… exportPython in paramObject being passed to callback:",r.exportPython),console.log("âœ… exportPandapowerResults in paramObject being passed to callback:",r.exportPandapowerResults),e(r)},console.log("Replaced LoadFlowDialog.prototype.show with dummy version"),console.log("Calling original loadFlowPandaPower with overridden show method"),globalThis.loadFlowPandaPower(n,o,null),console.log("loadFlowPandaPower called successfully")}catch(e){console.error("Error executing pandapower load flow:",e),n.spinner.stop(),alert("Error executing Pandapower load flow: "+e.message)}finally{console.log("Restoring original LoadFlowDialog.prototype.show:",s),window.LoadFlowDialog.prototype.show=s}}window.loadFlowOpenDss=loadFlowOpenDss,globalThis.loadFlowOpenDss=loadFlowOpenDss;export{loadFlowOpenDss};