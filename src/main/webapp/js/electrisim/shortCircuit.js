import{COMPONENT_TYPES as e}from"./utils/componentTypes.js";import{getAttributesAsObject as t}from"./utils/attributeUtils.js";import{ShortCircuitDialog as n}from"./dialogs/ShortCircuitDialog.js";window.shortCircuitPandaPower=function(r,a,o){let s=r,c=a;const l={externalGrid:0,generator:0,staticGenerator:0,asymmetricGenerator:0,busbar:0,transformer:0,threeWindingTransformer:0,shuntReactor:0,capacitor:0,load:0,asymmetricLoad:0,impedance:0,ward:0,extendedWard:0,motor:0,storage:0,SVC:0,TCSC:0,SSC:0,dcLine:0,line:0},i={simulationParameters:[],externalGrid:[],generator:[],staticGenerator:[],asymmetricGenerator:[],busbar:[],transformer:[],threeWindingTransformer:[],shuntReactor:[],capacitor:[],load:[],asymmetricLoad:[],impedance:[],ward:[],extendedWard:[],motor:[],storage:[],SVC:[],TCSC:[],SSC:[],dcLine:[],line:[]},_={label:{[mxConstants.STYLE_FONTSIZE]:"6",[mxConstants.STYLE_ALIGN]:"ALIGN_LEFT"},line:{[mxConstants.STYLE_FONTSIZE]:"6",[mxConstants.STYLE_STROKE_OPACITY]:"0",[mxConstants.STYLE_STROKECOLOR]:"white",[mxConstants.STYLE_STROKEWIDTH]:"0",[mxConstants.STYLE_OVERFLOW]:"hidden"}},formatNumber=(e,t=3)=>null==e||"NaN"===e||"number"==typeof e&&isNaN(e)?"N/A":parseFloat(e).toFixed(t),m={busbars:(e,t,n)=>{e.forEach(e=>{const n=t.getModel().getCell(e.id);e.name=e.name.replace("_","#");const r=`${n.value.attributes[0].nodeValue}\n                ikss[kA]: ${formatNumber(e.ikss_ka)}\n                ip[kA]: ${formatNumber(e.ip_ka)}\n                ith[kA]: ${formatNumber(e.ith_ka)}\n                rk[ohm]: ${formatNumber(e.rk_ohm)}\n                xk[ohm]: ${formatNumber(e.xk_ohm)}`;t.insertVertex(n,null,r,.2,4.5,0,0,"shapeELXXX=Result",!0)})}};const updateTransformerBusConnections=(e,t,n)=>{const updateTransformerStyle=(e,t)=>{const r=n.getModel().getStyle(e),a=mxUtils.setStyle(r,mxConstants.STYLE_STROKECOLOR,t);n.setCellStyle(a,[e])};return e.map(e=>(e=>{const r=(e=>{const t=n.getModel().getCell(e);if(!t)throw new Error(`Invalid transformer cell: ${e}`);return t})(e.id);try{const n=((e,n)=>{const r=t.find(t=>t.name===e),a=t.find(e=>e.name===n);if(!r||!a)throw new Error("Transformer is not connected to valid busbars.");return[r,a]})(e.hv_bus,e.lv_bus);updateTransformerStyle(r,"black");const{highVoltage:a,lowVoltage:o}=(e=>{if(2!==e.length)throw new Error("Transformer requires exactly two busbars.");const[t,n]=e;return parseFloat(t.vn_kv)>parseFloat(n.vn_kv)?{highVoltage:t.name,lowVoltage:n.name}:{highVoltage:n.name,lowVoltage:t.name}})(n);return{...e,hv_bus:a,lv_bus:o}}catch(t){return console.log(`Error processing transformer ${e.id}:`,t.message),updateTransformerStyle(r,"red"),alert("The transformer is not connected to the bus. Please check the transformer highlighted in red and connect it to the appropriate bus."),e}})(e))},updateThreeWindingTransformerConnections=(e,t,n)=>{const updateTransformerStyle=(e,t)=>{const r=n.getModel().getStyle(e),a=mxUtils.setStyle(r,mxConstants.STYLE_STROKECOLOR,t);n.setCellStyle(a,[e])};return e.map(e=>(e=>{const r=(e=>{const t=n.getModel().getCell(e);if(!t)throw new Error(`Invalid three-winding transformer cell: ${e}`);return t})(e.id);try{const n=((e,n,r)=>{const a=t.find(t=>t.name===e),o=t.find(e=>e.name===n),s=t.find(e=>e.name===r);if(!a||!o||!s)throw new Error("Three-winding transformer is not connected to valid busbars.");return[a,o,s]})(e.hv_bus,e.mv_bus,e.lv_bus);updateTransformerStyle(r,"black");const{highVoltage:a,mediumVoltage:o,lowVoltage:s}=(e=>{if(3!==e.length)throw new Error("Three-winding transformer requires exactly three busbars.");const t=e.reduce((e,t)=>parseFloat(e.vn_kv)>parseFloat(t.vn_kv)?e:t),n=e.reduce((e,t)=>parseFloat(e.vn_kv)<parseFloat(t.vn_kv)?e:t),r=e.find(e=>e.name!==t.name&&e.name!==n.name);return{highVoltage:t.name,mediumVoltage:r.name,lowVoltage:n.name}})(n);return{...e,hv_bus:a,mv_bus:o,lv_bus:s}}catch(t){return console.log(`Error processing three-winding transformer ${e.id}:`,t.message),updateTransformerStyle(r,"red"),alert("The three-winding transformer is not connected to the bus. Please check the three-winding transformer highlighted in red and connect it to the appropriate bus."),e}})(e))},getConnectedBusId=(e,t=!1)=>{if(t)return{busFrom:e.source?.mxObjectId?.replace("#","_"),busTo:e.target?.mxObjectId?.replace("#","_")};const n=e.edges[0];return n&&(n.target||n.source)?n.target&&n.target.mxObjectId!==e.mxObjectId?n.target.mxObjectId.replace("#","_"):n.source&&n.source.mxObjectId!==e.mxObjectId?n.source.mxObjectId.replace("#","_"):null:null},getConnectedBuses=e=>({busFrom:e.source?.mxObjectId?.replace("#","_"),busTo:e.target?.mxObjectId?.replace("#","_")}),getImpedanceConnections=e=>{if(!e.edges||e.edges.length<2)throw new Error(`Impedance ${e.mxObjectId} must be connected to exactly two buses`);const[t,n]=e.edges,getBusId=t=>{if(t.target&&t.target.mxObjectId!==e.mxObjectId)return t.target.mxObjectId.replace("#","_");if(t.source&&t.source.mxObjectId!==e.mxObjectId)return t.source.mxObjectId.replace("#","_");throw new Error(`Invalid edge connection for impedance ${e.mxObjectId}`)};return{busFrom:getBusId(t),busTo:getBusId(n)}};a.isEnabled()&&!a.isCellLocked(a.getDefaultParent())&&new n(r).show(function(n,r){globalThis.shortCircuitRunCount||(globalThis.shortCircuitRunCount=0),globalThis.shortCircuitRunCount++;const o=globalThis.shortCircuitRunCount,p=performance.now();console.log(`=== SHORT CIRCUIT SIMULATION #${o} STARTED ===`),new Map;const d=new Map,u=new Map,g=new Map;console.log("Starting fresh simulation with clean caches");const v=a.getModel.bind(a)();let h=v.getDescendants();const f=a.getDefaultParent(),b=v.getChildCells(f,!0,!0),w=[],x=v.cells;if(x)for(const O in x){const E=x[O];E&&w.push(E)}const k=new Set,y=[];[...h,...b,...w].forEach(e=>{e&&e.id&&!k.has(e.id)&&(k.add(e.id),y.push(e))}),h=y,console.log(`Processing ${h.length} cells (descendants: ${v.getDescendants().length}, children: ${b.length}, model.cells: ${w.length})...`),console.log(`Initial memory check - cellsArray length: ${h.length}`),console.log("=== DIRECT RESULT CLEANUP ===");const C=performance.now();let S=0;v.beginUpdate();try{for(let I=h.length-1;I>=0;I--){const R=h[I];if(R&&R.getValue){const $=R.getValue(),j=R.getStyle();if(j&&j.includes("Result")){console.log(`Removing result cell by style: ${R.id} - Style: ${j}`),v.remove(v.getCell(R.id)),S++;continue}if($&&"string"==typeof $){const L=$.toLowerCase();(L.includes("ikss[ka]")||L.includes("ip[ka]")||L.includes("ith[ka]")||L.includes("rk[ohm]")||L.includes("xk[ohm]")||L.includes("u[pu]")&&L.includes("p[mw]")||L.includes("u[degree]")&&L.includes("q[mvar]")||L.includes("pf:")||L.includes("q/p:"))&&(console.log(`Removing result cell by content: ${R.id} - Value snippet: ${$.substring(0,100).replace(/\n/g," ")}...`),v.remove(v.getCell(R.id)),S++)}}}}finally{v.endUpdate()}const T=performance.now()-C;if(console.log(`Direct cleanup completed: ${S} cells removed in ${T.toFixed(2)}ms`),console.log("=== END DIRECT CLEANUP ==="),S>0){console.log("Forcing graph refresh after result cleanup...");try{a.refresh(),a.view&&a.view.validate&&a.view.validate(),a.repaint&&a.repaint()}catch(q){console.warn("Graph refresh error (non-critical):",q)}h=v.getDescendants(),console.log(`Updated cellsArray length after cleanup and refresh: ${h.length}`)}if(s.spinner.spin(document.body,"Waiting for results..."),n.length>0){function getUserEmail(){try{const e=localStorage.getItem("user");if(e){const t=JSON.parse(e);if(t&&t.email)return t.email}if("function"==typeof getCurrentUser){const e=getCurrentUser();if(e&&e.email)return e.email}if(window.getCurrentUser&&"function"==typeof window.getCurrentUser){const e=window.getCurrentUser();if(e&&e.email)return e.email}if(window.authHandler&&window.authHandler.getCurrentUser){const e=window.authHandler.getCurrentUser();if(e&&e.email)return e.email}return"unknown@user.com"}catch(e){return console.warn("Error getting user email:",e),"unknown@user.com"}}const A=getUserEmail();console.log("Short Circuit - User email:",A),i.simulationParameters.push({typ:"ShortCircuitPandaPower Parameters",fault_type:n[0],fault_location:n[1],fault_impedance:n[2],user_email:A});const N=performance.now(),D=[],F=[];h.forEach(e=>{const t=e.getStyle(),n=e.getValue();if(t&&t.includes("Result"))return void D.push(e);if(n&&"string"==typeof n){const t=n.toLowerCase();if(t.includes("ikss[ka]")||t.includes("ip[ka]")||t.includes("ith[ka]")||t.includes("rk[ohm]")||t.includes("xk[ohm]")||t.includes("u[pu]")&&t.includes("p[mw]")||t.includes("u[degree]")&&t.includes("q[mvar]")||t.includes("pf:")||t.includes("q/p:")||t.includes("loading[%]")||t.includes("i_hv[ka]")||t.includes("i_mv[ka]")||t.includes("i_lv[ka]")||t.includes("i_from[ka]")||t.includes("i_to[ka]")||t.includes("pl[mw]")||t.includes("vm[pu]")||t.includes("va[degree]")||t.includes("um[pu]")||t.includes("p[mw]:")||t.includes("q[mvar]:")||t.includes("q_mvar:")||t.includes("vm_internal_pu:")||t.includes("va_internal_degree:")||t.includes("vm_pu:")||t.includes("va_degree:")||t.includes("firing angle[degree]:")||t.includes("x[ohm]:")||t.includes("q[mvar]:")||t.includes("p_from[mw]:")||t.includes("q_from[mvar]:")||t.includes("p_to[mw]:")||t.includes("q_to[mvar]:")||t.includes("p_l[mw]:")||t.includes("q_l[mvar]:")||t.includes("vm_from[pu]:")||t.includes("va_from[degree]:")||t.includes("vm_to[pu]:")||t.includes("va_to[degree]:")||t.includes("p_a[mw]:")||t.includes("q_a[mvar]:")||t.includes("p_b[mw]:")||t.includes("q_b[mvar]:")||t.includes("p_c[mw]:")||t.includes("q_c[mvar]:")||t.includes("pl[mw]:")||t.includes("ql[mvar]:"))return void D.push(e)}const r=(e=>{if(!e)return null;const t={};return e.split(";").forEach(e=>{const[n,r]=e.split("=");n&&r&&(t[n]=r)}),t})(t);if(!r)return;const a=r.shapeELXXX;a&&"NotEditableLine"!=a&&F.push({cell:e,style:r,componentType:a})});let G=0;const P=performance.now();if(console.log(`Found ${D.length} result cells to remove`),D.length>0&&(console.log("Result cells details:"),D.forEach((e,t)=>{console.log(`  ${t+1}. ID: ${e.id}, Style: ${e.getStyle()}, Value: ${"string"==typeof e.value?e.value.substring(0,50)+"...":e.value}`)})),D.length>0){console.log(`Removing ${D.length} result cells from previous short circuit simulation...`);try{v.beginUpdate(),D.forEach(e=>{const t=v.getCell(e.id);t?(v.remove(t),G++,console.log(`Removed result cell: ${e.id}`)):console.warn(`Could not find cell to remove: ${e.id}`)})}finally{v.endUpdate()}console.log(`Successfully removed ${G} result cells`)}else console.log("No result cells to remove (first run or already clean)");const U=performance.now()-P,V=performance.now()-N;console.log(`Cell processing: ${V.toFixed(2)}ms (removed ${G} result cells in ${U.toFixed(2)}ms, found ${F.length} valid cells)`);const M=performance.now();let W=0;F.forEach(({cell:n,style:r,componentType:a})=>{let o;switch(W++,o="Line"===a||"DCLine"===a?{name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n,!0)}:{name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n)},a){case e.EXTERNAL_GRID:const r={...o,typ:"External Grid"+l.externalGrid++,...t(n,{vm_pu:"vm_pu",va_degree:"va_degree",s_sc_max_mva:"s_sc_max_mva",s_sc_min_mva:"s_sc_min_mva",rx_max:"rx_max",rx_min:"rx_min",r0x0_max:"r0x0_max",x0x_max:"x0x_max"})};i.externalGrid.push(r);break;case e.GENERATOR:const a={...o,typ:"Generator",...t(n,{p_mw:"p_mw",vm_pu:"vm_pu",sn_mva:"sn_mva",scaling:"scaling",vn_kv:"vn_kv",xdss_pu:"xdss_pu",rdss_ohm:"rdss_ohm",cos_phi:"cos_phi",pg_percent:"pg_percent",power_station_trafo:"power_station_trafo"})};i.generator.push(a),l.generator++;break;case e.STATIC_GENERATOR:const s={...o,typ:"Static Generator",...t(n,{p_mw:"p_mw",q_mvar:"q_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type",k:"k",rx:"rx",generator_type:"generator_type",lrc_pu:"lrc_pu",max_ik_ka:"max_ik_ka",kappa:"kappa",current_source:"current_source"})};i.staticGenerator.push(s),l.staticGenerator++;break;case e.ASYMMETRIC_STATIC_GENERATOR:const c={...o,typ:"Asymmetric Static Generator"+l.asymmetricGenerator++,...t(n,{p_a_mw:"p_a_mw",p_b_mw:"p_b_mw",p_c_mw:"p_c_mw",q_a_mvar:"q_a_mvar",q_b_mvar:"q_b_mvar",q_c_mvar:"q_c_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type"})};i.asymmetricGenerator.push(c);break;case e.BUS:const _={typ:"Bus"+l.busbar++,name:n.mxObjectId.replace("#","_"),id:n.id,vn_kv:n.value.attributes[2].nodeValue};i.busbar.push(_);break;case e.TRANSFORMER:const{hv_bus:m,lv_bus:p}=(e=>{const[t,n]=e.edges,getConnectedBus=t=>(t.target.mxObjectId!==e.mxObjectId?t.target.mxObjectId:t.source.mxObjectId).replace("#","_");return{hv_bus:getConnectedBus(t),lv_bus:getConnectedBus(n)}})(n),d={typ:"Transformer"+l.transformer++,name:n.mxObjectId.replace("#","_"),id:n.id,hv_bus:m,lv_bus:p,...t(n,{sn_mva:"sn_mva",vn_hv_kv:"vn_hv_kv",vn_lv_kv:"vn_lv_kv",vkr_percent:"vkr_percent",vk_percent:"vk_percent",pfe_kw:"pfe_kw",i0_percent:"i0_percent",vector_group:{name:"vector_group",optional:!0},vk0_percent:{name:"vk0_percent",optional:!0},vkr0_percent:{name:"vkr0_percent",optional:!0},mag0_percent:{name:"mag0_percent",optional:!0},si0_hv_partial:{name:"si0_hv_partial",optional:!0},parallel:{name:"parallel",optional:!0},shift_degree:{name:"shift_degree",optional:!0},tap_side:{name:"tap_side",optional:!0},tap_pos:{name:"tap_pos",optional:!0},tap_neutral:{name:"tap_neutral",optional:!0},tap_max:{name:"tap_max",optional:!0},tap_min:{name:"tap_min",optional:!0},tap_step_percent:{name:"tap_step_percent",optional:!0},tap_step_degree:{name:"tap_step_degree",optional:!0},tap_phase_shifter:{name:"tap_phase_shifter",optional:!0}})};i.transformer.push(d);break;case e.THREE_WINDING_TRANSFORMER:const u=(e=>{const[t,n,r]=e.edges,getConnectedBus=t=>(t.target.mxObjectId!==e.mxObjectId?t.target.mxObjectId:t.source.mxObjectId).replace("#","_");return{hv_bus:getConnectedBus(r),mv_bus:getConnectedBus(n),lv_bus:getConnectedBus(t)}})(n),g={typ:"Three Winding Transformer"+l.threeWindingTransformer++,name:n.mxObjectId.replace("#","_"),id:n.id,...u,...t(n,{sn_hv_mva:"sn_hv_mva",sn_mv_mva:"sn_mv_mva",sn_lv_mva:"sn_lv_mva",vn_hv_kv:"vn_hv_kv",vn_mv_kv:"vn_mv_kv",vn_lv_kv:"vn_lv_kv",vk_hv_percent:"vk_hv_percent",vk_mv_percent:"vk_mv_percent",vk_lv_percent:"vk_lv_percent",vkr_hv_percent:"vkr_hv_percent",vkr_mv_percent:"vkr_mv_percent",vkr_lv_percent:"vkr_lv_percent",pfe_kw:"pfe_kw",i0_percent:"i0_percent",vk0_hv_percent:"vk0_hv_percent",vk0_mv_percent:"vk0_mv_percent",vk0_lv_percent:"vk0_lv_percent",vkr0_hv_percent:"vkr0_hv_percent",vkr0_mv_percent:"vkr0_mv_percent",vkr0_lv_percent:"vkr0_lv_percent",vector_group:"vector_group",shift_mv_degree:{name:"shift_mv_degree",optional:!0},shift_lv_degree:{name:"shift_lv_degree",optional:!0},tap_step_percent:{name:"tap_step_percent",optional:!0},tap_side:{name:"tap_side",optional:!0},tap_neutral:{name:"tap_neutral",optional:!0},tap_min:{name:"tap_min",optional:!0},tap_max:{name:"tap_max",optional:!0},tap_pos:{name:"tap_pos",optional:!0},tap_at_star_point:{name:"tap_at_star_point",optional:!0}})};i.threeWindingTransformer.push(g);break;case e.SHUNT_REACTOR:const v={typ:"Shunt Reactor"+l.shuntReactor++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{p_mw:"p_mw",q_mvar:"q_mvar",vn_kv:"vn_kv",step:{name:"step",optional:!0},max_step:{name:"max_step",optional:!0}})};i.shuntReactor.push(v);break;case e.CAPACITOR:const h={typ:"Capacitor"+l.capacitor++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{q_mvar:"q_mvar",loss_factor:"loss_factor",vn_kv:"vn_kv",step:{name:"step",optional:!0},max_step:{name:"max_step",optional:!0}})};i.capacitor.push(h);break;case e.LOAD:const f={typ:"Load"+l.load++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{p_mw:"p_mw",q_mvar:"q_mvar",const_z_percent:"const_z_percent",const_i_percent:"const_i_percent",sn_mva:"sn_mva",scaling:"scaling",type:"type"})};i.load.push(f);break;case e.ASYMMETRIC_LOAD:const b={typ:"Asymmetric Load"+l.asymmetricLoad++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{p_a_mw:"p_a_mw",p_b_mw:"p_b_mw",p_c_mw:"p_c_mw",q_a_mvar:"q_a_mvar",q_b_mvar:"q_b_mvar",q_c_mvar:"q_c_mvar",sn_mva:"sn_mva",scaling:"scaling",type:"type"})};i.asymmetricLoad.push(b);break;case e.IMPEDANCE:try{const e={typ:"Impedance"+l.impedance++,name:n.mxObjectId.replace("#","_"),id:n.id,...getImpedanceConnections(n),...t(n,{rft_pu:"rft_pu",xft_pu:"xft_pu",sn_mva:"sn_mva"})};i.impedance.push(e)}catch(e){alert(e.message)}break;case e.WARD:const w={typ:"Ward"+l.ward++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{ps_mw:"ps_mw",qs_mvar:"qs_mvar",pz_mw:"pz_mw",qz_mvar:"qz_mvar"})};i.ward.push(w);break;case e.EXTENDED_WARD:const x={typ:"Extended Ward"+l.extendedWard++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{ps_mw:"ps_mw",qs_mvar:"qs_mvar",pz_mw:"pz_mw",qz_mvar:"qz_mvar",r_ohm:"r_ohm",x_ohm:"x_ohm",vm_pu:"vm_pu"})};i.extendedWard.push(x);break;case e.MOTOR:const k={typ:"Motor"+l.motor++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{pn_mech_mw:"pn_mech_mw",cos_phi:"cos_phi",efficiency_percent:"efficiency_percent",loading_percent:"loading_percent",scaling:"scaling",cos_phi_n:"cos_phi_n",efficiency_n_percent:"efficiency_n_percent",Irc_pu:"Irc_pu",rx:"rx",vn_kv:"vn_kv",efficiency_percent:"efficiency_percent",loading_percent:"loading_percent",scaling:"scaling"})};i.motor.push(k);break;case e.STORAGE:const y={typ:"Storage"+l.storage++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{p_mw:"p_mw",max_e_mwh:"max_e_mwh",q_mvar:"q_mvar",sn_mva:"sn_mva",soc_percent:"soc_percent",min_e_mwh:"min_e_mwh",scaling:"scaling",type:"type"})};i.storage.push(y);break;case e.SVC:const C={typ:"SVC"+l.SVC++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{x_l_ohm:"x_l_ohm",x_cvar_ohm:"x_cvar_ohm",set_vm_pu:"set_vm_pu",thyristor_firing_angle_degree:"thyristor_firing_angle_degree",controllable:"controllable",min_angle_degree:"min_angle_degree",max_angle_degree:"max_angle_degree"})};i.SVC.push(C);break;case e.TCSC:const S={typ:"TCSC"+l.TCSC++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{x_l_ohm:"x_l_ohm",x_cvar_ohm:"x_cvar_ohm",set_p_to_mw:"set_p_to_mw",thyristor_firing_angle_degree:"thyristor_firing_angle_degree",controllable:"controllable",min_angle_degree:"min_angle_degree",max_angle_degree:"max_angle_degree"})};i.TCSC.push(S);break;case e.SSC:const T={typ:"SSC"+l.SSC++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{r_ohm:"r_ohm",x_ohm:"x_ohm",set_vm_pu:"set_vm_pu",vm_internal_pu:"vm_internal_pu",va_internal_degree:"va_internal_degree",controllable:"controllable"})};i.SSC.push(T);break;case e.DC_LINE:const O={typ:"DC Line"+l.dcLine++,name:n.mxObjectId.replace("#","_"),id:n.id,bus:getConnectedBusId(n),...t(n,{p_mw:"p_mw",loss_percent:"loss_percent",loss_mw:"loss_mw",vm_from_pu:"vm_from_pu",vm_to_pu:"vm_to_pu"})};i.dcLine.push(O);break;case e.LINE:try{console.log("Processing line:",n.mxObjectId),console.log("Line edges:",n.edges?.length||0),console.log("Line connections:",n.edges?.map(e=>({source:e.source?.mxObjectId,target:e.target?.mxObjectId})));const e={typ:"Line"+l.line++,name:n.mxObjectId.replace("#","_"),id:n.id,...getConnectedBuses(n),...t(n,{length_km:"length_km",parallel:{name:"parallel",optional:!0},df:{name:"df",optional:!0},r_ohm_per_km:"r_ohm_per_km",x_ohm_per_km:"x_ohm_per_km",c_nf_per_km:"c_nf_per_km",g_us_per_km:"g_us_per_km",max_i_ka:"max_i_ka",type:"type",r0_ohm_per_km:{name:"r0_ohm_per_km",optional:!0},x0_ohm_per_km:{name:"x0_ohm_per_km",optional:!0},c0_nf_per_km:{name:"c0_nf_per_km",optional:!0},endtemp_degree:{name:"endtemp_degree",optional:!0}})};try{(e=>{const t=getConnectedBuses(e);if(!t.busFrom||!t.busTo)throw new Error(`Line ${e.mxObjectId} is not connected to two buses`)})(n)}catch(e){console.error(e.message),alert("The line is not connected to the bus. Please check the line highlighted in red and connect it to the appropriate bus.")}i.line.push(e)}catch(e){console.error(e.message),alert("Error processing line. Please check the console for more details.")}}});const z=performance.now()-M;console.log(`Component processing: ${z.toFixed(2)}ms (${W} components)`),i.transformer.length>0&&(i.transformer=updateTransformerBusConnections(i.transformer,i.busbar,a)),i.threeWindingTransformer.length>0&&(i.threeWindingTransformer=updateThreeWindingTransformerConnections(i.threeWindingTransformer,i.busbar,a));const Y=[...i.simulationParameters,...i.externalGrid,...i.generator,...i.staticGenerator,...i.asymmetricGenerator,...i.busbar,...i.transformer,...i.threeWindingTransformer,...i.shuntReactor,...i.capacitor,...i.load,...i.asymmetricLoad,...i.impedance,...i.ward,...i.extendedWard,...i.SSC,...i.SVC,...i.TCSC,...i.line],H=Object.assign({},Y);console.log("Short Circuit data prepared:",JSON.stringify(H));const X=performance.now()-p;console.log("=== SHORT CIRCUIT PERFORMANCE SUMMARY ==="),console.log(`Run #${o} - Total processing: ${X.toFixed(2)}ms`),console.log(`Components processed: ${W}`),console.log(`Result cells removed: ${G}`),console.log(`Simulation completed. Cache sizes - cells: ${d.size}, names: ${u.size}, attributes: ${g.size}`),d.clear(),u.clear(),g.clear(),console.log("Caches cleared for next simulation"),async function processNetworkData(e,t,n,r){try{n.getStylesheet().putCellStyle("labelstyle",_.label),n.getStylesheet().putCellStyle("lineStyle",_.line);const a=performance.now(),o=await fetch(e,{mode:"cors",method:"post",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip"},body:JSON.stringify(t)});if(200!==o.status)throw new Error("server");const s=await o.json(),c=performance.now()-a;if(console.log(`Short circuit backend response received in ${c.toFixed(0)}ms`),console.log("dataJson"),console.log(s),function handleNetworkErrors(e){if(e.error&&e.diagnostic)return console.log("Short Circuit failed with diagnostic information:",e),window.DiagnosticReportDialog?new window.DiagnosticReportDialog(e.diagnostic,{message:e.message,exception:e.exception}).show():alert(`Short Circuit calculation failed: ${e.message}\n\nException: ${e.exception}`),!0;const t={line:"Line",bus:"Bus",ext_grid:"External Grid",trafo3w:"Three-winding transformer: nominal voltage does not match",overload:"One of the element is overloaded. The load flow did not converge. Contact electrisim@electrisim.com"};if(!e[0])return!1;const n=Array.isArray(e[0])?e[0][0]:e[0];if("trafo3w"===n||"overload"===n)return alert(t[n]),!0;if(t[n]){for(let r=1;r<e.length;r++)alert(`${t[n]}${e[r][0]} ${e[r][1]} = ${e[r][2]} (restriction: ${e[r][3]})\nPower Flow did not converge`);return!0}return!1}(s))return;console.log("Processing short circuit results...");const l=performance.now(),i=n.getModel();i.beginUpdate();try{Object.entries(m).forEach(([e,t])=>{s[e]&&t(s[e],n,r)})}finally{i.endUpdate()}const p=performance.now()-l;console.log(`Processed short circuit results in ${p.toFixed(0)}ms`),console.log(`Total round-trip time: ${(c+p).toFixed(0)}ms`)}catch(e){if("server"===e.message)return;alert("Error processing network data."+e+"\n \nCheck input data or contact electrisim@electrisim.com")}finally{void 0!==s&&s.spinner&&s.spinner.stop()}}("https://03dht3kc-5000.euw.devtunnels.ms/",H,a,c)}})};export const shortCircuitPandaPower=window.shortCircuitPandaPower;