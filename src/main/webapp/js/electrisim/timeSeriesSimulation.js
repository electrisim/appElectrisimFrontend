const getConnectedBusId=(e,n=!1)=>{if(n)return{busFrom:e.source?.mxObjectId?.replace("#","_"),busTo:e.target?.mxObjectId?.replace("#","_")};const o=e.edges[0];if(!o)return null;if(!o.target&&!o.source)return null;const t=o.target&&o.target.mxObjectId!==e.mxObjectId?o.target?o.target.mxObjectId:null:o.source?o.source.mxObjectId:null;if(t){const n=o.target&&o.target.mxObjectId!==e.mxObjectId?o.target:o.source;if(n&&n.value&&n.value.attributes)for(let e=0;e<n.value.attributes.length;e++)if("name"===n.value.attributes[e].nodeName)return n.value.attributes[e].nodeValue;return t.replace("#","_")}return null},getAttributesAsObject=(e,n)=>{const o={};if(!e||!e.value||!e.value.attributes)return console.warn("Cell is missing required properties"),o;const t=e.value.attributes;for(const[e,i]of Object.entries(n)){const n="object"==typeof i&&i.optional,a="object"==typeof i?i.name:i;let r=!1;for(let n=0;n<t.length;n++)if(t[n].nodeName===a){o[e]=t[n].nodeValue,r=!0;break}r||n?!r&&n&&("parallel"===e?(console.log(`⚠ ${e} not found, using default value: 1`),o[e]="1"):"df"===e?(console.log(`⚠ ${e} not found, using default value: 1.0`),o[e]="1.0"):"vector_group"===e?(console.log(`⚠ ${e} not found, using default value: Dyn11`),o[e]="Dyn11"):("vk0_percent"===e||"vkr0_percent"===e||"mag0_percent"===e||"si0_hv_partial"===e)&&(console.log(`⚠ ${e} not found, using default value: 0.0`),o[e]="0.0")):(console.warn(`Missing required attribute ${e} with name ${a}`),o[e]=null)}return o},e="External Grid",n="Generator",o="Load",t="Line";function timeSeriesSimulationPandaPower(i,a,r){let s=i;if(a.isEnabled()&&!a.isCellLocked(a.getDefaultParent())){const l=a.getModel(),d=a.getChildCells(a.getDefaultParent(),!0,!0),u={externalGrid:0,generator:0,busbar:0,load:0,line:0,transformer:0},c={simulationParameters:[],externalGrid:[],generator:[],busbar:[],load:[],line:[],transformer:[]};function tryCreateDialog(){let a=null;"undefined"!=typeof globalThis?a=globalThis.TimeSeriesSimulationDialog:"undefined"!=typeof window&&(a=window.TimeSeriesSimulationDialog),a?new a(i).show(function(i){globalThis.timeSeriesRunCount||(globalThis.timeSeriesRunCount=0),globalThis.timeSeriesRunCount++;const a=globalThis.timeSeriesRunCount,r=performance.now();console.log(`=== TIME SERIES SIMULATION #${a} STARTED ===`),new Map;const m=new Map,p=new Map,g=new Map;if(console.log("Starting fresh simulation with clean caches"),s.spinner.spin(document.body,"Waiting for time series simulation results..."),i.length>0){function getUserEmail(){try{const e=localStorage.getItem("user");if(e){const n=JSON.parse(e);if(n&&n.email)return n.email}if("function"==typeof getCurrentUser){const e=getCurrentUser();if(e&&e.email)return e.email}if(window.getCurrentUser&&"function"==typeof window.getCurrentUser){const e=window.getCurrentUser();if(e&&e.email)return e.email}if(window.authHandler&&window.authHandler.getCurrentUser){const e=window.authHandler.getCurrentUser();if(e&&e.email)return e.email}return"unknown@user.com"}catch(e){return console.warn("Error getting user email:",e),"unknown@user.com"}}const f=getUserEmail();console.log("Time Series Simulation - User email:",f),c.simulationParameters.push({typ:"TimeSeriesSimulationPandaPower Parameters",time_steps:i[0],load_profile:i[1],generation_profile:i[2],frequency:i[3],algorithm:i[4],calculate_voltage_angles:i[5],init:i[6],user_email:f});const w=performance.now();console.log(`Processing ${d.length} cells...`);const _=[],y=[];d.forEach(e=>{if(e.getStyle()?.includes("Result"))return void _.push(e);const n=(e=>{if(!e)return null;const n=e.split(";").map(e=>e.split("="));return Object.fromEntries(n)})(e.getStyle());if(!n)return;const o=n.shapeELXXX;o&&"NotEditableLine"!=o&&y.push({cell:e,style:n,componentType:o})});let h=0;const S=performance.now();if(_.length>0){console.log(`Removing ${_.length} result cells from previous simulation...`);try{l.beginUpdate(),_.forEach(e=>{const n=l.getCell(e.id);n&&(l.remove(n),h++)})}finally{l.endUpdate()}console.log(`Successfully removed ${h} result cells`)}else console.log("No result cells to remove (first run or already clean)");const v=performance.now()-S,b=performance.now()-w;console.log(`Cell processing: ${b.toFixed(2)}ms (removed ${h} result cells in ${v.toFixed(2)}ms, found ${y.length} valid cells)`);const x=performance.now();let k=0;y.forEach(({cell:i,style:a,componentType:r})=>{k++;let s,l=null;if(i.value&&i.value.attributes)for(let e=0;e<i.value.attributes.length;e++)if("name"===i.value.attributes[e].nodeName){l=i.value.attributes[e].nodeValue,console.log("Found user-friendly name in cell attributes:",l,"for cell:",i.id);break}if(!l)try{if("Bus"===r&&window.gridOptionsBus&&window.gridOptionsBus.api){const e=window.gridOptionsBus.api.getRenderedNodes();if(console.log("Bus grid data:",e),console.log("Looking for cell.id:",i.id),e&&e.length>0){const n=e[0];n&&n.data&&n.data.name&&(l=n.data.name,console.log("Found user-friendly name for bus from grid:",l))}}else if(r===o&&window.gridOptionsLoad&&window.gridOptionsLoad.api){const e=window.gridOptionsLoad.api.getRenderedNodes();if(console.log("Load grid data:",e),e&&e.length>0){const n=e[0];n&&n.data&&n.data.name&&(l=n.data.name,console.log("Found user-friendly name for load:",l))}}else if(r===n&&window.gridOptionsGenerator&&window.gridOptionsGenerator.api){const e=window.gridOptionsGenerator.api.getRenderedNodes();if(console.log("Generator grid data:",e),e&&e.length>0){const n=e[0];n&&n.data&&n.data.name&&(l=n.data.name,console.log("Found user-friendly name for generator:",l))}}else if(r===t&&window.gridOptionsLineDialog&&window.gridOptionsLineDialog.api){const e=window.gridOptionsLineDialog.api.getRenderedNodes();if(console.log("Line grid data:",e),e&&e.length>0){const n=e[0];n&&n.data&&n.data.name&&(l=n.data.name,console.log("Found user-friendly name for line:",l))}}else if(r===e&&window.gridOptionsExternalGrid&&window.gridOptionsExternalGrid.api){const e=window.gridOptionsExternalGrid.api.getRenderedNodes();if(console.log("External grid data:",e),e&&e.length>0){const n=e[0];n&&n.data&&n.data.name&&(l=n.data.name,console.log("Found user-friendly name for external grid:",l))}}}catch(e){console.warn("Could not get user-friendly name for",r,i.id,e)}switch(s="Line"===r||"DCLine"===r?{name:i.mxObjectId.replace("#","_"),userFriendlyName:l,id:i.id,bus:getConnectedBusId(i,!0)}:{name:i.mxObjectId.replace("#","_"),userFriendlyName:l,id:i.id,bus:getConnectedBusId(i)},r){case e:const a={...s,typ:"External Grid"+u.externalGrid++,...getAttributesAsObject(i,{vm_pu:"vm_pu",va_degree:"va_degree",s_sc_max_mva:"s_sc_max_mva",s_sc_min_mva:"s_sc_min_mva",rx_max:"rx_max",rx_min:"rx_min",r0x0_max:"r0x0_max",x0x_max:"x0x_max"})};c.externalGrid.push(a);break;case n:const r={...s,typ:"Generator",...getAttributesAsObject(i,{name:"name",p_mw:"p_mw",vm_pu:"vm_pu",sn_mva:"sn_mva",scaling:"scaling",vn_kv:"vn_kv",xdss_pu:"xdss_pu",rdss_ohm:"rdss_ohm",cos_phi:"cos_phi",pg_percent:"pg_percent",power_station_trafo:"power_station_trafo"})};c.generator.push(r);break;case"Bus":const l={...s,typ:"Bus"+u.busbar++,...getAttributesAsObject(i,{name:"name",vn_kv:"vn_kv"})};c.busbar.push(l);break;case o:const d={...s,typ:"Load"+u.load++,...getAttributesAsObject(i,{name:"name",p_mw:"p_mw",q_mvar:"q_mvar",const_z_percent:"const_z_percent",const_i_percent:"const_i_percent",sn_mva:"sn_mva",scaling:"scaling",type:"type"})};c.load.push(d);break;case t:const m={...s,typ:"Line"+u.line++,...getAttributesAsObject(i,{length_km:"length_km",parallel:"parallel",df:"df",r_ohm_per_km:"r_ohm_per_km",x_ohm_per_km:"x_ohm_per_km",c_nf_per_km:"c_nf_per_km",g_us_per_km:"g_us_per_km",max_i_ka:"max_i_ka",type:"type"})};c.line.push(m)}});const T=performance.now()-x;console.log(`Component processing: ${T.toFixed(2)}ms (${k} components)`);const C=[...c.simulationParameters,...c.externalGrid,...c.generator,...c.busbar,...c.load,...c.line],E=Object.assign({},C);console.log("Time Series Simulation Data:",JSON.stringify(E));const O=performance.now()-r;console.log("=== TIME SERIES PERFORMANCE SUMMARY ==="),console.log(`Run #${a} - Total processing: ${O.toFixed(2)}ms`),console.log(`Components processed: ${k}`),console.log(`Result cells removed: ${h}`),console.log(`Simulation completed. Cache sizes - cells: ${m.size}, names: ${p.size}, attributes: ${g.size}`),m.clear(),p.clear(),g.clear(),console.log("Caches cleared for next simulation"),processNetworkData("https://03dht3kc-5000.euw.devtunnels.ms/",E)}}):setTimeout(tryCreateDialog,100)}tryCreateDialog()}}async function processNetworkData(e,n,o,t){try{const o=await fetch(e,{mode:"cors",method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(200!==o.status)throw new Error("server");const t=await o.json();if(console.log("Time Series Simulation Results:",t),t.error&&t.diagnostic)return console.log("Time Series Simulation failed with diagnostic information:",t),void(window.DiagnosticReportDialog?new window.DiagnosticReportDialog(t.diagnostic).show():alert(`Time Series Simulation failed: ${t.message}\n\nException: ${t.exception}`));if(t.error)return void alert("Time Series Simulation Error: "+t.error);window.TimeSeriesSimulationResultsDialog?new window.TimeSeriesSimulationResultsDialog(t).show():alert("Time series simulation completed. Results dialog not available."),console.log("Time Series Simulation completed successfully"),setTimeout(()=>{try{"undefined"!=typeof apka&&apka.spinner&&apka.spinner.stop(),"undefined"!=typeof window&&window.apka&&window.apka.spinner&&window.apka.spinner.stop(),document.querySelectorAll('.spinner, [class*="spinner"]').forEach(e=>{"none"!==e.style.display&&(e.style.display="none",e.remove())}),document.querySelectorAll("div, span, p").forEach(e=>{e.textContent&&e.textContent.includes("Waiting for time series simulation results")&&(e.style.display="none",e.remove())}),"undefined"!=typeof apka&&apka.editor&&apka.editor.setStatus&&apka.editor.setStatus("")}catch(e){console.warn("Timeout spinner stop failed:",e)}},100)}catch(e){if("server"===e.message)return;console.error("Error processing time series simulation data:",e)}finally{try{"undefined"!=typeof apka&&apka.spinner&&apka.spinner.stop(),"undefined"!=typeof window&&window.apka&&window.apka.spinner&&window.apka.spinner.stop(),document.querySelectorAll('.spinner, [class*="spinner"]').forEach(e=>{"none"!==e.style.display&&(e.style.display="none",e.remove())}),document.querySelectorAll("div, span, p").forEach(e=>{e.textContent&&e.textContent.includes("Waiting for time series simulation results")&&(e.style.display="none",e.remove())}),"undefined"!=typeof apka&&apka.editor&&apka.editor.setStatus&&apka.editor.setStatus("")}catch(e){console.warn("Could not stop spinner:",e)}}}if("undefined"!=typeof globalThis?globalThis.timeSeriesSimulationPandaPower=timeSeriesSimulationPandaPower:"undefined"!=typeof window&&(window.timeSeriesSimulationPandaPower=timeSeriesSimulationPandaPower),"undefined"!=typeof module&&module.exports)module.exports={timeSeriesSimulationPandaPower:timeSeriesSimulationPandaPower};else if("object"==typeof exports)try{exports.timeSeriesSimulationPandaPower=timeSeriesSimulationPandaPower}catch(e){}