import{Dialog as e}from"./Dialog.js";export const defaultBusData={name:"Bus",vn_kv:0,in_service:!0,type:"b",max_vm_pu:1.1,min_vm_pu:.9};export class BusDialog extends e{constructor(e){super("Bus Parameters","Apply"),this.ui=e||window.App?.main?.editor?.editorUi,this.graph=this.ui?.editor?.graph,this.currentTab="loadflow",this.data={...defaultBusData},this.inputs=new Map,this.loadFlowParameters=[{id:"name",label:"Name",symbol:"name",description:"Name identifier for the bus",type:"text",value:this.data.name},{id:"vn_kv",label:"Nominal Voltage",symbol:"vn_kv",unit:"kV",description:"The grid voltage level at this bus (>0)",type:"number",value:this.data.vn_kv.toString(),step:"0.1",min:"0"},{id:"in_service",label:"In Service",symbol:"in_service",description:"Specifies if the bus is in service (True/False)",type:"checkbox",value:this.data.in_service},{id:"type",label:"Bus Type",symbol:"type",description:'Bus type for power flow calculation ("b" for PQ bus, "n" for auxiliary bus)',type:"select",options:["b","n"],value:this.data.type}],this.shortCircuitParameters=[],this.opfParameters=[{id:"max_vm_pu",label:"Maximum Voltage",symbol:"max_vm_pu",unit:"p.u.",description:"Maximum voltage magnitude constraint for OPF (per unit, >=0)",type:"number",value:this.data.max_vm_pu.toString(),step:"0.01",min:"0"},{id:"min_vm_pu",label:"Minimum Voltage",symbol:"min_vm_pu",unit:"p.u.",description:"Minimum voltage magnitude constraint for OPF (per unit, >=0)",type:"number",value:this.data.min_vm_pu.toString(),step:"0.01",min:"0"}]}getDescription(){return'<strong>Configure Bus Parameters</strong><br>Set parameters for network bus/node. See the <a href="https://electrisim.com/documentation#bus" target="_blank">Electrisim documentation</a>.'}show(e){this.callback=e,this.showTabDialog()}showTabDialog(){this.ui=this.ui||window.App?.main?.editor?.editorUi;const e=document.createElement("div");Object.assign(e.style,{fontFamily:"Arial, sans-serif",fontSize:"14px",lineHeight:"1.5",color:"#333",padding:"0",margin:"0",width:"100%",height:"100%",boxSizing:"border-box",display:"flex",flexDirection:"column"});const t=document.createElement("div");Object.assign(t.style,{padding:"6px 10px",backgroundColor:"#e3f2fd",border:"1px solid #bbdefb",borderRadius:"4px",fontSize:"12px",color:"#1565c0",marginBottom:"12px"}),t.innerHTML=this.getDescription(),e.appendChild(t);const i=document.createElement("div");Object.assign(i.style,{display:"flex",borderBottom:"2px solid #e9ecef",marginBottom:"16px"});const o=this.createTab("Load Flow","loadflow","loadflow"===this.currentTab),a=this.createTab("Short Circuit","shortcircuit","shortcircuit"===this.currentTab),n=this.createTab("OPF","opf","opf"===this.currentTab);i.appendChild(o),i.appendChild(a),i.appendChild(n),e.appendChild(i);const s=document.createElement("div");Object.assign(s.style,{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:"0",scrollbarWidth:"thin",scrollbarColor:"#c1c1c1 #f1f1f1",paddingRight:"8px"});const r=this.createTabContent("loadflow",this.loadFlowParameters),l=this.createTabContent("shortcircuit",this.shortCircuitParameters),d=this.createTabContent("opf",this.opfParameters);s.appendChild(r),s.appendChild(l),s.appendChild(d),e.appendChild(s);const c=document.createElement("div");Object.assign(c.style,{display:"flex",gap:"8px",justifyContent:"flex-end",marginTop:"16px",paddingTop:"16px",borderTop:"1px solid #e9ecef"});const p=this.createButton("Cancel","#6c757d","#5a6268"),u=this.createButton("Apply","#007bff","#0056b3");if(p.onclick=e=>{e.preventDefault(),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},u.onclick=e=>{e.preventDefault();const t=this.getFormValues();console.log("Bus values:",t),this.callback&&this.callback(t),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},c.appendChild(p),c.appendChild(u),e.appendChild(c),this.container=e,o.onclick=()=>this.switchTab("loadflow",o,[a,n],r,[l,d]),a.onclick=()=>this.switchTab("shortcircuit",a,[o,n],l,[r,d]),n.onclick=()=>this.switchTab("opf",n,[o,a],d,[r,l]),this.ui&&"function"==typeof this.ui.showDialog){const t=window.innerHeight-80;this.ui.showDialog(e,1e3,t,!0,!1)}else this.showModalFallback(e)}createTab(e,t,i){const o=document.createElement("div");return Object.assign(o.style,{padding:"12px 20px",cursor:"pointer",borderBottom:i?"2px solid #007bff":"2px solid transparent",backgroundColor:i?"#f8f9fa":"transparent",color:i?"#007bff":"#333",fontWeight:i?"600":"400",transition:"all 0.2s ease"}),o.textContent=e,o.setAttribute("data-tab",t),o.addEventListener("mouseenter",()=>{i||(o.style.backgroundColor="#f8f9fa",o.style.color="#007bff")}),o.addEventListener("mouseleave",()=>{i||(o.style.backgroundColor="transparent",o.style.color="#333")}),o}createTabContent(e,t){const i=document.createElement("div");if(i.dataset.tab=e,Object.assign(i.style,{display:e===this.currentTab?"block":"none"}),0===t.length){const e=document.createElement("div");return Object.assign(e.style,{padding:"20px",textAlign:"center",color:"#666",fontStyle:"italic"}),e.textContent="No parameters available for this category.",i.appendChild(e),i}const o=document.createElement("form");return Object.assign(o.style,{display:"flex",flexDirection:"column",gap:"16px"}),t.forEach(e=>{const t=document.createElement("div");Object.assign(t.style,{display:"grid",gridTemplateColumns:"1fr 200px",gap:"20px",alignItems:"start",padding:"16px",backgroundColor:"#f8f9fa",border:"1px solid #e9ecef",borderRadius:"8px",minHeight:"80px"});const i=document.createElement("div");Object.assign(i.style,{display:"flex",flexDirection:"column",gap:"4px",minWidth:"0"});const a=document.createElement("label");Object.assign(a.style,{fontWeight:"600",fontSize:"14px",color:"#495057",marginBottom:"6px",lineHeight:"1.2"}),a.textContent=e.label,a.htmlFor=e.id;const n=document.createElement("div");Object.assign(n.style,{fontSize:"12px",color:"#6c757d",lineHeight:"1.4",fontStyle:"italic",marginBottom:"4px"}),n.textContent=e.description,i.appendChild(a),i.appendChild(n);const s=document.createElement("div");let r;Object.assign(s.style,{display:"flex",alignItems:"center",justifyContent:"flex-end",minHeight:"60px",width:"200px"}),"checkbox"===e.type?(r=document.createElement("input"),r.type="checkbox",r.checked=e.value,Object.assign(r.style,{width:"24px",height:"24px",accentColor:"#007bff",cursor:"pointer",margin:"0"})):"select"===e.type?(r=document.createElement("select"),e.options.forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,t===e.value&&(i.selected=!0),r.appendChild(i)}),Object.assign(r.style,{width:"180px",padding:"10px 14px",border:"2px solid #ced4da",borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",backgroundColor:"#ffffff",boxSizing:"border-box",transition:"all 0.2s ease",outline:"none"})):(r=document.createElement("input"),r.type=e.type,r.value=e.value,Object.assign(r.style,{width:"180px",padding:"10px 14px",border:"2px solid #ced4da",borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",backgroundColor:"#ffffff",boxSizing:"border-box",transition:"all 0.2s ease",outline:"none"}),r.addEventListener("focus",()=>{r.style.borderColor="#007bff",r.style.boxShadow="0 0 0 3px rgba(0, 123, 255, 0.15)",r.style.transform="translateY(-1px)"}),r.addEventListener("blur",()=>{r.style.borderColor="#ced4da",r.style.boxShadow="none",r.style.transform="translateY(0)"}),r.addEventListener("mouseenter",()=>{r!==document.activeElement&&(r.style.borderColor="#adb5bd",r.style.backgroundColor="#f8f9fa")}),r.addEventListener("mouseleave",()=>{r!==document.activeElement&&(r.style.borderColor="#ced4da",r.style.backgroundColor="#ffffff")})),r.id=e.id,e.step&&(r.step=e.step),void 0!==e.min&&(r.min=e.min),void 0!==e.max&&(r.max=e.max),this.inputs.set(e.id,r),s.appendChild(r),t.appendChild(i),t.appendChild(s),o.appendChild(t)}),i.appendChild(o),i}switchTab(e,t,i,o,a){this.currentTab=e,t.style.borderBottom="2px solid #007bff",t.style.backgroundColor="#f8f9fa",t.style.color="#007bff",t.style.fontWeight="600",t.classList.add("active"),i.forEach(e=>{e.style.borderBottom="2px solid transparent",e.style.backgroundColor="transparent",e.style.color="#333",e.style.fontWeight="400",Object.assign(e.style,{color:"#6c757d",fontWeight:"400"}),e.classList.remove("active")}),o.style.display="block",a.forEach(e=>{e.style.display="none"})}getFormValues(){const e={};return[...this.loadFlowParameters,...this.shortCircuitParameters,...this.opfParameters].forEach(t=>{const i=this.inputs.get(t.id);i&&("number"===t.type?e[t.id]=parseFloat(i.value)||0:"checkbox"===t.type?e[t.id]=i.checked:e[t.id]=i.value)}),e}createButton(e,t,i){const o=document.createElement("button");return o.textContent=e,Object.assign(o.style,{padding:"8px 16px",backgroundColor:t,color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500",transition:"background-color 0.2s"}),o.addEventListener("mouseenter",()=>{o.style.backgroundColor=i}),o.addEventListener("mouseleave",()=>{o.style.backgroundColor=t}),o}destroy(){super.destroy(),window._globalDialogShowing&&delete window._globalDialogShowing}populateDialog(e){if(e&&e.attributes)for(let t=0;t<e.attributes.length;t++){const i=e.attributes[t],o=i.name,a=i.value,n=this.loadFlowParameters.find(e=>e.id===o);n&&(n.value,"checkbox"===n.type?n.value="true"===a||!0===a:n.value=a);const s=this.shortCircuitParameters.find(e=>e.id===o);s&&(s.value,"checkbox"===s.type?s.value="true"===a||!0===a:s.value=a);const r=this.opfParameters.find(e=>e.id===o);r&&(r.value,"checkbox"===r.type?r.value="true"===a||!0===a:r.value=a)}}}export const rowDefsBus=[{name:"Bus",vn_kv:0}];export const columnDefsBus=[{field:"name",maxWidth:150},{field:"vn_kv",headerTooltip:"The grid voltage level",maxWidth:100,valueParser:e=>parseFloat(e.newValue)||0}];export const gridOptionsBus={columnDefs:columnDefsBus,defaultColDef:{minWidth:100,editable:!0},rowData:rowDefsBus,singleClickEdit:!0,stopEditingWhenGridLosesFocus:!0};globalThis.rowDefsBus=rowDefsBus,globalThis.columnDefsBus=columnDefsBus,globalThis.gridOptionsBus=gridOptionsBus,globalThis.BusDialog=BusDialog;