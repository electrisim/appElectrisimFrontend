import{Dialog as e}from"./Dialog.js";export const defaultExternalGridData={name:"External Grid",vm_pu:1,va_degree:0,in_service:!0,s_sc_max_mva:1e6,s_sc_min_mva:0,rx_max:0,rx_min:0,r0x0_max:0,x0x_max:0,max_p_mw:0,min_p_mw:0,max_q_mvar:0,min_q_mvar:0,controllable:!1,slack_weight:1};export class ExternalGridDialog extends e{constructor(e){super("External Grid Parameters","Apply"),this.ui=e||window.App?.main?.editor?.editorUi,this.graph=this.ui?.editor?.graph,this.currentTab="loadflow",this.data={...defaultExternalGridData},this.loadFlowParameters=[{id:"name",label:"External Grid Name",description:"Name identifier for the external grid",type:"text",value:this.data.name},{id:"vm_pu",label:"Voltage Magnitude (p.u.)",description:"Voltage at the slack node in per unit (>0)",type:"number",value:this.data.vm_pu.toString(),step:"0.01",min:"0.01"},{id:"va_degree",label:"Voltage Angle (degrees)",description:"Voltage angle at the slack node in degrees. Only considered in loadflow if calculate_voltage_angles = True",type:"number",value:this.data.va_degree.toString(),step:"0.1"},{id:"in_service",label:"In Service",description:"Specifies if the external grid is in service (True/False)",type:"checkbox",value:this.data.in_service}],this.shortCircuitParameters=[{id:"s_sc_max_mva",label:"Max Short Circuit Power (MVA)",description:"Maximum short circuit apparent power to calculate internal impedance of ext_grid for short circuit calculations (>0)",type:"number",value:this.data.s_sc_max_mva.toString(),step:"1000",min:"0"},{id:"s_sc_min_mva",label:"Min Short Circuit Power (MVA)",description:"Minimum short circuit apparent power to calculate internal impedance of ext_grid for short circuit calculations (>0)",type:"number",value:this.data.s_sc_min_mva.toString(),step:"1000",min:"0"},{id:"rx_max",label:"Max R/X Ratio",description:"Maximum R/X-ratio to calculate internal impedance of ext_grid for short circuit calculations (0...1)",type:"number",value:this.data.rx_max.toString(),step:"0.01",min:"0",max:"1"},{id:"rx_min",label:"Min R/X Ratio",description:"Minimum R/X-ratio to calculate internal impedance of ext_grid for short circuit calculations (0...1)",type:"number",value:this.data.rx_min.toString(),step:"0.01",min:"0",max:"1"},{id:"r0x0_max",label:"Max R0/X0 Ratio",description:"Maximal R/X-ratio to calculate Zero sequence internal impedance of ext_grid (0...1)",type:"number",value:this.data.r0x0_max.toString(),step:"0.01",min:"0",max:"1"},{id:"x0x_max",label:"Max X0/X Ratio",description:"Maximal X0/X-ratio to calculate Zero sequence internal impedance of ext_grid (0...1)",type:"number",value:this.data.x0x_max.toString(),step:"0.01",min:"0",max:"1"}],this.opfParameters=[{id:"max_p_mw",label:"Max Active Power (MW)",description:"Maximum active power injection. Only respected for OPF calculations",type:"number",value:this.data.max_p_mw.toString(),step:"1"},{id:"min_p_mw",label:"Min Active Power (MW)",description:"Minimum active power injection. Only respected for OPF calculations",type:"number",value:this.data.min_p_mw.toString(),step:"1"},{id:"max_q_mvar",label:"Max Reactive Power (MVar)",description:"Maximum reactive power injection. Only respected for OPF calculations",type:"number",value:this.data.max_q_mvar.toString(),step:"1"},{id:"min_q_mvar",label:"Min Reactive Power (MVar)",description:"Minimum reactive power injection. Only respected for OPF calculations",type:"number",value:this.data.min_q_mvar.toString(),step:"1"},{id:"controllable",label:"Controllable",description:"Control of value limits: True = p_mw, q_mvar and vm_pu limits enforced; False = set points enforced, limits ignored",type:"checkbox",value:this.data.controllable},{id:"slack_weight",label:"Slack Weight",description:"Contribution factor for distributed slack power flow calculation (active power balancing)",type:"number",value:this.data.slack_weight.toString(),step:"0.1",min:"0"}]}getDescription(){return'<strong>Configure External Grid Parameters</strong><br>Set parameters for Load Flow, Short Circuit, and Optimal Power Flow calculations. See the <a href="https://electrisim.com/documentation#external-grid" target="_blank">Electrisim documentation</a>.'}show(e){this.callback=e,this.showTabDialog()}showTabDialog(){this.ui=this.ui||window.App?.main?.editor?.editorUi;const e=document.createElement("div");Object.assign(e.style,{fontFamily:"Arial, sans-serif",fontSize:"14px",lineHeight:"1.5",color:"#333",padding:"0",margin:"0",width:"100%",height:"100%",boxSizing:"border-box",display:"flex",flexDirection:"column"});const t=document.createElement("div");Object.assign(t.style,{padding:"6px 10px",backgroundColor:"#e3f2fd",border:"1px solid #bbdefb",borderRadius:"4px",fontSize:"12px",color:"#1565c0",marginBottom:"12px"}),t.innerHTML=this.getDescription(),e.appendChild(t);const i=document.createElement("div");Object.assign(i.style,{display:"flex",borderBottom:"2px solid #e9ecef",marginBottom:"16px"});const a=this.createTab("Load Flow","loadflow","loadflow"===this.currentTab),o=this.createTab("Short Circuit","shortcircuit","shortcircuit"===this.currentTab),r=this.createTab("OPF","opf","opf"===this.currentTab);i.appendChild(a),i.appendChild(o),i.appendChild(r),e.appendChild(i);const n=document.createElement("div");Object.assign(n.style,{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:"0",scrollbarWidth:"thin",scrollbarColor:"#c1c1c1 #f1f1f1",paddingRight:"8px"});const l=this.createTabContent("loadflow",this.loadFlowParameters),s=this.createTabContent("shortcircuit",this.shortCircuitParameters),d=this.createTabContent("opf",this.opfParameters);n.appendChild(l),n.appendChild(s),n.appendChild(d),e.appendChild(n);const c=document.createElement("div");Object.assign(c.style,{display:"flex",gap:"8px",justifyContent:"flex-end",marginTop:"16px",paddingTop:"16px",borderTop:"1px solid #e9ecef"});const p=this.createButton("Cancel","#6c757d","#5a6268"),m=this.createButton("Apply","#007bff","#0056b3");if(p.onclick=e=>{e.preventDefault(),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},m.onclick=e=>{e.preventDefault();const t=this.getFormValues();console.log("External Grid values:",t),this.callback&&this.callback(t),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},c.appendChild(p),c.appendChild(m),e.appendChild(c),this.container=e,a.onclick=()=>this.switchTab("loadflow",a,[o,r],l,[s,d]),o.onclick=()=>this.switchTab("shortcircuit",o,[a,r],s,[l,d]),r.onclick=()=>this.switchTab("opf",r,[a,o],d,[l,s]),this.ui&&"function"==typeof this.ui.showDialog){const t=window.innerHeight-80;this.ui.showDialog(e,1e3,t,!0,!1)}else this.showModalFallback(e)}createTab(e,t,i){const a=document.createElement("div");return Object.assign(a.style,{padding:"12px 20px",cursor:"pointer",borderBottom:i?"2px solid #007bff":"2px solid transparent",backgroundColor:i?"#f8f9fa":"transparent",color:i?"#007bff":"#6c757d",fontWeight:i?"600":"400",transition:"all 0.2s ease",userSelect:"none"}),a.textContent=e,a.dataset.tab=t,a.addEventListener("mouseenter",()=>{a.classList.contains("active")||(a.style.backgroundColor="#f8f9fa")}),a.addEventListener("mouseleave",()=>{a.classList.contains("active")||(a.style.backgroundColor="transparent")}),i&&a.classList.add("active"),a}createTabContent(e,t){const i=document.createElement("div");i.dataset.tab=e,Object.assign(i.style,{display:e===this.currentTab?"block":"none"});const a=document.createElement("form");return Object.assign(a.style,{display:"flex",flexDirection:"column",gap:"16px"}),t.forEach(e=>{const t=document.createElement("div");Object.assign(t.style,{display:"grid",gridTemplateColumns:"1fr 200px",gap:"20px",alignItems:"start",padding:"16px",backgroundColor:"#f8f9fa",border:"1px solid #e9ecef",borderRadius:"8px",minHeight:"80px"});const i=document.createElement("div");Object.assign(i.style,{display:"flex",flexDirection:"column",justifyContent:"center",minHeight:"60px"});const o=document.createElement("label");Object.assign(o.style,{fontWeight:"600",fontSize:"14px",color:"#495057",marginBottom:"6px",lineHeight:"1.2"}),o.textContent=e.label,o.htmlFor=e.id;const r=document.createElement("div");Object.assign(r.style,{fontSize:"12px",color:"#6c757d",lineHeight:"1.4",fontStyle:"italic",marginBottom:"4px"}),r.textContent=e.description,i.appendChild(o),i.appendChild(r);const n=document.createElement("div");Object.assign(n.style,{display:"flex",alignItems:"center",justifyContent:"flex-end",minHeight:"60px",width:"200px"});const l=document.createElement("input");l.type=e.type,l.id=e.id,"checkbox"===e.type?(l.checked=e.value,Object.assign(l.style,{width:"24px",height:"24px",accentColor:"#007bff",cursor:"pointer",margin:"0"})):(l.value=e.value,Object.assign(l.style,{width:"180px",padding:"10px 14px",border:"2px solid #ced4da",borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",backgroundColor:"#ffffff",boxSizing:"border-box",transition:"all 0.2s ease",outline:"none"}),l.addEventListener("focus",()=>{l.style.borderColor="#007bff",l.style.boxShadow="0 0 0 3px rgba(0, 123, 255, 0.15)",l.style.transform="translateY(-1px)"}),l.addEventListener("blur",()=>{l.style.borderColor="#ced4da",l.style.boxShadow="none",l.style.transform="translateY(0)"}),l.addEventListener("mouseenter",()=>{l!==document.activeElement&&(l.style.borderColor="#adb5bd",l.style.backgroundColor="#f8f9fa")}),l.addEventListener("mouseleave",()=>{l!==document.activeElement&&(l.style.borderColor="#ced4da",l.style.backgroundColor="#ffffff")})),e.step&&(l.step=e.step),void 0!==e.min&&(l.min=e.min),void 0!==e.max&&(l.max=e.max),this.inputs.set(e.id,l),n.appendChild(l),t.appendChild(i),t.appendChild(n),a.appendChild(t)}),i.appendChild(a),i}createButton(e,t,i){const a=document.createElement("button");return a.textContent=e,Object.assign(a.style,{padding:"8px 16px",backgroundColor:t,color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500",transition:"background-color 0.2s"}),a.addEventListener("mouseenter",()=>{a.style.backgroundColor=i}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor=t}),a}switchTab(e,t,i,a,o){this.currentTab=e,Object.assign(t.style,{borderBottom:"2px solid #007bff",backgroundColor:"#f8f9fa",color:"#007bff",fontWeight:"600"}),t.classList.add("active"),i.forEach(e=>{Object.assign(e.style,{borderBottom:"2px solid transparent",backgroundColor:"transparent",color:"#6c757d",fontWeight:"400"}),e.classList.remove("active")}),a.style.display="block",o.forEach(e=>{e.style.display="none"})}getFormValues(){const e={};return[...this.loadFlowParameters,...this.shortCircuitParameters,...this.opfParameters].forEach(t=>{const i=this.inputs.get(t.id);i&&("number"===t.type?e[t.id]=parseFloat(i.value)||0:"checkbox"===t.type?e[t.id]=i.checked:e[t.id]=i.value)}),e}destroy(){super.destroy(),window._globalDialogShowing&&delete window._globalDialogShowing,console.log("External Grid dialog destroyed and flags cleared")}}export const rowDefsExternalGrid=[defaultExternalGridData];export const columnDefsExternalGrid=[{field:"name",maxWidth:200},{field:"vm_pu",headerTooltip:"voltage at the slack node in per unit",maxWidth:100},{field:"va_degree",headerTooltip:"voltage angle at the slack node in degrees. Only considered in loadflow if calculate_voltage_angles = True",maxWidth:100},{field:"s_sc_max_mva",headerTooltip:"maximal short circuit apparent power to calculate internal impedance of ext_grid for short circuit calculations",maxWidth:160},{field:"s_sc_min_mva",headerTooltip:"minimal short circuit apparent power to calculate internal impedance of ext_grid for short circuit calculations",maxWidth:160},{field:"rx_max",headerTooltip:"maximal R/X-ratio to calculate internal impedance of ext_grid for short circuit calculations",maxWidth:120},{field:"rx_min",headerTooltip:"minimal R/X-ratio to calculate internal impedance of ext_grid for short circuit calculations",maxWidth:100},{field:"r0x0_max",headerTooltip:"maximal R/X-ratio to calculate Zero sequence internal impedance of ext_grid",maxWidth:100},{field:"x0x_max",headerTooltip:"maximal X0/X-ratio to calculate Zero sequence internal impedance of ext_grid",maxWidth:120}];export const gridOptionsExternalGrid={columnDefs:columnDefsExternalGrid,defaultColDef:{minWidth:100,editable:!0},rowData:rowDefsExternalGrid,singleClickEdit:!0,stopEditingWhenGridLosesFocus:!0};globalThis.gridOptionsExternalGrid=gridOptionsExternalGrid,globalThis.rowDefsExternalGrid=rowDefsExternalGrid,globalThis.columnDefsExternalGrid=columnDefsExternalGrid,globalThis.ExternalGridDialog=ExternalGridDialog;