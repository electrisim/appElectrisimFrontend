import{Dialog as e}from"./Dialog.js";export const defaultStaticGeneratorData={name:"Static Generator",p_mw:0,q_mvar:0,sn_mva:0,scaling:1,type:"wye",k:0,rx:0,generator_type:"async",lrc_pu:0,max_ik_ka:0,kappa:0,current_source:!0,in_service:!0};export class StaticGeneratorDialog extends e{constructor(e){super("Static Generator Parameters","Apply"),this.ui=e||window.App?.main?.editor?.editorUi,this.graph=this.ui?.editor?.graph,this.currentTab="power",this.data={...defaultStaticGeneratorData},this.inputs=new Map,this.powerParameters=[{id:"name",label:"Generator Name",description:"Name identifier for the static generator",type:"text",value:this.data.name},{id:"p_mw",label:"Active Power (MW)",description:"The active power of the static generator (positive for generation!)",type:"number",value:this.data.p_mw.toString(),step:"0.1"},{id:"q_mvar",label:"Reactive Power (MVar)",description:"The reactive power of the static generator",type:"number",value:this.data.q_mvar.toString(),step:"0.1"}],this.ratingParameters=[{id:"sn_mva",label:"Nominal Power (MVA)",description:"Nominal power of the static generator",type:"number",value:this.data.sn_mva.toString(),step:"0.1",min:"0"},{id:"scaling",label:"Scaling Factor",description:"An OPTIONAL scaling factor to be set customly. Multiplies with p_mw and q_mvar",type:"number",value:this.data.scaling.toString(),step:"0.1",min:"0"},{id:"type",label:"Connection Type",description:"Type of generator connection",type:"select",value:this.data.type,options:["wye","delta"]}],this.shortCircuitParameters=[{id:"k",label:"Current Ratio (k)",description:"Ratio of nominal current to short circuit current",type:"number",value:this.data.k.toString(),step:"0.01",min:"0"},{id:"rx",label:"R/X Ratio",description:"R/X ratio for short circuit impedance. Only relevant if type is specified as motor so that sgen is treated as asynchronous motor.",type:"number",value:this.data.rx.toString(),step:"0.01"},{id:"generator_type",label:"Generator Type",description:'Can be one of "current_source" (full size converter), "async" (asynchronous generator), or "async_doubly_fed" (doubly fed asynchronous generator, DFIG).',type:"select",value:this.data.generator_type,options:["current_source","async","async_doubly_fed"]}],this.advancedParameters=[{id:"lrc_pu",label:"Locked Rotor Current (p.u.)",description:'Locked rotor current in relation to the rated generator current. Relevant if the generator_type is "async".',type:"number",value:this.data.lrc_pu.toString(),step:"0.01",min:"0"},{id:"max_ik_ka",label:"Max Short-Circuit Current (kA)",description:'The highest instantaneous short-circuit value in case of a three-phase short-circuit (provided by the manufacturer). Relevant if the generator_type is "async_doubly_fed".',type:"number",value:this.data.max_ik_ka.toString(),step:"0.1",min:"0"},{id:"kappa",label:"Peak Factor (κ)",description:'The factor for the calculation of the peak short-circuit current, referred to the high-voltage side (provided by the manufacturer). Relevant if the generator_type is "async_doubly_fed".',type:"number",value:this.data.kappa.toString(),step:"0.01",min:"0"},{id:"current_source",label:"Current Source Model",description:"Model this sgen as a current source during short-circuit calculations; useful in some cases, for example the simulation of full-size converters per IEC 60909-0:2016.",type:"checkbox",value:this.data.current_source},{id:"in_service",label:"In Service",description:"Specifies if the static generator is in service (True/False)",type:"checkbox",value:this.data.in_service}]}getDescription(){return'<strong>Configure Static Generator Parameters</strong><br>Set parameters for static generator with power flow and short-circuit capabilities. See the <a href="https://electrisim.com/documentation#static-generator" target="_blank">Electrisim documentation</a>.'}show(e){this.callback=e,this.showTabDialog()}showTabDialog(){this.ui=this.ui||window.App?.main?.editor?.editorUi;const e=document.createElement("div");Object.assign(e.style,{fontFamily:"Arial, sans-serif",fontSize:"14px",lineHeight:"1.5",color:"#333",padding:"0",margin:"0",width:"100%",height:"100%",boxSizing:"border-box",display:"flex",flexDirection:"column"});const t=document.createElement("div");Object.assign(t.style,{padding:"6px 10px",backgroundColor:"#e3f2fd",border:"1px solid #bbdefb",borderRadius:"4px",fontSize:"12px",color:"#1565c0",marginBottom:"12px"}),t.innerHTML=this.getDescription(),e.appendChild(t);const a=document.createElement("div");Object.assign(a.style,{display:"flex",borderBottom:"2px solid #e9ecef",marginBottom:"16px"});const r=this.createTab("Power","power","power"===this.currentTab),o=this.createTab("Rating","rating","rating"===this.currentTab),i=this.createTab("Short Circuit","shortcircuit","shortcircuit"===this.currentTab),n=this.createTab("Advanced","advanced","advanced"===this.currentTab);a.appendChild(r),a.appendChild(o),a.appendChild(i),a.appendChild(n),e.appendChild(a);const s=document.createElement("div");Object.assign(s.style,{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:"0",scrollbarWidth:"thin",scrollbarColor:"#c1c1c1 #f1f1f1",paddingRight:"8px"});const c=this.createTabContent("power",this.powerParameters),l=this.createTabContent("rating",this.ratingParameters),d=this.createTabContent("shortcircuit",this.shortCircuitParameters),p=this.createTabContent("advanced",this.advancedParameters);s.appendChild(c),s.appendChild(l),s.appendChild(d),s.appendChild(p),e.appendChild(s);const u=document.createElement("div");Object.assign(u.style,{display:"flex",gap:"8px",justifyContent:"flex-end",marginTop:"16px",paddingTop:"16px",borderTop:"1px solid #e9ecef"});const h=this.createButton("Cancel","#6c757d","#5a6268"),f=this.createButton("Apply","#007bff","#0056b3");if(h.onclick=e=>{e.preventDefault(),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},f.onclick=e=>{e.preventDefault();const t=this.getFormValues();console.log("Static Generator values:",t),this.callback&&this.callback(t),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},u.appendChild(h),u.appendChild(f),e.appendChild(u),this.container=e,r.onclick=()=>this.switchTab("power",r,[o,i,n],c,[l,d,p]),o.onclick=()=>this.switchTab("rating",o,[r,i,n],l,[c,d,p]),i.onclick=()=>this.switchTab("shortcircuit",i,[r,o,n],d,[c,l,p]),n.onclick=()=>this.switchTab("advanced",n,[r,o,i],p,[c,l,d]),this.ui&&"function"==typeof this.ui.showDialog){const t=window.innerHeight-80;this.ui.showDialog(e,1e3,t,!0,!1)}else this.showModalFallback(e)}createTab(e,t,a){const r=document.createElement("div");return Object.assign(r.style,{padding:"12px 20px",cursor:"pointer",borderBottom:a?"2px solid #007bff":"2px solid transparent",backgroundColor:a?"#f8f9fa":"transparent",color:a?"#007bff":"#6c757d",fontWeight:a?"600":"400",transition:"all 0.2s ease",userSelect:"none"}),r.textContent=e,r.dataset.tab=t,r.addEventListener("mouseenter",()=>{r.classList.contains("active")||(r.style.backgroundColor="#f8f9fa")}),r.addEventListener("mouseleave",()=>{r.classList.contains("active")||(r.style.backgroundColor="transparent")}),a&&r.classList.add("active"),r}createTabContent(e,t){const a=document.createElement("div");a.dataset.tab=e,Object.assign(a.style,{display:e===this.currentTab?"block":"none"});const r=document.createElement("form");return Object.assign(r.style,{display:"flex",flexDirection:"column",gap:"16px"}),t.forEach(e=>{const t=document.createElement("div");Object.assign(t.style,{display:"grid",gridTemplateColumns:"1fr 200px",gap:"20px",alignItems:"start",padding:"16px",backgroundColor:"#f8f9fa",border:"1px solid #e9ecef",borderRadius:"8px",minHeight:"80px"});const a=document.createElement("div");Object.assign(a.style,{display:"flex",flexDirection:"column",justifyContent:"center",minHeight:"60px"});const o=document.createElement("label");Object.assign(o.style,{fontWeight:"600",fontSize:"14px",color:"#495057",marginBottom:"6px",lineHeight:"1.2"}),o.textContent=e.label,o.htmlFor=e.id;const i=document.createElement("div");Object.assign(i.style,{fontSize:"12px",color:"#6c757d",lineHeight:"1.4",fontStyle:"italic",marginBottom:"4px"}),i.textContent=e.description,a.appendChild(o),a.appendChild(i);const n=document.createElement("div");let s;Object.assign(n.style,{display:"flex",alignItems:"center",justifyContent:"flex-end",minHeight:"60px",width:"200px"}),"checkbox"===e.type?(s=document.createElement("input"),s.type="checkbox",s.checked=e.value,Object.assign(s.style,{width:"24px",height:"24px",accentColor:"#007bff",cursor:"pointer",margin:"0"})):"select"===e.type?(s=document.createElement("select"),e.options.forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=t.charAt(0).toUpperCase()+t.slice(1),t===e.value&&(a.selected=!0),s.appendChild(a)}),Object.assign(s.style,{width:"180px",padding:"10px 14px",border:"2px solid #ced4da",borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",backgroundColor:"#ffffff",boxSizing:"border-box",transition:"all 0.2s ease",outline:"none",cursor:"pointer"})):(s=document.createElement("input"),s.type=e.type,s.value=e.value,Object.assign(s.style,{width:"180px",padding:"10px 14px",border:"2px solid #ced4da",borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",backgroundColor:"#ffffff",boxSizing:"border-box",transition:"all 0.2s ease",outline:"none"}),s.addEventListener("focus",()=>{s.style.borderColor="#007bff",s.style.boxShadow="0 0 0 3px rgba(0, 123, 255, 0.15)",s.style.transform="translateY(-1px)"}),s.addEventListener("blur",()=>{s.style.borderColor="#ced4da",s.style.boxShadow="none",s.style.transform="translateY(0)"}),s.addEventListener("mouseenter",()=>{s!==document.activeElement&&(s.style.borderColor="#adb5bd",s.style.backgroundColor="#f8f9fa")}),s.addEventListener("mouseleave",()=>{s!==document.activeElement&&(s.style.borderColor="#ced4da",s.style.backgroundColor="#ffffff")})),"number"===e.type&&(e.step&&(s.step=e.step),void 0!==e.min&&(s.min=e.min),void 0!==e.max&&(s.max=e.max)),s.id=e.id,this.inputs.set(e.id,s),n.appendChild(s),t.appendChild(a),t.appendChild(n),r.appendChild(t)}),a.appendChild(r),a}createButton(e,t,a){const r=document.createElement("button");return r.textContent=e,Object.assign(r.style,{padding:"8px 16px",backgroundColor:t,color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500",transition:"background-color 0.2s"}),r.addEventListener("mouseenter",()=>{r.style.backgroundColor=a}),r.addEventListener("mouseleave",()=>{r.style.backgroundColor=t}),r}switchTab(e,t,a,r,o){this.currentTab=e,Object.assign(t.style,{borderBottom:"2px solid #007bff",backgroundColor:"#f8f9fa",color:"#007bff",fontWeight:"600"}),t.classList.add("active"),a.forEach(e=>{Object.assign(e.style,{borderBottom:"2px solid transparent",backgroundColor:"transparent",color:"#6c757d",fontWeight:"400"}),e.classList.remove("active")}),r.style.display="block",o.forEach(e=>{e.style.display="none"})}getFormValues(){const e={};return[...this.powerParameters,...this.ratingParameters,...this.shortCircuitParameters,...this.advancedParameters].forEach(t=>{const a=this.inputs.get(t.id);a&&("number"===t.type?e[t.id]=parseFloat(a.value)||0:"checkbox"===t.type?e[t.id]=a.checked:(t.type,e[t.id]=a.value))}),e}destroy(){super.destroy(),window._globalDialogShowing&&delete window._globalDialogShowing,console.log("Static Generator dialog destroyed and flags cleared")}populateDialog(e){if(console.log("=== StaticGeneratorDialog.populateDialog called ==="),console.log("Cell data:",e),console.log("Initial parameter values:"),[...this.powerParameters,...this.ratingParameters,...this.shortCircuitParameters,...this.advancedParameters].forEach(e=>{console.log(`  ${e.id}: ${e.value} (${e.type})`)}),e&&e.attributes){console.log(`Found ${e.attributes.length} attributes to process`);for(let t=0;t<e.attributes.length;t++){const a=e.attributes[t],r=a.name,o=a.value;console.log(`Processing attribute: ${r} = ${o}`);const i=this.powerParameters.find(e=>e.id===r);if(i){const e=i.value;"checkbox"===i.type?i.value="true"===o||!0===o:i.value=o,console.log(`  Updated power ${r}: ${e} → ${i.value}`)}const n=this.ratingParameters.find(e=>e.id===r);if(n){const e=n.value;"checkbox"===n.type?n.value="true"===o||!0===o:n.value=o,console.log(`  Updated rating ${r}: ${e} → ${n.value}`)}const s=this.shortCircuitParameters.find(e=>e.id===r);if(s){const e=s.value;"checkbox"===s.type?s.value="true"===o||!0===o:s.value=o,console.log(`  Updated shortCircuit ${r}: ${e} → ${s.value}`)}const c=this.advancedParameters.find(e=>e.id===r);if(c){const e=c.value;"checkbox"===c.type?c.value="true"===o||!0===o:c.value=o,console.log(`  Updated advanced ${r}: ${e} → ${c.value}`)}i||n||s||c||console.log(`  WARNING: No parameter found for attribute ${r}`)}}else console.log("No cell data or attributes found");console.log("Final parameter values:"),[...this.powerParameters,...this.ratingParameters,...this.shortCircuitParameters,...this.advancedParameters].forEach(e=>{console.log(`  ${e.id}: ${e.value} (${e.type})`)}),console.log("=== StaticGeneratorDialog.populateDialog completed ===")}}export const rowDefsStaticGenerator=[defaultStaticGeneratorData];export const columnDefsStaticGenerator=[{field:"name",headerTooltip:"Name of the static generator",maxWidth:150},{field:"p_mw",headerTooltip:"The active power of the static generator (positive for generation!)",maxWidth:120,valueParser:"numberParser"},{field:"q_mvar",headerTooltip:"The reactive power of the static generator",maxWidth:120,valueParser:"numberParser"},{field:"sn_mva",headerTooltip:"Nominal power of the static generator",maxWidth:120,valueParser:"numberParser"},{field:"scaling",headerTooltip:"An OPTIONAL scaling factor to be set customly. Multiplies with p_mw and q_mvar",maxWidth:140,valueParser:"numberParser"},{field:"type",headerTooltip:"Type of generator connection",maxWidth:120},{field:"k",headerTooltip:"Ratio of nominal current to short circuit current",maxWidth:120,valueParser:"numberParser"},{field:"rx",headerTooltip:"R/X ratio for short circuit impedance. Only relevant if type is specified as motor so that sgen is treated as asynchronous motor.",maxWidth:140,valueParser:"numberParser"},{field:"generator_type",headerTooltip:'Can be one of "current_source" (full size converter), "async" (asynchronous generator), or "async_doubly_fed" (doubly fed asynchronous generator, DFIG).',maxWidth:160},{field:"lrc_pu",headerTooltip:'Locked rotor current in relation to the rated generator current. Relevant if the generator_type is "async".',maxWidth:140,valueParser:"numberParser"},{field:"max_ik_ka",headerTooltip:'The highest instantaneous short-circuit value in case of a three-phase short-circuit (provided by the manufacturer). Relevant if the generator_type is "async_doubly_fed".',maxWidth:160,valueParser:"numberParser"},{field:"kappa",headerTooltip:'The factor for the calculation of the peak short-circuit current, referred to the high-voltage side (provided by the manufacturer). Relevant if the generator_type is "async_doubly_fed".',maxWidth:160,valueParser:"numberParser"},{field:"current_source",headerTooltip:"Model this sgen as a current source during short-circuit calculations; useful in some cases, for example the simulation of full-size converters per IEC 60909-0:2016.",maxWidth:140},{field:"in_service",headerTooltip:"Specifies if the static generator is in service (True/False)",maxWidth:100}];export const gridOptionsStaticGenerator={columnDefs:columnDefsStaticGenerator,defaultColDef:{minWidth:100,editable:!0},rowData:rowDefsStaticGenerator,singleClickEdit:!0,stopEditingWhenGridLosesFocus:!0};globalThis.gridOptionsStaticGenerator=gridOptionsStaticGenerator,globalThis.rowDefsStaticGenerator=rowDefsStaticGenerator,globalThis.columnDefsStaticGenerator=columnDefsStaticGenerator,globalThis.StaticGeneratorDialog=StaticGeneratorDialog;