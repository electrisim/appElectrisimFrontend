const getConnectedBusId=(e,o=!1)=>{if(o)return{busFrom:e.source?.mxObjectId?.replace("#","_"),busTo:e.target?.mxObjectId?.replace("#","_")};const n=e.edges[0];if(!n)return null;if(!n.target&&!n.source)return null;const t=n.target&&n.target.mxObjectId!==e.mxObjectId?n.target?n.target.mxObjectId:null:n.source?n.source.mxObjectId:null;if(t){const o=n.target&&n.target.mxObjectId!==e.mxObjectId?n.target:n.source;if(o&&o.value&&o.value.attributes)for(let e=0;e<o.value.attributes.length;e++)if("name"===o.value.attributes[e].nodeName)return o.value.attributes[e].nodeValue;return t.replace("#","_")}return null},getAttributesAsObject=(e,o)=>{const n={};if(!e||!e.value||!e.value.attributes)return console.warn("Cell is missing required properties"),n;const t=e.value.attributes;for(const[e,r]of Object.entries(o)){const o="object"==typeof r&&r.optional,a="object"==typeof r?r.name:r;let l=!1;for(let o=0;o<t.length;o++)if(t[o].nodeName===a){n[e]=t[o].nodeValue,l=!0;break}l||o?!l&&o&&("parallel"===e?(console.log(`⚠ ${e} not found, using default value: 1`),n[e]="1"):"df"===e?(console.log(`⚠ ${e} not found, using default value: 1.0`),n[e]="1.0"):"vector_group"===e?(console.log(`⚠ ${e} not found, using default value: Dyn11`),n[e]="Dyn11"):("vk0_percent"===e||"vkr0_percent"===e||"mag0_percent"===e||"si0_hv_partial"===e)&&(console.log(`⚠ ${e} not found, using default value: 0.0`),n[e]="0.0")):(console.warn(`Missing required attribute ${e} with name ${a}`),n[e]=null)}return n},e="External Grid",o="Generator",n="Load",t="Line";function controllerSimulationPandaPower(r,a,l){let i=r;if(a.isEnabled()&&!a.isCellLocked(a.getDefaultParent())){const s=a.getModel(),d=a.getChildCells(a.getDefaultParent(),!0,!0),c={externalGrid:0,generator:0,busbar:0,load:0,line:0,transformer:0},u={simulationParameters:[],externalGrid:[],generator:[],busbar:[],load:[],line:[],transformer:[]};function tryCreateDialog(){let a=null;"undefined"!=typeof globalThis?a=globalThis.ControllerSimulationDialog:"undefined"!=typeof window&&(a=window.ControllerSimulationDialog),a?new a(r).show(function(r){globalThis.controllerRunCount||(globalThis.controllerRunCount=0),globalThis.controllerRunCount++;const a=globalThis.controllerRunCount,l=performance.now();console.log(`=== CONTROLLER SIMULATION #${a} STARTED ===`),new Map;const p=new Map,m=new Map,g=new Map;if(console.log("Starting fresh simulation with clean caches"),i.spinner.spin(document.body,"Waiting for controller simulation results..."),r.length>0){function getUserEmail(){try{const e=localStorage.getItem("user");if(e){const o=JSON.parse(e);if(o&&o.email)return o.email}if("function"==typeof getCurrentUser){const e=getCurrentUser();if(e&&e.email)return e.email}if(window.getCurrentUser&&"function"==typeof window.getCurrentUser){const e=window.getCurrentUser();if(e&&e.email)return e.email}if(window.authHandler&&window.authHandler.getCurrentUser){const e=window.authHandler.getCurrentUser();if(e&&e.email)return e.email}return"unknown@user.com"}catch(e){return console.warn("Error getting user email:",e),"unknown@user.com"}}const f=getUserEmail();console.log("Controller Simulation - User email:",f),u.simulationParameters.push({typ:"ControllerSimulationPandaPower Parameters",voltage_control:r[0],tap_control:r[1],discrete_tap_control:r[2],continuous_tap_control:r[3],frequency:r[4],algorithm:r[5],calculate_voltage_angles:r[6],init:r[7],user_email:f});const w=performance.now();console.log(`Processing ${d.length} cells...`);const _=[],y=[];d.forEach(e=>{if(e.getStyle()?.includes("Result"))return void _.push(e);const o=(e=>{if(!e)return null;const o=e.split(";").map(e=>e.split("="));return Object.fromEntries(o)})(e.getStyle());if(!o)return;const n=o.shapeELXXX;n&&"NotEditableLine"!=n&&y.push({cell:e,style:o,componentType:n})});let h=0;const v=performance.now();if(_.length>0){console.log(`Removing ${_.length} result cells from previous simulation...`);try{s.beginUpdate(),_.forEach(e=>{const o=s.getCell(e.id);o&&(s.remove(o),h++)})}finally{s.endUpdate()}console.log(`Successfully removed ${h} result cells`)}else console.log("No result cells to remove (first run or already clean)");const b=performance.now()-v,x=performance.now()-w;console.log(`Cell processing: ${x.toFixed(2)}ms (removed ${h} result cells in ${b.toFixed(2)}ms, found ${y.length} valid cells)`);const k=performance.now();let C=0;y.forEach(({cell:r,style:a,componentType:l})=>{C++;let i,s=null;if(r.value&&r.value.attributes)for(let e=0;e<r.value.attributes.length;e++)if("name"===r.value.attributes[e].nodeName){s=r.value.attributes[e].nodeValue,console.log("Found user-friendly name in cell attributes:",s,"for cell:",r.id);break}if(!s)try{if("Bus"===l&&window.gridOptionsBus&&window.gridOptionsBus.api){const e=window.gridOptionsBus.api.getRenderedNodes();if(console.log("Bus grid data:",e),console.log("Looking for cell.id:",r.id),e&&e.length>0){const o=e[0];o&&o.data&&o.data.name&&(s=o.data.name,console.log("Found user-friendly name for bus from grid:",s))}}else if(l===n&&window.gridOptionsLoad&&window.gridOptionsLoad.api){const e=window.gridOptionsLoad.api.getRenderedNodes();if(console.log("Load grid data:",e),e&&e.length>0){const o=e[0];o&&o.data&&o.data.name&&(s=o.data.name,console.log("Found user-friendly name for load:",s))}}else if(l===o&&window.gridOptionsGenerator&&window.gridOptionsGenerator.api){const e=window.gridOptionsGenerator.api.getRenderedNodes();if(console.log("Generator grid data:",e),e&&e.length>0){const o=e[0];o&&o.data&&o.data.name&&(s=o.data.name,console.log("Found user-friendly name for generator:",s))}}else if(l===t&&window.gridOptionsLineDialog&&window.gridOptionsLineDialog.api){const e=window.gridOptionsLineDialog.api.getRenderedNodes();if(console.log("Line grid data:",e),e&&e.length>0){const o=e[0];o&&o.data&&o.data.name&&(s=o.data.name,console.log("Found user-friendly name for line:",s))}}else if(l===e&&window.gridOptionsExternalGrid&&window.gridOptionsExternalGrid.api){const e=window.gridOptionsExternalGrid.api.getRenderedNodes();if(console.log("External grid data:",e),e&&e.length>0){const o=e[0];o&&o.data&&o.data.name&&(s=o.data.name,console.log("Found user-friendly name for external grid:",s))}}}catch(e){console.warn("Could not get user-friendly name for",l,r.id,e)}switch(i="Line"===l||"DCLine"===l?{name:r.mxObjectId.replace("#","_"),userFriendlyName:s,id:r.id,bus:getConnectedBusId(r,!0)}:{name:r.mxObjectId.replace("#","_"),userFriendlyName:s,id:r.id,bus:getConnectedBusId(r)},l){case e:const a={...i,typ:"External Grid"+c.externalGrid++,...getAttributesAsObject(r,{vm_pu:"vm_pu",va_degree:"va_degree",s_sc_max_mva:"s_sc_max_mva",s_sc_min_mva:"s_sc_min_mva",rx_max:"rx_max",rx_min:"rx_min",r0x0_max:"r0x0_max",x0x_max:"x0x_max"})};u.externalGrid.push(a);break;case o:const l={...i,typ:"Generator",...getAttributesAsObject(r,{name:"name",p_mw:"p_mw",vm_pu:"vm_pu",sn_mva:"sn_mva",scaling:"scaling",vn_kv:"vn_kv",xdss_pu:"xdss_pu",rdss_ohm:"rdss_ohm",cos_phi:"cos_phi",pg_percent:"pg_percent",power_station_trafo:"power_station_trafo"})};u.generator.push(l);break;case"Bus":const s={...i,typ:"Bus"+c.busbar++,...getAttributesAsObject(r,{name:"name",vn_kv:"vn_kv"})};u.busbar.push(s);break;case n:const d={...i,typ:"Load"+c.load++,...getAttributesAsObject(r,{name:"name",p_mw:"p_mw",q_mvar:"q_mvar",const_z_percent:"const_z_percent",const_i_percent:"const_i_percent",sn_mva:"sn_mva",scaling:"scaling",type:"type"})};u.load.push(d);break;case t:const p={...i,typ:"Line"+c.line++,...getAttributesAsObject(r,{length_km:"length_km",parallel:"parallel",df:"df",r_ohm_per_km:"r_ohm_per_km",x_ohm_per_km:"x_ohm_per_km",c_nf_per_km:"c_nf_per_km",g_us_per_km:"g_us_per_km",max_i_ka:"max_i_ka",type:"type"})};u.line.push(p)}});const S=performance.now()-k;console.log(`Component processing: ${S.toFixed(2)}ms (${C} components)`);const O=[...u.simulationParameters,...u.externalGrid,...u.generator,...u.busbar,...u.load,...u.line],E=Object.assign({},O);console.log("Controller Simulation Data:",JSON.stringify(E));const P=performance.now()-l;console.log("=== CONTROLLER SIMULATION PERFORMANCE SUMMARY ==="),console.log(`Run #${a} - Total processing: ${P.toFixed(2)}ms`),console.log(`Components processed: ${C}`),console.log(`Result cells removed: ${h}`),console.log(`Simulation completed. Cache sizes - cells: ${p.size}, names: ${m.size}, attributes: ${g.size}`),p.clear(),m.clear(),g.clear(),console.log("Caches cleared for next simulation"),processNetworkData("https://03dht3kc-5000.euw.devtunnels.ms/",E)}}):setTimeout(tryCreateDialog,100)}tryCreateDialog()}}async function processNetworkData(e,o,n,t){try{const n=await fetch(e,{mode:"cors",method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(200!==n.status)throw new Error("server");const t=await n.json();if(console.log("Controller Simulation Results:",t),t.error&&t.diagnostic)return console.log("Controller Simulation failed with diagnostic information:",t),void(window.DiagnosticReportDialog?new window.DiagnosticReportDialog(t.diagnostic).show():alert(`Controller Simulation failed: ${t.message}\n\nException: ${t.exception}`));if(t.error)return void alert("Controller Simulation Error: "+t.error);window.ControllerSimulationResultsDialog?new window.ControllerSimulationResultsDialog(t).show():alert("Controller simulation completed. Results dialog not available."),console.log("Controller Simulation completed successfully"),setTimeout(()=>{try{"undefined"!=typeof apka&&apka.spinner&&apka.spinner.stop(),"undefined"!=typeof window&&window.apka&&window.apka.spinner&&window.apka.spinner.stop(),document.querySelectorAll('.spinner, [class*="spinner"]').forEach(e=>{"none"!==e.style.display&&(e.style.display="none",e.remove())}),document.querySelectorAll("div, span, p").forEach(e=>{e.textContent&&e.textContent.includes("Waiting for controller simulation results")&&(e.style.display="none",e.remove())}),"undefined"!=typeof apka&&apka.editor&&apka.editor.setStatus&&apka.editor.setStatus("")}catch(e){console.warn("Timeout spinner stop failed:",e)}},100)}catch(e){if("server"===e.message)return;console.error("Error processing controller simulation data:",e)}finally{try{"undefined"!=typeof apka&&apka.spinner&&apka.spinner.stop(),"undefined"!=typeof window&&window.apka&&window.apka.spinner&&window.apka.spinner.stop(),document.querySelectorAll('.spinner, [class*="spinner"]').forEach(e=>{"none"!==e.style.display&&(e.style.display="none",e.remove())}),document.querySelectorAll("div, span, p").forEach(e=>{e.textContent&&e.textContent.includes("Waiting for controller simulation results")&&(e.style.display="none",e.remove())}),"undefined"!=typeof apka&&apka.editor&&apka.editor.setStatus&&apka.editor.setStatus("")}catch(e){console.warn("Could not stop spinner:",e)}}}if("undefined"!=typeof globalThis?globalThis.controllerSimulationPandaPower=controllerSimulationPandaPower:"undefined"!=typeof window&&(window.controllerSimulationPandaPower=controllerSimulationPandaPower),"undefined"!=typeof module&&module.exports)module.exports={controllerSimulationPandaPower:controllerSimulationPandaPower};else if("object"==typeof exports)try{exports.controllerSimulationPandaPower=controllerSimulationPandaPower}catch(e){}