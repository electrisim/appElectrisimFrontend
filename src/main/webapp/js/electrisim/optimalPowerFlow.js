const getConnectedBusId=(e,o=!1)=>{if(o)return{busFrom:e.source?.mxObjectId?.replace("#","_"),busTo:e.target?.mxObjectId?.replace("#","_")};const n=e.edges[0];if(!n)return null;if(!n.target&&!n.source)return null;const t=n.target&&n.target.mxObjectId!==e.mxObjectId?n.target?n.target.mxObjectId:null:n.source?n.source.mxObjectId:null;return t?t.replace("#","_"):null},getAttributesAsObject=(e,o)=>{const n={};if(!e||!e.value||!e.value.attributes)return console.warn("Cell is missing required properties"),n;const t=e.value.attributes;for(const[e,a]of Object.entries(o)){const o="object"==typeof a&&a.optional,i="object"==typeof a?a.name:a;let r=!1;for(let o=0;o<t.length;o++)if(t[o].nodeName===i){n[e]=t[o].nodeValue,r=!0;break}r||o?!r&&o&&("parallel"===e?(console.log(`⚠ ${e} not found, using default value: 1`),n[e]="1"):"df"===e?(console.log(`⚠ ${e} not found, using default value: 1.0`),n[e]="1.0"):"vector_group"===e?(console.log(`⚠ ${e} not found, using default value: Dyn11`),n[e]="Dyn11"):("vk0_percent"===e||"vkr0_percent"===e||"mag0_percent"===e||"si0_hv_partial"===e)&&(console.log(`⚠ ${e} not found, using default value: 0.0`),n[e]="0.0")):(console.warn(`Missing required attribute ${e} with name ${i}`),n[e]=null)}return n},e="Generator",o="Load",n="Line";function optimalPowerFlowPandaPower(t,a,i){const r={externalGrid:0,generator:0,busbar:0,load:0,line:0},l={simulationParameters:[],externalGrid:[],generator:[],busbar:[],load:[],line:[]},s=a.getModel.bind(a)(),d=s.getDescendants();let c=t;if(a.isEnabled()&&!a.isCellLocked(a.getDefaultParent())){function tryCreateDialog(){let a=null;"undefined"!=typeof window&&window.OptimalPowerFlowDialog?a=window.OptimalPowerFlowDialog:"undefined"!=typeof globalThis&&globalThis.OptimalPowerFlowDialog&&(a=globalThis.OptimalPowerFlowDialog),a?new a(t).show(function(t,a){globalThis.opfRunCount||(globalThis.opfRunCount=0),globalThis.opfRunCount++;const i=globalThis.opfRunCount,p=performance.now();console.log(`=== OPTIMAL POWER FLOW SIMULATION #${i} STARTED ===`),new Map;const u=new Map,m=new Map,w=new Map;if(console.log("Starting fresh simulation with clean caches"),c.spinner.spin(document.body,"Waiting for optimal power flow results..."),parseFloat(t[13]),parseFloat(t[14]),t.length>0){function getUserEmail(){try{const e=localStorage.getItem("user");if(e){const o=JSON.parse(e);if(o&&o.email)return o.email}if("function"==typeof getCurrentUser){const e=getCurrentUser();if(e&&e.email)return e.email}if(window.getCurrentUser&&"function"==typeof window.getCurrentUser){const e=window.getCurrentUser();if(e&&e.email)return e.email}if(window.authHandler&&window.authHandler.getCurrentUser){const e=window.authHandler.getCurrentUser();if(e&&e.email)return e.email}return"unknown@user.com"}catch(e){return console.warn("Error getting user email:",e),"unknown@user.com"}}const g=getUserEmail();console.log("Optimal Power Flow - User email:",g),l.simulationParameters.push({typ:"OptimalPowerFlowPandaPower Parameters",opf_type:t[0],frequency:t[1],ac_algorithm:t[2],dc_algorithm:t[3],calculate_voltage_angles:t[4],init:t[5],delta:t[6],trafo_model:t[7],trafo_loading:t[8],ac_line_model:t[9],numba:t[10],suppress_warnings:t[11],cost_function:t[12],user_email:g});const _=performance.now();console.log(`Processing ${d.length} cells...`);const f=[],v=[];d.forEach(e=>{if(e.getStyle()?.includes("Result"))return void f.push(e);const o=e.getValue();if(o&&"string"==typeof o){const n=o.toLowerCase();if(n.includes("u[pu]")&&n.includes("p[mw]")||n.includes("u[degree]")&&n.includes("q[mvar]")||n.includes("pf:")||n.includes("q/p:")||n.includes("loading[%]")||n.includes("i_hv[ka]")||n.includes("i_mv[ka]")||n.includes("i_lv[ka]")||n.includes("i_from[ka]")||n.includes("i_to[ka]")||n.includes("pl[mw]")||n.includes("vm[pu]")||n.includes("va[degree]")||n.includes("um[pu]")||n.includes("p[mw]:")||n.includes("q[mvar]:")||n.includes("q_mvar:")||n.includes("vm_internal_pu:")||n.includes("va_internal_degree:")||n.includes("vm_pu:")||n.includes("va_degree:")||n.includes("firing angle[degree]:")||n.includes("x[ohm]:")||n.includes("q[mvar]:")||n.includes("p_from[mw]:")||n.includes("q_from[mvar]:")||n.includes("p_to[mw]:")||n.includes("q_to[mvar]:")||n.includes("p_l[mw]:")||n.includes("q_l[mvar]:")||n.includes("vm_from[pu]:")||n.includes("va_from[degree]:")||n.includes("vm_to[pu]:")||n.includes("va_to[degree]:")||n.includes("p_a[mw]:")||n.includes("q_a[mvar]:")||n.includes("p_b[mw]:")||n.includes("q_b[mvar]:")||n.includes("p_c[mw]:")||n.includes("q_c[mvar]:")||n.includes("pl[mw]:")||n.includes("ql[mvar]:")||n.includes("ikss[ka]")||n.includes("ip[ka]")||n.includes("ith[ka]")||n.includes("rk[ohm]")||n.includes("xk[ohm]"))return void f.push(e)}const n=(e=>{if(!e)return null;const o=e.split(";").map(e=>e.split("="));return Object.fromEntries(o)})(e.getStyle());if(!n)return;const t=n.shapeELXXX;t&&"NotEditableLine"!=t&&v.push({cell:e,style:n,componentType:t})});let h=0;const y=performance.now();if(f.length>0){console.log(`Removing ${f.length} result cells from previous simulation...`);try{s.beginUpdate(),f.forEach(e=>{const o=s.getCell(e.id);o&&(s.remove(o),h++)})}finally{s.endUpdate()}console.log(`Successfully removed ${h} result cells`)}else console.log("No result cells to remove (first run or already clean)");const b=performance.now()-y,x=performance.now()-_;console.log(`Cell processing: ${x.toFixed(2)}ms (removed ${h} result cells in ${b.toFixed(2)}ms, found ${v.length} valid cells)`);const k=performance.now();let P=0;v.forEach(({cell:t,style:i,componentType:s})=>{P++;let d,c=t.mxObjectId.replace("#","_");try{if("Bus"===s&&window.gridOptionsBus&&window.gridOptionsBus.api){const e=window.gridOptionsBus.api.getRenderedNodes();if(e&&e.length>0){const o=e.find(e=>e.data&&e.data.id===t.id);o&&o.data&&o.data.name&&(c=o.data.name)}}else if(s===o&&window.gridOptionsLoad&&window.gridOptionsLoad.api){const e=window.gridOptionsLoad.api.getRenderedNodes();if(e&&e.length>0){const o=e.find(e=>e.data&&e.data.id===t.id);o&&o.data&&o.data.name&&(c=o.data.name)}}else if(s===e&&window.gridOptionsGenerator&&window.gridOptionsGenerator.api){const e=window.gridOptionsGenerator.api.getRenderedNodes();if(e&&e.length>0){const o=e.find(e=>e.data&&e.data.id===t.id);o&&o.data&&o.data.name&&(c=o.data.name)}}else if(s===n&&window.gridOptionsLineDialog&&window.gridOptionsLineDialog.api){const e=window.gridOptionsLineDialog.api.getRenderedNodes();if(e&&e.length>0){const o=e.find(e=>e.data&&e.data.id===t.id);o&&o.data&&o.data.name&&(c=o.data.name)}}}catch(e){console.warn("Could not get user-friendly name for",s,t.id,e)}switch(d="Line"===s||"DCLine"===s?{name:t.mxObjectId.replace("#","_"),userFriendlyName:c,id:t.id,bus:getConnectedBusId(t,!0)}:{name:t.mxObjectId.replace("#","_"),userFriendlyName:c,id:t.id,bus:getConnectedBusId(t)},s){case"External Grid":const i={...d,typ:"External Grid"+r.externalGrid++,...getAttributesAsObject(t,{vm_pu:"vm_pu",va_degree:"va_degree",s_sc_max_mva:"s_sc_max_mva",s_sc_min_mva:"s_sc_min_mva",rx_max:"rx_max",rx_min:"rx_min",r0x0_max:"r0x0_max",x0x_max:"x0x_max"})};l.externalGrid.push(i);break;case e:const s=parseFloat(getAttributesAsObject(t,{p_mw:"p_mw"}).p_mw)||10,c={...d,typ:"Generator",...getAttributesAsObject(t,{p_mw:"p_mw",vm_pu:"vm_pu",sn_mva:"sn_mva",scaling:"scaling",vn_kv:"vn_kv",xdss_pu:"xdss_pu",rdss_ohm:"rdss_ohm",cos_phi:"cos_phi",pg_percent:"pg_percent",power_station_trafo:"power_station_trafo"}),min_p_mw:a[t.id]?.min??0,max_p_mw:a[t.id]?.max??s};l.generator.push(c),r.generator++;break;case"Bus":const p={typ:"Bus"+r.busbar++,name:t.mxObjectId.replace("#","_"),id:t.id,vn_kv:t.value.attributes[2].nodeValue};l.busbar.push(p);break;case o:const u={typ:"Load"+r.load++,name:t.mxObjectId.replace("#","_"),id:t.id,bus:getConnectedBusId(t),...getAttributesAsObject(t,{p_mw:"p_mw",q_mvar:"q_mvar",const_z_percent:"const_z_percent",const_i_percent:"const_i_percent",sn_mva:"sn_mva",scaling:"scaling",type:"type"})};l.load.push(u);break;case n:const m={typ:"Line"+r.line++,name:t.mxObjectId.replace("#","_"),id:t.id,busFrom:t.source?.mxObjectId?.replace("#","_"),busTo:t.target?.mxObjectId?.replace("#","_"),...getAttributesAsObject(t,{length_km:"length_km",parallel:"parallel",df:"df",r_ohm_per_km:"r_ohm_per_km",x_ohm_per_km:"x_ohm_per_km",c_nf_per_km:"c_nf_per_km",g_us_per_km:"g_us_per_km",max_i_ka:"max_i_ka",type:"type"})};l.line.push(m)}});const O=performance.now()-k;console.log(`Component processing: ${O.toFixed(2)}ms (${P} components)`);const F=[...l.simulationParameters,...l.externalGrid,...l.generator,...l.busbar,...l.load,...l.line],C=Object.assign({},F);console.log("OPF Data:",JSON.stringify(C));const D=performance.now()-p;console.log("=== OPF PERFORMANCE SUMMARY ==="),console.log(`Run #${i} - Total processing: ${D.toFixed(2)}ms`),console.log(`Components processed: ${P}`),console.log(`Result cells removed: ${h}`),console.log(`Simulation completed. Cache sizes - cells: ${u.size}, names: ${m.size}, attributes: ${w.size}`),u.clear(),m.clear(),w.clear(),console.log("Caches cleared for next simulation"),processNetworkData("https://03dht3kc-5000.euw.devtunnels.ms/",C)}}):setTimeout(tryCreateDialog,100)}tryCreateDialog()}}async function processNetworkData(e,o,n,t){try{const n=await fetch(e,{mode:"cors",method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(200!==n.status)throw new Error("server");const t=await n.json();if(console.log("OPF Results:",t),t.error&&t.diagnostic)return console.log("Optimal Power Flow failed with diagnostic information:",t),void(window.DiagnosticReportDialog?new window.DiagnosticReportDialog(t.diagnostic).show():alert(`Optimal Power Flow calculation failed: ${t.message}\n\nException: ${t.exception}`));if(t.error)return void alert("Optimal Power Flow Error: "+t.error);window.OptimalPowerFlowResultsDialog?new window.OptimalPowerFlowResultsDialog(t).show():alert("OPF completed. Results dialog not available."),console.log("Optimal Power Flow completed successfully"),setTimeout(()=>{try{"undefined"!=typeof apka&&apka.spinner&&apka.spinner.stop(),"undefined"!=typeof window&&window.apka&&window.apka.spinner&&window.apka.spinner.stop(),document.querySelectorAll('.spinner, [class*="spinner"]').forEach(e=>{"none"!==e.style.display&&(e.style.display="none",e.remove())}),document.querySelectorAll("div, span, p").forEach(e=>{e.textContent&&e.textContent.includes("Waiting for optimal power flow results")&&(e.style.display="none",e.remove())}),"undefined"!=typeof apka&&apka.editor&&apka.editor.setStatus&&apka.editor.setStatus("")}catch(e){console.warn("Timeout spinner stop failed:",e)}},100)}catch(e){if("server"===e.message)return;console.error("Error processing OPF data:",e)}finally{try{"undefined"!=typeof apka&&apka.spinner&&apka.spinner.stop(),"undefined"!=typeof window&&window.apka&&window.apka.spinner&&window.apka.spinner.stop(),document.querySelectorAll('.spinner, [class*="spinner"]').forEach(e=>{"none"!==e.style.display&&(e.style.display="none",e.remove())}),document.querySelectorAll("div, span, p").forEach(e=>{e.textContent&&e.textContent.includes("Waiting for optimal power flow results")&&(e.style.display="none",e.remove())}),"undefined"!=typeof apka&&apka.editor&&apka.editor.setStatus&&apka.editor.setStatus("")}catch(e){console.warn("Could not stop spinner:",e)}}}if("undefined"!=typeof globalThis?globalThis.optimalPowerFlowPandaPower=optimalPowerFlowPandaPower:"undefined"!=typeof window&&(window.optimalPowerFlowPandaPower=optimalPowerFlowPandaPower),"undefined"!=typeof module&&module.exports)module.exports={optimalPowerFlowPandaPower:optimalPowerFlowPandaPower};else if("object"==typeof exports)try{exports.optimalPowerFlowPandaPower=optimalPowerFlowPandaPower}catch(e){}