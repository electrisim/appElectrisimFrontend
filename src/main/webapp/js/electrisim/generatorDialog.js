import{Dialog as e}from"./Dialog.js";export const defaultGeneratorData={name:"Generator",p_mw:0,vm_pu:1,sn_mva:0,scaling:1,slack:!1,controllable:!1,vn_kv:0,xdss_pu:0,rdss_ohm:0,cos_phi:.8,pg_percent:0,power_station_trafo:null,max_p_mw:0,min_p_mw:0,max_q_mvar:0,min_q_mvar:0,in_service:!0};export class GeneratorDialog extends e{constructor(e){super("Generator Parameters","Apply"),this.ui=e||window.App?.main?.editor?.editorUi,this.graph=this.ui?.editor?.graph,this.currentTab="loadflow",this.data={...defaultGeneratorData},this.inputs=new Map,this.loadFlowParameters=[{id:"name",label:"Name",symbol:"name",description:"Name identifier for the generator",type:"text",value:this.data.name},{id:"p_mw",label:"Active Power",symbol:"p_mw",unit:"MW",description:"The active power of the generator (positive for generation!)",type:"number",value:this.data.p_mw.toString(),step:"0.1"},{id:"vm_pu",label:"Voltage Set Point",symbol:"vm_pu",unit:"p.u.",description:"The voltage set point of the generator (>0)",type:"number",value:this.data.vm_pu.toString(),step:"0.01",min:"0"},{id:"scaling",label:"Scaling Factor",symbol:"scaling",description:"Scaling factor for the active power of the generator (>0)",type:"number",value:this.data.scaling.toString(),step:"0.1",min:"0"},{id:"slack",label:"Slack Generator",symbol:"slack",description:"True if generator is slack generator for loadflow calculation",type:"checkbox",value:this.data.slack},{id:"controllable",label:"Controllable",symbol:"controllable",description:"True if generator is controllable by OPF",type:"checkbox",value:this.data.controllable},{id:"in_service",label:"In Service",symbol:"in_service",description:"Specifies if the generator is in service (True/False)",type:"checkbox",value:this.data.in_service}],this.shortCircuitParameters=[{id:"sn_mva",label:"Nominal Power",symbol:"sn_mva",unit:"MVA",description:"Nominal power of the generator for short-circuit calculation (>0)",type:"number",value:this.data.sn_mva.toString(),step:"0.1",min:"0"},{id:"vn_kv",label:"Rated Voltage",symbol:"vn_kv",unit:"kV",description:"Rated voltage of the generator for short-circuit calculation (>0)",type:"number",value:this.data.vn_kv.toString(),step:"0.1",min:"0"},{id:"xdss_pu",label:"Subtransient Reactance",symbol:"xdss_pu",unit:"p.u.",description:"Subtransient generator reactance for short-circuit calculation (>0)",type:"number",value:this.data.xdss_pu.toString(),step:"0.01",min:"0"},{id:"rdss_ohm",label:"Subtransient Resistance",symbol:"rdss_ohm",unit:"Ω",description:"Subtransient generator resistance for short-circuit calculation (>=0)",type:"number",value:this.data.rdss_ohm.toString(),step:"0.01",min:"0"},{id:"cos_phi",label:"Power Factor",symbol:"cos_phi",description:"Rated cosine phi of the generator for short-circuit calculation (0...1)",type:"number",value:this.data.cos_phi.toString(),step:"0.01",min:"0",max:"1"},{id:"pg_percent",label:"PG Percent",symbol:"pg_percent",unit:"%",description:"Rated pg (voltage control range) of the generator for short-circuit calculation (>=0)",type:"number",value:this.data.pg_percent.toString(),step:"0.1",min:"0"},{id:"power_station_trafo",label:"Power Station Transformer",symbol:"power_station_trafo",description:"Index of the power station transformer for short-circuit calculation",type:"number",value:this.data.power_station_trafo?.toString()||"",step:"1"}],this.opfParameters=[{id:"max_p_mw",label:"Maximum Active Power",symbol:"max_p_mw",unit:"MW",description:"Maximum active power injection. Only respected for OPF calculations",type:"number",value:this.data.max_p_mw.toString(),step:"1"},{id:"min_p_mw",label:"Minimum Active Power",symbol:"min_p_mw",unit:"MW",description:"Minimum active power injection. Only respected for OPF calculations",type:"number",value:this.data.min_p_mw.toString(),step:"1"},{id:"max_q_mvar",label:"Maximum Reactive Power",symbol:"max_q_mvar",unit:"MVar",description:"Maximum reactive power injection. Only respected for OPF calculations",type:"number",value:this.data.max_q_mvar.toString(),step:"1"},{id:"min_q_mvar",label:"Minimum Reactive Power",symbol:"min_q_mvar",unit:"MVar",description:"Minimum reactive power injection. Only respected for OPF calculations",type:"number",value:this.data.min_q_mvar.toString(),step:"1"}]}getDescription(){return'<strong>Configure Generator Parameters</strong><br>Set parameters for synchronous generator with power flow and short-circuit capabilities. See the <a href="https://electrisim.com/documentation#generator" target="_blank">Electrisim documentation</a>.'}show(e){this.callback=e,this.showTabDialog()}showTabDialog(){this.ui=this.ui||window.App?.main?.editor?.editorUi;const e=document.createElement("div");Object.assign(e.style,{fontFamily:"Arial, sans-serif",fontSize:"14px",lineHeight:"1.5",color:"#333",padding:"0",margin:"0",width:"100%",height:"100%",boxSizing:"border-box",display:"flex",flexDirection:"column"});const t=document.createElement("div");Object.assign(t.style,{padding:"6px 10px",backgroundColor:"#e3f2fd",border:"1px solid #bbdefb",borderRadius:"4px",fontSize:"12px",color:"#1565c0",marginBottom:"12px"}),t.innerHTML=this.getDescription(),e.appendChild(t);const o=document.createElement("div");Object.assign(o.style,{display:"flex",borderBottom:"2px solid #e9ecef",marginBottom:"16px"});const i=this.createTab("Load Flow","loadflow","loadflow"===this.currentTab),a=this.createTab("Short Circuit","shortcircuit","shortcircuit"===this.currentTab),n=this.createTab("OPF","opf","opf"===this.currentTab);o.appendChild(i),o.appendChild(a),o.appendChild(n),e.appendChild(o);const r=document.createElement("div");Object.assign(r.style,{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:"0",scrollbarWidth:"thin",scrollbarColor:"#c1c1c1 #f1f1f1",paddingRight:"8px"});const s=this.createTabContent("loadflow",this.loadFlowParameters),l=this.createTabContent("shortcircuit",this.shortCircuitParameters),c=this.createTabContent("opf",this.opfParameters);r.appendChild(s),r.appendChild(l),r.appendChild(c),e.appendChild(r);const d=document.createElement("div");Object.assign(d.style,{display:"flex",gap:"8px",justifyContent:"flex-end",marginTop:"16px",paddingTop:"16px",borderTop:"1px solid #e9ecef"});const p=this.createButton("Cancel","#6c757d","#5a6268"),u=this.createButton("Apply","#007bff","#0056b3");if(p.onclick=e=>{e.preventDefault(),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},u.onclick=e=>{e.preventDefault();const t=this.getFormValues();console.log("Generator values:",t),this.callback&&this.callback(t),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},d.appendChild(p),d.appendChild(u),e.appendChild(d),this.container=e,i.onclick=()=>this.switchTab("loadflow",i,[a,n],s,[l,c]),a.onclick=()=>this.switchTab("shortcircuit",a,[i,n],l,[s,c]),n.onclick=()=>this.switchTab("opf",n,[i,a],c,[s,l]),this.ui&&"function"==typeof this.ui.showDialog){const t=window.innerHeight-80;this.ui.showDialog(e,1e3,t,!0,!1)}else this.showModalFallback(e)}createTab(e,t,o){const i=document.createElement("div");return Object.assign(i.style,{padding:"12px 20px",cursor:"pointer",borderBottom:o?"2px solid #007bff":"2px solid transparent",backgroundColor:o?"#f8f9fa":"transparent",color:o?"#007bff":"#6c757d",fontWeight:o?"600":"400",transition:"all 0.2s ease",userSelect:"none"}),i.textContent=e,i.dataset.tab=t,i.addEventListener("mouseenter",()=>{i.classList.contains("active")||(i.style.backgroundColor="#f8f9fa")}),i.addEventListener("mouseleave",()=>{i.classList.contains("active")||(i.style.backgroundColor="transparent")}),o&&i.classList.add("active"),i}createTabContent(e,t){const o=document.createElement("div");o.dataset.tab=e,Object.assign(o.style,{display:e===this.currentTab?"block":"none"});const i=document.createElement("form");return Object.assign(i.style,{display:"flex",flexDirection:"column",gap:"16px"}),t.forEach(e=>{const t=document.createElement("div");Object.assign(t.style,{display:"grid",gridTemplateColumns:"1fr 200px",gap:"20px",alignItems:"start",padding:"16px",backgroundColor:"#f8f9fa",border:"1px solid #e9ecef",borderRadius:"8px",minHeight:"80px"});const o=document.createElement("div");Object.assign(o.style,{display:"flex",flexDirection:"column",justifyContent:"center",minHeight:"60px"});const a=document.createElement("label");Object.assign(a.style,{fontWeight:"600",fontSize:"14px",color:"#495057",marginBottom:"6px",lineHeight:"1.2"});let n=e.label;e.symbol&&(n+=` (${e.symbol})`),e.unit&&(n+=` [${e.unit}]`),a.textContent=n,a.htmlFor=e.id;const r=document.createElement("div");Object.assign(r.style,{fontSize:"12px",color:"#6c757d",lineHeight:"1.4",fontStyle:"italic",marginBottom:"4px"}),r.textContent=e.description,o.appendChild(a),o.appendChild(r);const s=document.createElement("div");let l;Object.assign(s.style,{display:"flex",alignItems:"center",justifyContent:"flex-end",minHeight:"60px",width:"200px"}),"checkbox"===e.type?(l=document.createElement("input"),l.type="checkbox",l.checked=e.value,Object.assign(l.style,{width:"24px",height:"24px",accentColor:"#007bff",cursor:"pointer",margin:"0"})):(l=document.createElement("input"),l.type=e.type,l.value=e.value,Object.assign(l.style,{width:"180px",padding:"10px 14px",border:"2px solid #ced4da",borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",backgroundColor:"#ffffff",boxSizing:"border-box",transition:"all 0.2s ease",outline:"none"}),l.addEventListener("focus",()=>{l.style.borderColor="#007bff",l.style.boxShadow="0 0 0 3px rgba(0, 123, 255, 0.15)",l.style.transform="translateY(-1px)"}),l.addEventListener("blur",()=>{l.style.borderColor="#ced4da",l.style.boxShadow="none",l.style.transform="translateY(0)"}),l.addEventListener("mouseenter",()=>{l!==document.activeElement&&(l.style.borderColor="#adb5bd",l.style.backgroundColor="#f8f9fa")}),l.addEventListener("mouseleave",()=>{l!==document.activeElement&&(l.style.borderColor="#ced4da",l.style.backgroundColor="#ffffff")})),"number"===e.type&&(e.step&&(l.step=e.step),void 0!==e.min&&(l.min=e.min),void 0!==e.max&&(l.max=e.max)),l.id=e.id,this.inputs.set(e.id,l),s.appendChild(l),t.appendChild(o),t.appendChild(s),i.appendChild(t)}),o.appendChild(i),o}createButton(e,t,o){const i=document.createElement("button");return i.textContent=e,Object.assign(i.style,{padding:"8px 16px",backgroundColor:t,color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500",transition:"background-color 0.2s"}),i.addEventListener("mouseenter",()=>{i.style.backgroundColor=o}),i.addEventListener("mouseleave",()=>{i.style.backgroundColor=t}),i}switchTab(e,t,o,i,a){this.currentTab=e,Object.assign(t.style,{borderBottom:"2px solid #007bff",backgroundColor:"#f8f9fa",color:"#007bff",fontWeight:"600"}),t.classList.add("active"),o.forEach(e=>{Object.assign(e.style,{borderBottom:"2px solid transparent",backgroundColor:"transparent",color:"#6c757d",fontWeight:"400"}),e.classList.remove("active")}),i.style.display="block",a.forEach(e=>{e.style.display="none"})}getFormValues(){const e={};return[...this.loadFlowParameters,...this.shortCircuitParameters,...this.opfParameters].forEach(t=>{const o=this.inputs.get(t.id);o&&("number"===t.type?e[t.id]=parseFloat(o.value)||0:"checkbox"===t.type?e[t.id]=o.checked:e[t.id]=o.value)}),e}destroy(){super.destroy(),window._globalDialogShowing&&delete window._globalDialogShowing,console.log("Generator dialog destroyed and flags cleared")}populateDialog(e){if(console.log("=== GeneratorDialog.populateDialog called ==="),console.log("Cell data:",e),e&&e.attributes){console.log(`Found ${e.attributes.length} attributes to process`);for(let t=0;t<e.attributes.length;t++){const o=e.attributes[t],i=o.name,a=o.value;console.log(`Processing attribute: ${i} = ${a}`);const n=this.loadFlowParameters.find(e=>e.id===i);if(n){const e=n.value;"checkbox"===n.type?n.value="true"===a||!0===a:n.value=a,console.log(`  Updated loadFlow ${i}: ${e} → ${n.value}`)}const r=this.shortCircuitParameters.find(e=>e.id===i);if(r){const e=r.value;"checkbox"===r.type?r.value="true"===a||!0===a:r.value=a,console.log(`  Updated shortCircuit ${i}: ${e} → ${r.value}`)}const s=this.opfParameters.find(e=>e.id===i);if(s){const e=s.value;"checkbox"===s.type?s.value="true"===a||!0===a:s.value=a,console.log(`  Updated opf ${i}: ${e} → ${s.value}`)}n||r||s||console.log(`  WARNING: No parameter found for attribute ${i}`)}}else console.log("No cell data or attributes found");console.log("=== GeneratorDialog.populateDialog completed ===")}}