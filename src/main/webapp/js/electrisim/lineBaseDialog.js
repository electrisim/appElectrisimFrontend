import{Dialog as e}from"./Dialog.js";import{rowDefsLineLibrary as t,gridOptionsLineLibrary as i,columnDefsLineLibrary as a}from"./lineLibraryDialog.js";import{LibraryDialogManager as o}from"./LibraryDialogManager.js";export const defaultLineData={name:"Line",length_km:1,r_ohm_per_km:0,x_ohm_per_km:0,c_nf_per_km:0,g_us_per_km:0,max_i_ka:0,type:"cs",r0_ohm_per_km:.1,x0_ohm_per_km:.1,c0_nf_per_km:0,endtemp_degree:250,in_service:!0,parallel:1,df:1};export class LineDialog extends e{constructor(e){super("Line Parameters","Apply"),this.ui=e||window.App?.main?.editor?.editorUi,this.graph=this.ui?.editor?.graph,this.currentTab="loadflow",this.data={...defaultLineData},this.inputs=new Map,this.loadFlowParameters=[{id:"name",label:"Name",description:"Name identifier for the line",type:"text",value:this.data.name},{id:"length_km",label:"Length (length_km)",description:"The line length in km (>0)",type:"number",value:this.data.length_km.toString(),step:"0.01",min:"0"},{id:"r_ohm_per_km",label:"Resistance (r_ohm_per_km)",description:"Line resistance in ohm per km (>=0)",type:"number",value:this.data.r_ohm_per_km.toString(),step:"0.001",min:"0"},{id:"x_ohm_per_km",label:"Reactance (x_ohm_per_km)",description:"Line reactance in ohm per km (>=0)",type:"number",value:this.data.x_ohm_per_km.toString(),step:"0.001",min:"0"},{id:"c_nf_per_km",label:"Capacitance (c_nf_per_km)",description:"Line capacitance (line-to-earth) in nano Farad per km (>=0)",type:"number",value:this.data.c_nf_per_km.toString(),step:"0.1",min:"0"},{id:"g_us_per_km",label:"Conductance (g_us_per_km)",description:"Dielectric conductance in micro Siemens per km (>=0)",type:"number",value:this.data.g_us_per_km.toString(),step:"0.001",min:"0"},{id:"max_i_ka",label:"Max Current (max_i_ka)",description:"Maximum thermal current in kilo Ampere (>0)",type:"number",value:this.data.max_i_ka.toString(),step:"0.01",min:"0"},{id:"type",label:"Line Type (type)",description:'Type of line ("ol" for overhead line or "cs" for cable system)',type:"select",value:this.data.type,options:["cs","ol"]},{id:"in_service",label:"In Service",description:"Specifies if the line is in service (True/False)",type:"checkbox",value:this.data.in_service},{id:"parallel",label:"Parallel Line Systems (parallel)",description:"Number of parallel line systems (optional, default: 1)",type:"number",value:this.data.parallel.toString(),step:"1",min:"1"},{id:"df",label:"Derating Factor (df)",description:"Derating factor: maximum current of line in relation to nominal current of line (from 0 to 1, default: 1.0)",type:"number",value:this.data.df.toString(),step:"0.1",min:"0",max:"1"}],this.shortCircuitParameters=[{id:"r0_ohm_per_km",label:"Zero Sequence Resistance (r0_ohm_per_km)",description:"Zero sequence line resistance in ohm per km (>=0)",type:"number",value:this.data.r0_ohm_per_km.toString(),step:"0.001",min:"0"},{id:"x0_ohm_per_km",label:"Zero Sequence Reactance (x0_ohm_per_km)",description:"Zero sequence line reactance in ohm per km (>=0)",type:"number",value:this.data.x0_ohm_per_km.toString(),step:"0.001",min:"0"},{id:"c0_nf_per_km",label:"Zero Sequence Capacitance (c0_nf_per_km)",description:"Zero sequence line capacitance in nano Farad per km (>=0)",type:"number",value:this.data.c0_nf_per_km.toString(),step:"0.1",min:"0"},{id:"endtemp_degree",label:"End Temperature (endtemp_degree)",description:"Short-Circuit end temperature of the line in degrees Celsius",type:"number",value:this.data.endtemp_degree.toString(),step:"1",min:"0"}],this.opfParameters=[]}getDescription(){return'<strong>Configure Line Parameters</strong><br>Set parameters for transmission/distribution line. See the <a href="https://electrisim.com/documentation#line" target="_blank">Electrisim documentation</a>.'}show(e){this.callback=e,this.showTabDialog()}showTabDialog(){this.ui=this.ui||window.App?.main?.editor?.editorUi;const e=document.createElement("div");Object.assign(e.style,{fontFamily:"Arial, sans-serif",fontSize:"14px",lineHeight:"1.5",color:"#333",padding:"0",margin:"0",width:"100%",height:"100%",boxSizing:"border-box",display:"flex",flexDirection:"column"});const t=document.createElement("div");Object.assign(t.style,{padding:"6px 10px",backgroundColor:"#e3f2fd",border:"1px solid #bbdefb",borderRadius:"4px",fontSize:"12px",color:"#1565c0",marginBottom:"12px"}),t.innerHTML=this.getDescription(),e.appendChild(t);const i=document.createElement("div");Object.assign(i.style,{display:"flex",borderBottom:"2px solid #e9ecef",marginBottom:"16px"});const a=this.createTab("Load Flow","loadflow","loadflow"===this.currentTab),o=this.createTab("Short Circuit","shortcircuit","shortcircuit"===this.currentTab),n=this.createTab("OPF","opf","opf"===this.currentTab);i.appendChild(a),i.appendChild(o),i.appendChild(n),e.appendChild(i);const r=document.createElement("div");Object.assign(r.style,{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:"0",scrollbarWidth:"thin",scrollbarColor:"#c1c1c1 #f1f1f1",paddingRight:"8px"});const l=this.createTabContent("loadflow",this.loadFlowParameters),s=this.createTabContent("shortcircuit",this.shortCircuitParameters),d=this.createTabContent("opf",this.opfParameters);r.appendChild(l),r.appendChild(s),r.appendChild(d),e.appendChild(r);const c=document.createElement("div");Object.assign(c.style,{display:"flex",gap:"8px",justifyContent:"space-between",marginTop:"16px",paddingTop:"16px",borderTop:"1px solid #e9ecef"});const p=document.createElement("div");Object.assign(p.style,{display:"flex",gap:"8px"});const m=this.createButton("Library","#28a745","#218838");m.onclick=e=>{e.preventDefault(),this.showLibrary()},p.appendChild(m);const h=document.createElement("div");Object.assign(h.style,{display:"flex",gap:"8px"});const u=this.createButton("Cancel","#6c757d","#5a6268"),f=this.createButton("Apply","#007bff","#0056b3");if(u.onclick=e=>{e.preventDefault(),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},f.onclick=e=>{e.preventDefault();const t=this.getFormValues();console.log("Line values:",t),this.callback&&this.callback(t),this.destroy(),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},h.appendChild(u),h.appendChild(f),c.appendChild(p),c.appendChild(h),e.appendChild(c),this.container=e,a.onclick=()=>this.switchTab("loadflow",a,[o,n],l,[s,d]),o.onclick=()=>this.switchTab("shortcircuit",o,[a,n],s,[l,d]),n.onclick=()=>this.switchTab("opf",n,[a,o],d,[l,s]),this.ui&&"function"==typeof this.ui.showDialog){const t=window.innerHeight-80;this.ui.showDialog(e,1e3,t,!0,!1)}else this.showModalFallback(e)}createTab(e,t,i){const a=document.createElement("div");return Object.assign(a.style,{padding:"12px 20px",cursor:"pointer",borderBottom:i?"2px solid #007bff":"2px solid transparent",backgroundColor:i?"#f8f9fa":"transparent",color:i?"#007bff":"#333",fontWeight:i?"600":"400",transition:"all 0.2s ease"}),a.textContent=e,a.setAttribute("data-tab",t),a.addEventListener("mouseenter",()=>{i||(a.style.backgroundColor="#f8f9fa",a.style.color="#007bff")}),a.addEventListener("mouseleave",()=>{i||(a.style.backgroundColor="transparent",a.style.color="#333")}),a}createTabContent(e,t){const i=document.createElement("div");if(i.dataset.tab=e,Object.assign(i.style,{display:e===this.currentTab?"block":"none"}),0===t.length){const e=document.createElement("div");return Object.assign(e.style,{padding:"20px",textAlign:"center",color:"#666",fontStyle:"italic"}),e.textContent="No parameters available for this category.",i.appendChild(e),i}const a=document.createElement("form");return Object.assign(a.style,{display:"flex",flexDirection:"column",gap:"16px"}),t.forEach(e=>{const t=document.createElement("div");Object.assign(t.style,{display:"grid",gridTemplateColumns:"1fr 200px",gap:"20px",alignItems:"start",padding:"16px",backgroundColor:"#f8f9fa",border:"1px solid #e9ecef",borderRadius:"8px",minHeight:"80px"});const i=document.createElement("div");Object.assign(i.style,{display:"flex",flexDirection:"column",gap:"4px",minWidth:"0"});const o=document.createElement("label");Object.assign(o.style,{fontWeight:"600",fontSize:"14px",color:"#495057",marginBottom:"6px",lineHeight:"1.2"}),o.textContent=e.label,o.htmlFor=e.id;const n=document.createElement("div");Object.assign(n.style,{fontSize:"12px",color:"#6c757d",lineHeight:"1.4",fontStyle:"italic",marginBottom:"4px"}),n.textContent=e.description,i.appendChild(o),i.appendChild(n);const r=document.createElement("div");let l;Object.assign(r.style,{display:"flex",alignItems:"center",justifyContent:"flex-end",minHeight:"60px",width:"200px"}),"checkbox"===e.type?(l=document.createElement("input"),l.type="checkbox",l.checked=e.value,Object.assign(l.style,{width:"24px",height:"24px",accentColor:"#007bff",cursor:"pointer",margin:"0"})):"select"===e.type?(l=document.createElement("select"),e.options.forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,t===e.value&&(i.selected=!0),l.appendChild(i)}),Object.assign(l.style,{width:"180px",padding:"10px 14px",border:"2px solid #ced4da",borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",backgroundColor:"#ffffff",boxSizing:"border-box",transition:"all 0.2s ease",outline:"none"})):(l=document.createElement("input"),l.type=e.type,l.value=e.value,Object.assign(l.style,{width:"180px",padding:"10px 14px",border:"2px solid #ced4da",borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",backgroundColor:"#ffffff",boxSizing:"border-box",transition:"all 0.2s ease",outline:"none"}),l.addEventListener("focus",()=>{l.style.borderColor="#007bff",l.style.boxShadow="0 0 0 3px rgba(0, 123, 255, 0.15)",l.style.transform="translateY(-1px)"}),l.addEventListener("blur",()=>{l.style.borderColor="#ced4da",l.style.boxShadow="none",l.style.transform="translateY(0)"}),l.addEventListener("mouseenter",()=>{l!==document.activeElement&&(l.style.borderColor="#adb5bd",l.style.backgroundColor="#f8f9fa")}),l.addEventListener("mouseleave",()=>{l!==document.activeElement&&(l.style.borderColor="#ced4da",l.style.backgroundColor="#ffffff")})),l.id=e.id,e.step&&(l.step=e.step),void 0!==e.min&&(l.min=e.min),void 0!==e.max&&(l.max=e.max),this.inputs.set(e.id,l),r.appendChild(l),t.appendChild(i),t.appendChild(r),a.appendChild(t)}),i.appendChild(a),i}switchTab(e,t,i,a,o){this.currentTab=e,t.style.borderBottom="2px solid #007bff",t.style.backgroundColor="#f8f9fa",t.style.color="#007bff",t.style.fontWeight="600",i.forEach(e=>{e.style.borderBottom="2px solid transparent",e.style.backgroundColor="transparent",e.style.color="#333",e.style.fontWeight="400"}),a.style.display="block",o.forEach(e=>{e.style.display="none"})}getFormValues(){const e={};return[...this.loadFlowParameters,...this.shortCircuitParameters,...this.opfParameters].forEach(t=>{if(this.inputs.has(t.id)){const i=this.inputs.get(t.id);if("checkbox"===i.type)e[t.id]=i.checked;else if("SELECT"===i.tagName)e[t.id]=i.value;else if(["parallel","df"].includes(t.id)){const a=parseFloat(i.value);""===i.value.trim()||isNaN(a)?e[t.id]=(t.id,1):e[t.id]=a}else{const a=parseFloat(i.value);e[t.id]=isNaN(a)?i.value:a}}}),e}createButton(e,t,i){const a=document.createElement("button");return a.textContent=e,Object.assign(a.style,{padding:"8px 16px",backgroundColor:t,color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500",transition:"background-color 0.2s"}),a.addEventListener("mouseenter",()=>{a.style.backgroundColor=i}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor=t}),a}destroy(){super.destroy(),window._globalDialogShowing&&delete window._globalDialogShowing,console.log("Line dialog destroyed and flags cleared")}showLibrary(){const e=(new o).createLibraryDialog("Line Library",t,a,i,e=>{this.loadLineData(e),this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()},()=>{this.ui&&"function"==typeof this.ui.hideDialog&&this.ui.hideDialog()});if(this.ui&&"function"==typeof this.ui.showDialog){const t=window.innerHeight-80;this.ui.showDialog(e,1800,t,!0,!1)}}loadLineData(e){const t={name:e.name||"Line",length_km:1,r_ohm_per_km:e.r_ohm_per_km||0,x_ohm_per_km:e.x_ohm_per_km||0,c_nf_per_km:e.c_nf_per_km||0,g_us_per_km:e.g_us_per_km||0,max_i_ka:e.max_i_ka||0,type:e.type||"cs",r0_ohm_per_km:e.r0_ohm_per_km||0,x0_ohm_per_km:e.x0_ohm_per_km||0,c0_nf_per_km:e.c0_nf_per_km||0,endtemp_degree:e.endtemp_degree||250,in_service:!0,parallel:e.parallel||1,df:e.df||1};Object.keys(t).forEach(e=>{if(this.inputs.has(e)){const i=this.inputs.get(e),a=t[e];"checkbox"===i.type?i.checked=Boolean(a):"SELECT"===i.tagName?i.value=a:i.value=a.toString()}}),console.log("Loaded line data:",t)}populateDialog(e){if(console.log("=== LineDialog.populateDialog called ==="),console.log("Cell data:",e),console.log("Initial parameter values:"),[...this.loadFlowParameters,...this.shortCircuitParameters,...this.opfParameters].forEach(e=>{console.log(`  ${e.id}: ${e.value} (${e.type})`)}),e&&e.attributes){console.log(`Found ${e.attributes.length} attributes to process`);for(let t=0;t<e.attributes.length;t++){const i=e.attributes[t],a=i.name,o=i.value;console.log(`Processing attribute: ${a} = ${o}`);const n=this.loadFlowParameters.find(e=>e.id===a);if(n){const e=n.value;"checkbox"===n.type?n.value="true"===o||!0===o:n.value=o,console.log(`  Updated loadFlow ${a}: ${e} → ${n.value}`)}const r=this.shortCircuitParameters.find(e=>e.id===a);if(r){const e=r.value;"checkbox"===r.type?r.value="true"===o||!0===o:r.value=o,console.log(`  Updated shortCircuit ${a}: ${e} → ${r.value}`)}const l=this.opfParameters.find(e=>e.id===a);if(l){const e=l.value;"checkbox"===l.type?l.value="true"===o||!0===o:l.value=o,console.log(`  Updated opf ${a}: ${e} → ${l.value}`)}n||r||l||console.log(`  WARNING: No parameter found for attribute ${a}`)}}else console.log("No cell data or attributes found");console.log("Final parameter values:"),[...this.loadFlowParameters,...this.shortCircuitParameters,...this.opfParameters].forEach(e=>{console.log(`  ${e.id}: ${e.value} (${e.type})`)}),console.log("Updating DOM inputs with parameter values..."),[...this.loadFlowParameters,...this.shortCircuitParameters,...this.opfParameters].forEach(e=>{if(this.inputs.has(e.id)){const t=this.inputs.get(e.id),i=e.value;"checkbox"===t.type?t.checked=Boolean(i):"SELECT"===t.tagName?t.value=i:t.value=i.toString(),console.log(`  Updated DOM input ${e.id}: ${i}`)}}),console.log("=== LineDialog.populateDialog completed ===")}}export const rowDefsDataLineBaseDialog=[{name:"Line",length_km:1,r_ohm_per_km:0,x_ohm_per_km:0,c_nf_per_km:0,g_us_per_km:0,max_i_ka:0,type:"cs",r0_ohm_per_km:0,x0_ohm_per_km:0,c0_nf_per_km:0,endtemp_degree:250,in_service:!0}];export const columnDefsLineBaseDialog=[{field:"name",minWidth:300},{field:"length_km",headerTooltip:"The line length in km",maxWidth:140,valueParser:e=>parseFloat(e.newValue)||0},{field:"r_ohm_per_km",headerTooltip:"line resistance in ohm per km",maxWidth:140,valueParser:e=>parseFloat(e.newValue)||0},{field:"x_ohm_per_km",headerTooltip:"line reactance in ohm per km",maxWidth:140,valueParser:e=>parseFloat(e.newValue)||0},{field:"c_nf_per_km",headerTooltip:"line capacitance (line-to-earth) in nano Farad per km",maxWidth:130,valueParser:e=>parseFloat(e.newValue)||0},{field:"g_us_per_km",headerTooltip:"dielectric conductance in micro Siemens per km",maxWidth:130,valueParser:e=>parseFloat(e.newValue)||0},{field:"max_i_ka",headerTooltip:"maximum thermal current in kilo Ampere",maxWidth:100,valueParser:e=>parseFloat(e.newValue)||0},{field:"type",headerTooltip:'type of line ("ol" for overhead line or "cs" for cable system)',maxWidth:100},{field:"r0_ohm_per_km",headerTooltip:"zero sequence line resistance in ohm per km",maxWidth:150,valueParser:e=>parseFloat(e.newValue)||0},{field:"x0_ohm_per_km",headerTooltip:"zero sequence line reactance in ohm per km",maxWidth:150,valueParser:e=>parseFloat(e.newValue)||0},{field:"c0_nf_per_km",headerTooltip:"zero sequence line capacitance in nano Farad per km",maxWidth:130,valueParser:e=>parseFloat(e.newValue)||0},{field:"endtemp_degree",headerTooltip:"Short-Circuit end temperature of the line",maxWidth:150,valueParser:e=>parseFloat(e.newValue)||0}];export const gridOptionsLineBaseDialog={columnDefs:columnDefsLineBaseDialog,defaultColDef:{editable:!0},rowData:rowDefsDataLineBaseDialog,singleClickEdit:!0,stopEditingWhenGridLosesFocus:!0};globalThis.rowDefsDataLineBaseDialog=rowDefsDataLineBaseDialog,globalThis.columnDefsLineBaseDialog=columnDefsLineBaseDialog,globalThis.gridOptionsLineBaseDialog=gridOptionsLineBaseDialog,globalThis.LineDialog=LineDialog;