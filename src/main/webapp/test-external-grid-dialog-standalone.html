<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test External Grid Dialog - Standalone</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .description {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            color: #1565c0;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        /* Dialog Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .dialog-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 750px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .dialog-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: bold;
            font-size: 16px;
        }

        .dialog-content {
            padding: 20px;
            flex: 1;
            overflow: auto;
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
        }

        .dialog-description {
            padding: 6px 10px;
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            font-size: 12px;
            color: #1565c0;
            margin-bottom: 12px;
        }

        .tab-container {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 16px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            background-color: transparent;
            color: #6c757d;
            font-weight: 400;
            transition: all 0.2s ease;
            user-select: none;
        }

        .tab.active {
            border-bottom: 2px solid #007bff;
            background-color: #f8f9fa;
            color: #007bff;
            font-weight: 600;
        }

        .tab:hover:not(.active) {
            background-color: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .parameter-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .parameter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
            padding: 12px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }

        .parameter-left {
            display: flex;
            flex-direction: column;
        }

        .parameter-label {
            font-weight: 600;
            font-size: 14px;
            color: #495057;
            margin-bottom: 4px;
        }

        .parameter-description {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
            font-style: italic;
        }

        .parameter-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background-color: #ffffff;
        }

        .parameter-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .dialog-buttons {
            padding: 16px 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .dialog-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .dialog-button.cancel {
            background-color: #6c757d;
            color: white;
        }

        .dialog-button.cancel:hover {
            background-color: #5a6268;
        }

        .dialog-button.apply {
            background-color: #007bff;
            color: white;
        }

        .dialog-button.apply:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå External Grid Dialog Test - Standalone</h1>
        
        <div class="description">
            <h3>‚ú® New Tabbed Dialog Features:</h3>
            <ul>
                <li><strong>üìä Column-based Layout:</strong> Each parameter displayed in its own row with field name and description</li>
                <li><strong>‚ö° Load Flow Tab:</strong> Parameters for load flow calculations (Name, Voltage, Service Status)</li>
                <li><strong>üîå Short Circuit Tab:</strong> Parameters for short circuit calculations (Power ratings, R/X ratios)</li>
                <li><strong>üéØ OPF Tab:</strong> Parameters for Optimal Power Flow calculations (Power limits, Control settings)</li>
                <li><strong>üìù Visible Descriptions:</strong> All parameters based on pandapower documentation</li>
            </ul>
        </div>

        <div class="success">
            <strong>‚úÖ Ready to Test!</strong> This version works without a web server - click the button below to see the new dialog.
        </div>

        <button class="test-button" onclick="testExternalGridDialog()">
            üöÄ Open New External Grid Dialog
        </button>

        <button class="test-button" onclick="showCurrentData()">
            üìã Show Default Data Structure
        </button>

        <div id="output" class="output" style="display: none;">
            Output will appear here...
        </div>
    </div>

    <script>
        // Default values for external grid parameters (based on pandapower documentation)
        const defaultExternalGridData = {
            name: "External Grid",
            vm_pu: 1.0,
            va_degree: 0.0,
            in_service: true,
            s_sc_max_mva: 1000000.0,
            s_sc_min_mva: 0.0,
            rx_max: 0.0,
            rx_min: 0.0,
            r0x0_max: 0.0,
            x0x_max: 0.0,
            max_p_mw: 0.0,
            min_p_mw: 0.0,
            max_q_mvar: 0.0,
            min_q_mvar: 0.0,
            controllable: false,
            slack_weight: 1.0
        };

        // Load Flow parameters
        const loadFlowParameters = [
            {
                id: 'name',
                label: 'External Grid Name',
                description: 'Name identifier for the external grid',
                type: 'text',
                value: defaultExternalGridData.name
            },
            {
                id: 'vm_pu',
                label: 'Voltage Magnitude (p.u.)',
                description: 'Voltage at the slack node in per unit (>0)',
                type: 'number',
                value: defaultExternalGridData.vm_pu.toString(),
                step: '0.01',
                min: '0.01'
            },
            {
                id: 'va_degree',
                label: 'Voltage Angle (degrees)',
                description: 'Voltage angle at the slack node in degrees. Only considered in loadflow if calculate_voltage_angles = True',
                type: 'number',
                value: defaultExternalGridData.va_degree.toString(),
                step: '0.1'
            },
            {
                id: 'in_service',
                label: 'In Service',
                description: 'Specifies if the external grid is in service (True/False)',
                type: 'checkbox',
                value: defaultExternalGridData.in_service
            }
        ];
        
        // Short Circuit parameters
        const shortCircuitParameters = [
            {
                id: 's_sc_max_mva',
                label: 'Max Short Circuit Power (MVA)',
                description: 'Maximal short circuit apparent power to calculate internal impedance of ext_grid for short circuit calculations',
                type: 'number',
                value: defaultExternalGridData.s_sc_max_mva.toString(),
                step: '1000'
            },
            {
                id: 's_sc_min_mva',
                label: 'Min Short Circuit Power (MVA)',
                description: 'Minimal short circuit apparent power to calculate internal impedance of ext_grid for short circuit calculations',
                type: 'number',
                value: defaultExternalGridData.s_sc_min_mva.toString(),
                step: '1000'
            },
            {
                id: 'rx_max',
                label: 'Max R/X Ratio',
                description: 'Maximal R/X-ratio to calculate internal impedance of ext_grid for short circuit calculations',
                type: 'number',
                value: defaultExternalGridData.rx_max.toString(),
                step: '0.01'
            },
            {
                id: 'rx_min',
                label: 'Min R/X Ratio',
                description: 'Minimal R/X-ratio to calculate internal impedance of ext_grid for short circuit calculations',
                type: 'number',
                value: defaultExternalGridData.rx_min.toString(),
                step: '0.01'
            },
            {
                id: 'r0x0_max',
                label: 'Max R0/X0 Ratio',
                description: 'Maximal R/X-ratio to calculate Zero sequence internal impedance of ext_grid',
                type: 'number',
                value: defaultExternalGridData.r0x0_max.toString(),
                step: '0.01'
            },
            {
                id: 'x0x_max',
                label: 'Max X0/X Ratio',
                description: 'Maximal X0/X-ratio to calculate Zero sequence internal impedance of ext_grid',
                type: 'number',
                value: defaultExternalGridData.x0x_max.toString(),
                step: '0.01'
            }
        ];
        
        // OPF (Optimal Power Flow) parameters
        const opfParameters = [
            {
                id: 'max_p_mw',
                label: 'Max Active Power (MW)',
                description: 'Maximum active power injection. Only respected for OPF calculations',
                type: 'number',
                value: defaultExternalGridData.max_p_mw.toString(),
                step: '1'
            },
            {
                id: 'min_p_mw',
                label: 'Min Active Power (MW)',
                description: 'Minimum active power injection. Only respected for OPF calculations',
                type: 'number',
                value: defaultExternalGridData.min_p_mw.toString(),
                step: '1'
            },
            {
                id: 'max_q_mvar',
                label: 'Max Reactive Power (MVar)',
                description: 'Maximum reactive power injection. Only respected for OPF calculations',
                type: 'number',
                value: defaultExternalGridData.max_q_mvar.toString(),
                step: '1'
            },
            {
                id: 'min_q_mvar',
                label: 'Min Reactive Power (MVar)',
                description: 'Minimum reactive power injection. Only respected for OPF calculations',
                type: 'number',
                value: defaultExternalGridData.min_q_mvar.toString(),
                step: '1'
            },
            {
                id: 'controllable',
                label: 'Controllable',
                description: 'Control of value limits: True = p_mw, q_mvar and vm_pu limits enforced; False = set points enforced, limits ignored',
                type: 'checkbox',
                value: defaultExternalGridData.controllable
            },
            {
                id: 'slack_weight',
                label: 'Slack Weight',
                description: 'Contribution factor for distributed slack power flow calculation (active power balancing)',
                type: 'number',
                value: defaultExternalGridData.slack_weight.toString(),
                step: '0.1',
                min: '0'
            }
        ];

        let currentDialog = null;
        let currentTab = 'loadflow';

        function testExternalGridDialog() {
            try {
                console.log('Creating new External Grid Dialog...');
                showExternalGridDialog((values) => {
                    console.log('‚úÖ Dialog callback executed with values:', values);
                    
                    // Display the results
                    const output = document.getElementById('output');
                    output.style.display = 'block';
                    output.innerHTML = `<strong>üéâ External Grid Parameters Received:</strong>\n\n${JSON.stringify(values, null, 2)}\n\n<strong>üìä Parameter Summary:</strong>\n`;
                    
                    // Add summary
                    let summary = '';
                    if (values.name) summary += `‚Ä¢ Grid Name: ${values.name}\n`;
                    if (values.vm_pu !== undefined) summary += `‚Ä¢ Voltage (p.u.): ${values.vm_pu}\n`;
                    if (values.va_degree !== undefined) summary += `‚Ä¢ Voltage Angle: ${values.va_degree}¬∞\n`;
                    if (values.s_sc_max_mva !== undefined) summary += `‚Ä¢ Max SC Power: ${values.s_sc_max_mva} MVA\n`;
                    if (values.s_sc_min_mva !== undefined) summary += `‚Ä¢ Min SC Power: ${values.s_sc_min_mva} MVA\n`;
                    
                    output.innerHTML += summary;
                    
                    // Show success message
                    alert('‚úÖ Parameters successfully captured!\n\nCheck the output below for details.');
                });
                
            } catch (error) {
                console.error('‚ùå Error creating/showing dialog:', error);
                alert('‚ùå Error: ' + error.message + '\n\nCheck the browser console for details.');
                
                const output = document.getElementById('output');
                output.style.display = 'block';
                output.textContent = '‚ùå Error occurred:\n' + error.message + '\n\nStack trace:\n' + error.stack;
            }
        }

        function showCurrentData() {
            const output = document.getElementById('output');
            output.style.display = 'block';
            output.innerHTML = `<strong>üìã Current Default External Grid Data:</strong>\n\n${JSON.stringify(defaultExternalGridData, null, 2)}`;
        }

        function showExternalGridDialog(callback) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            // Create dialog container
            const dialogContainer = document.createElement('div');
            dialogContainer.className = 'dialog-container';
            
            // Create header
            const header = document.createElement('div');
            header.className = 'dialog-header';
            header.textContent = 'External Grid Parameters';
            dialogContainer.appendChild(header);
            
            // Create content
            const content = document.createElement('div');
            content.className = 'dialog-content';
            
            // Add description
            const description = document.createElement('div');
            description.className = 'dialog-description';
            description.innerHTML = '<strong>Configure External Grid Parameters</strong><br>Set parameters for load flow and short circuit calculations.';
            content.appendChild(description);
            
            // Create tab container
            const tabContainer = document.createElement('div');
            tabContainer.className = 'tab-container';
            
            const loadFlowTab = document.createElement('div');
            loadFlowTab.className = 'tab active';
            loadFlowTab.textContent = 'Load Flow';
            loadFlowTab.onclick = () => switchTab('loadflow', loadFlowTab);
            
            const shortCircuitTab = document.createElement('div');
            shortCircuitTab.className = 'tab';
            shortCircuitTab.textContent = 'Short Circuit';
            shortCircuitTab.onclick = () => switchTab('shortcircuit', shortCircuitTab);
            
            const opfTab = document.createElement('div');
            opfTab.className = 'tab';
            opfTab.textContent = 'OPF';
            opfTab.onclick = () => switchTab('opf', opfTab);
            
            tabContainer.appendChild(loadFlowTab);
            tabContainer.appendChild(shortCircuitTab);
            tabContainer.appendChild(opfTab);
            content.appendChild(tabContainer);
            
            // Create tab contents
            const loadFlowContent = createTabContent('loadflow', loadFlowParameters);
            const shortCircuitContent = createTabContent('shortcircuit', shortCircuitParameters);
            const opfContent = createTabContent('opf', opfParameters);
            
            content.appendChild(loadFlowContent);
            content.appendChild(shortCircuitContent);
            content.appendChild(opfContent);
            dialogContainer.appendChild(content);
            
            // Create buttons
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'dialog-buttons';
            
            const cancelButton = document.createElement('button');
            cancelButton.className = 'dialog-button cancel';
            cancelButton.textContent = 'Cancel';
            cancelButton.onclick = () => {
                document.body.removeChild(overlay);
                currentDialog = null;
                
                // Clear any global flags for consistency with main application
                if (window._globalDialogShowing) {
                    delete window._globalDialogShowing;
                }
                
                console.log('Standalone dialog cancelled and cleaned up');
            };
            
            const applyButton = document.createElement('button');
            applyButton.className = 'dialog-button apply';
            applyButton.textContent = 'Apply';
            applyButton.onclick = () => {
                const values = getFormValues();
                console.log('External Grid values:', values);
                
                if (callback) {
                    callback(values);
                }
                
                document.body.removeChild(overlay);
                currentDialog = null;
                
                // Clear any global flags for consistency with main application
                if (window._globalDialogShowing) {
                    delete window._globalDialogShowing;
                }
                
                console.log('Standalone dialog applied and cleaned up');
            };
            
            buttonContainer.appendChild(cancelButton);
            buttonContainer.appendChild(applyButton);
            dialogContainer.appendChild(buttonContainer);
            
            overlay.appendChild(dialogContainer);
            document.body.appendChild(overlay);
            
            currentDialog = {
                overlay: overlay,
                loadFlowTab: loadFlowTab,
                shortCircuitTab: shortCircuitTab,
                opfTab: opfTab,
                loadFlowContent: loadFlowContent,
                shortCircuitContent: shortCircuitContent,
                opfContent: opfContent
            };
        }

        function createTabContent(tabId, parameters) {
            const content = document.createElement('div');
            content.className = `tab-content ${tabId === currentTab ? 'active' : ''}`;
            content.dataset.tab = tabId;
            
            const form = document.createElement('div');
            form.className = 'parameter-form';
            
            parameters.forEach(param => {
                const row = document.createElement('div');
                row.className = 'parameter-row';
                
                const leftColumn = document.createElement('div');
                leftColumn.className = 'parameter-left';
                
                const label = document.createElement('div');
                label.className = 'parameter-label';
                label.textContent = param.label;
                
                const description = document.createElement('div');
                description.className = 'parameter-description';
                description.textContent = param.description;
                
                leftColumn.appendChild(label);
                leftColumn.appendChild(description);
                
                const rightColumn = document.createElement('div');
                const input = document.createElement('input');
                input.className = 'parameter-input';
                input.type = param.type;
                input.id = param.id;
                
                // Handle different input types
                if (param.type === 'checkbox') {
                    input.checked = param.value;
                    input.style.width = '20px';
                    input.style.height = '20px';
                    input.style.accentColor = '#007bff';
                } else {
                    input.value = param.value;
                }
                
                if (param.step) input.step = param.step;
                if (param.min !== undefined) input.min = param.min;
                if (param.max !== undefined) input.max = param.max;
                
                rightColumn.appendChild(input);
                
                row.appendChild(leftColumn);
                row.appendChild(rightColumn);
                form.appendChild(row);
            });
            
            content.appendChild(form);
            return content;
        }

        function switchTab(tabId, clickedTab) {
            if (!currentDialog) return;
            
            currentTab = tabId;
            
            // Update tab styles
            currentDialog.loadFlowTab.className = 'tab';
            currentDialog.shortCircuitTab.className = 'tab';
            currentDialog.opfTab.className = 'tab';
            clickedTab.className = 'tab active';
            
            // Update content visibility
            currentDialog.loadFlowContent.className = 'tab-content';
            currentDialog.shortCircuitContent.className = 'tab-content';
            currentDialog.opfContent.className = 'tab-content';
            
            if (tabId === 'loadflow') {
                currentDialog.loadFlowContent.className = 'tab-content active';
            } else if (tabId === 'shortcircuit') {
                currentDialog.shortCircuitContent.className = 'tab-content active';
            } else if (tabId === 'opf') {
                currentDialog.opfContent.className = 'tab-content active';
            }
        }

        function getFormValues() {
            const values = {};
            
            [...loadFlowParameters, ...shortCircuitParameters, ...opfParameters].forEach(param => {
                const input = document.getElementById(param.id);
                if (input) {
                    if (param.type === 'number') {
                        values[param.id] = parseFloat(input.value) || 0;
                    } else if (param.type === 'checkbox') {
                        values[param.id] = input.checked;
                    } else {
                        values[param.id] = input.value;
                    }
                }
            });
            
            return values;
        }

        // Test that everything loaded correctly
        console.log('‚úÖ External Grid Dialog standalone version loaded successfully');
        console.log('üìä Default data:', defaultExternalGridData);
    </script>
</body>
</html>
