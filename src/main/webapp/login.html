<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - ElectriSim</title>

    <!-- Favicon (match index.html) -->
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/logo_Electrisim_removebg-preview.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/logo_Electrisim_removebg-preview.png">
    <link rel="shortcut icon" href="images/logo_Electrisim_removebg-preview.png">


    <!-- Smartlook -->
    <script type='text/javascript'>
        window.smartlook||(function(d) {
            var o=smartlook=function(){ o.api.push(arguments)},h=d.getElementsByTagName('head')[0];
            var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript';
            c.charset='utf-8';c.src='https://web-sdk.smartlook.com/recorder.js';h.appendChild(c);
        })(document);
        smartlook('init', '31f78a73918844d1c038266ca853b5b9bd7da408', { region: 'eu' });
    </script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        .auth-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 400px;
            max-width: 90%;
        }
        
        h2 {
            margin-top: 0;
            color: #333;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }

        .google-btn, .linkedin-btn, .microsoft-btn {
            background-color: #fff;
            color: #757575;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .google-btn:hover, .linkedin-btn:hover, .microsoft-btn:hover {
            background-color: #f8f8f8;
        }

        .google-btn img, .linkedin-btn img, .microsoft-btn img {
            width: 18px;
            height: 18px;
        }

        .linkedin-btn {
            background-color: #fff;
            color: #0077b5;
            border: 1px solid #0077b5;
        }

        .linkedin-btn:hover {
            background-color: #f0f8ff;
        }

        .microsoft-btn {
            background-color: #fff;
            color: #00a1f1;
            border: 1px solid #00a1f1;
        }

        .microsoft-btn:hover {
            background-color: #f0f9ff;
        }

        .divider {
            margin: 20px 0;
            text-align: center;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background-color: #ddd;
        }

        .divider::before {
            left: 0;
        }

        .divider::after {
            right: 0;
        }
        
        p {
            text-align: center;
            margin-top: 20px;
        }
        
        a {
            color: #4CAF50;
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        .error-message {
            color: #f44336;
            margin-top: 10px;
            text-align: center;
        }
        
        .success-message {
            color: #4CAF50;
            margin-top: 10px;
            text-align: center;
        }

        /* Pulse animation for OAuth button highlighting */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="auth-container" id="auth-container">
        <!-- Auth form will be inserted here by auth-handler.js -->
    </div>
    
    <!-- Add these scripts in order with type="module" -->
    <script type="module">
        import { authHandler } from './js/electrisim/loginsubscription/auth-handler.js';
        import maintenanceMode from './js/electrisim/loginsubscription/maintenance-mode.js';
        import config from './js/electrisim/config/environment.js';
        
        // Create fallback redirectToStripeCheckout FIRST (before trying to load stripe-subscription)
        // This ensures the function is always available even if the module fails to load
        if (typeof window.redirectToStripeCheckout !== 'function') {
            console.log('Setting up fallback redirectToStripeCheckout function');
            window.redirectToStripeCheckout = async function() {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('No token for checkout');
                    alert('Please log in to continue.');
                    return;
                }
                
                const isProd = window.location.hostname === 'app.electrisim.com';
                const apiUrl = isProd 
                    ? 'https://api.electrisim.com/api' 
                    : 'http://localhost:5502/api';
                const priceId = isProd 
                    ? 'price_1RLjivAd4ULYw2Nb6oGrb9P1' 
                    : 'price_1RMDAEAd4ULYw2Nb9nhh8Wf2';
                
                console.log('Fallback checkout: Creating session...', { apiUrl, priceId, isProd });
                
                try {
                    const response = await fetch(`${apiUrl}/stripe/create-checkout-session`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ priceId })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Checkout API error:', response.status, errorText);
                        throw new Error(`Checkout failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Checkout session created:', data);
                    
                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error('No checkout URL received');
                    }
                } catch (error) {
                    console.error('Fallback checkout error:', error);
                    alert('Failed to start checkout. Please try again or contact support.');
                }
            };
        }
        
        // Try to load stripe-subscription module (it may override our fallback with a better version)
        import('./js/electrisim/loginsubscription/stripe-subscription.js')
            .then(() => console.log('stripe-subscription.js loaded'))
            .catch(e => console.warn('stripe-subscription.js failed to load, using fallback:', e.message));
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== login.html DOMContentLoaded ===');
            console.log('login.html version: 2025-01-31-v2'); // Version for cache debugging
            
            const authContainer = document.getElementById('auth-container');
            const params = new URLSearchParams(window.location.search);
            const redirect = params.get('redirect');
            const registered = params.get('registered');
            
            console.log('URL params - redirect:', redirect, 'registered:', registered);
            
            // When coming from Subscribe CTA, show Register form so new users can sign up
            if (redirect === 'subscribe') {
                console.log('Showing Register form (redirect=subscribe)');
                authHandler.createRegisterForm(authContainer);
            } else {
                console.log('Showing Login form');
                authHandler.createLoginForm(authContainer);
            }
            
            // Show success message when user was just registered and redirected to login
            if (registered === '1' || registered === 'true') {
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.style.marginBottom = '15px';
                // If user already has token (auto-logged in from registration), redirect to app
                if (localStorage.getItem('token')) {
                    successMsg.textContent = 'You have successfully registered! Redirecting...';
                    setTimeout(() => {
                        const baseUrl = config.isDevelopment
                            ? '/src/main/webapp/index.html'
                            : '/index.html';
                        window.location.href = baseUrl;
                    }, 1500);
                } else {
                    successMsg.textContent = 'You have successfully registered. You can now log in.';
                }
                authContainer.insertBefore(successMsg, authContainer.firstChild);
            }
            
            // If login successful, redirect to previous page or home
            document.addEventListener('userLoggedIn', async (e) => {
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                authContainer.appendChild(successMsg);
                
                // Get redirect intent from query parameters
                const params = new URLSearchParams(window.location.search);
                const redirectIntent = params.get('redirect');
                
                // Handle special 'subscribe' intent - redirect to Stripe checkout
                if (redirectIntent === 'subscribe') {
                    successMsg.textContent = 'Login successful! Redirecting to checkout...';
                    setTimeout(async () => {
                        if (typeof window.redirectToStripeCheckout === 'function') {
                            await window.redirectToStripeCheckout();
                        } else {
                            // Fallback: redirect to index
                            console.warn('redirectToStripeCheckout not available');
                            const baseUrl = config.isDevelopment 
                                ? '/src/main/webapp/index.html' 
                                : '/index.html';
                            window.location.href = baseUrl;
                        }
                    }, 1000);
                    return;
                }
                
                // Normal redirect - use the redirect parameter as URL or default to index
                successMsg.textContent = 'Login successful! Redirecting...';
                const defaultRedirect = config.isDevelopment 
                    ? '/src/main/webapp/index.html' 
                    : '/index.html';
                const redirectUrl = redirectIntent || defaultRedirect;
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = decodeURIComponent(redirectUrl);
                }, 1500);
            });

            // Handle error parameter
            const error = params.get('error');
            if (error) {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.textContent = error === 'auth_failed' 
                    ? 'Authentication failed. Please try again.' 
                    : 'An error occurred. Please try again.';
                authContainer.appendChild(errorMsg);
            }
        });
    </script>
</body>
</html>
