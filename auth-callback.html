<!DOCTYPE html>
<html>
<head>
    <title>Authentication - Electrisim</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        .auth-container {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #48d800;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .success {
            color: #2e7d32;
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <h2>Authenticating...</h2>
        <div class="spinner"></div>
        <p id="status">Processing authentication...</p>
        <div id="message"></div>
    </div>

    <script>
        // Smartlook error tracking helper
        function trackAuthError(errorType, errorDetails, userContext = {}) {
            try {
                if (typeof smartlook !== 'undefined') {
                    smartlook('track', 'auth_error', {
                        error_type: errorType,
                        error_message: errorDetails.message || errorDetails,
                        error_code: errorDetails.code || 'unknown',
                        timestamp: new Date().toISOString(),
                        user_agent: navigator.userAgent,
                        url: window.location.href,
                        user_context: {
                            has_token: !!localStorage.getItem('token'),
                            has_user: !!localStorage.getItem('user'),
                            ...userContext
                        }
                    });
                }
            } catch (e) {
                console.warn('Failed to track auth error with Smartlook:', e);
            }
        }

        // Track successful OAuth authentication
        function trackAuthSuccess(authType, userData = {}) {
            try {
                if (typeof smartlook !== 'undefined') {
                    smartlook('track', 'auth_success', {
                        auth_type: authType,
                        timestamp: new Date().toISOString(),
                        user_agent: navigator.userAgent,
                        url: window.location.href,
                        user_context: {
                            user_id: userData.id || 'unknown',
                            user_email: userData.email || 'unknown',
                            has_stripe_customer: !!userData.stripeCustomerId
                        }
                    });
                }
            } catch (e) {
                console.warn('Failed to track auth success with Smartlook:', e);
            }
        }

        // Handle authentication callback
        (function() {
            console.log('üîç AUTH CALLBACK PAGE LOADED');
            console.log('üîç Current URL:', window.location.href);
            
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const error = urlParams.get('error');
            const statusElement = document.getElementById('status');
            const messageElement = document.getElementById('message');
            
            console.log('üîç URL Parameters:');
            console.log('üîç - token:', token ? 'PRESENT' : 'MISSING');
            console.log('üîç - error:', error);
            console.log('üîç - All params:', Object.fromEntries(urlParams.entries()));

            if (error) {
                // Track OAuth error
                trackAuthError('oauth_callback_error', {
                    message: error,
                    code: 'oauth_failed'
                });
                
                statusElement.textContent = 'Authentication failed';
                messageElement.innerHTML = '<div class="error">Authentication failed. Please try again.</div>';
                setTimeout(() => {
                    const isDevelopment = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                    const loginUrl = isDevelopment 
                        ? 'http://127.0.0.1:5501/src/main/webapp/login.html'  // Development path (Live Server)
                        : '/login.html';                 // Production path
                    window.location.href = loginUrl;
                }, 3000);
                return;
            }

            if (token) {
                try {
                    console.log('‚úÖ TOKEN FOUND - Processing OAuth callback...');
                    
                    // Test localStorage availability
                    try {
                        localStorage.setItem('test', 'test');
                        localStorage.removeItem('test');
                        console.log('‚úÖ localStorage is available');
                    } catch (e) {
                        console.error('‚ùå localStorage is NOT available:', e);
                        throw new Error('localStorage not available');
                    }
                    
                    // Store the token
                    console.log('üìù Storing token...');
                    localStorage.setItem('token', token);
                    console.log('‚úÖ Token stored successfully');
                    
                    // Decode token to get user info (basic decode, not verification)
                    console.log('üîì Decoding token...');
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    console.log('‚úÖ Token decoded successfully. Payload:', payload);
                    
                    if (payload.email) {
                        const userData = {
                            id: payload.id,
                            email: payload.email,
                            stripeCustomerId: payload.stripeCustomerId
                        };
                        console.log('üìù Storing user data:', userData);
                        localStorage.setItem('user', JSON.stringify(userData));
                        console.log('‚úÖ User data stored successfully');
                        
                        // Track successful OAuth authentication
                        trackAuthSuccess('oauth', userData);
                        
                        // Double-check storage worked
                        const storedToken = localStorage.getItem('token');
                        const storedUser = localStorage.getItem('user');
                        console.log('üîç Final verification:');
                        console.log('üîç - Token in storage:', !!storedToken, storedToken ? '(length: ' + storedToken.length + ')' : '');
                        console.log('üîç - User in storage:', !!storedUser, storedUser ? '(data: ' + storedUser + ')' : '');
                        
                        // Test if we can retrieve and parse the stored data
                        try {
                            const retrievedUser = JSON.parse(storedUser);
                            console.log('‚úÖ Retrieved user data:', retrievedUser);
                        } catch (parseError) {
                            console.error('‚ùå Error parsing stored user data:', parseError);
                            trackAuthError('token_parse_error', parseError, { user_id: userData.id });
                        }
                    } else {
                        console.warn('‚ö†Ô∏è No email found in token payload');
                        trackAuthError('token_missing_email', { message: 'No email found in token payload' });
                    }

                    statusElement.textContent = 'Authentication successful!';
                    messageElement.innerHTML = '<div class="success">Redirecting to application...</div>';
                    
                                         // Dispatch login event
                     document.dispatchEvent(new CustomEvent('userLoggedIn', { 
                         detail: { 
                             user: {
                                 id: payload.id,
                                 email: payload.email,
                                 stripeCustomerId: payload.stripeCustomerId
                             }
                         } 
                     }));

                     // Dispatch auth state change event
                     document.dispatchEvent(new CustomEvent('authStateChanged', {
                         detail: {
                             isAuthenticated: true,
                             user: {
                                 id: payload.id,
                                 email: payload.email,
                                 stripeCustomerId: payload.stripeCustomerId
                             }
                         }
                     }));

                     // Also dispatch a specific OAuth success event
                     document.dispatchEvent(new CustomEvent('oauthSuccess', {
                         detail: {
                             user: {
                                 id: payload.id,
                                 email: payload.email,
                                 stripeCustomerId: payload.stripeCustomerId
                             }
                         }
                     }));

                    // Redirect to main application
                    setTimeout(() => {
                        try {
                            // Use correct path based on environment
                            const isDevelopment = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                            const indexUrl = isDevelopment 
                                ? 'http://127.0.0.1:5501/src/main/webapp/index.html'  // Development path (Live Server)
                                : '/index.html';                 // Production path
                            
                            // Use window.location.replace instead of href to avoid unload issues
                            window.location.replace(indexUrl);
                        } catch (redirectError) {
                            console.error('Redirect error:', redirectError);
                            // Fallback: try with href
                            window.location.href = indexUrl;
                        }
                    }, 2000);

                } catch (error) {
                    console.error('Error processing token:', error);
                    
                    // Track token processing error
                    trackAuthError('token_processing_error', {
                        message: error.message,
                        code: 'token_invalid'
                    });
                    
                    statusElement.textContent = 'Authentication failed';
                    messageElement.innerHTML = '<div class="error">Invalid authentication token. Please try again.</div>';
                    setTimeout(() => {
                        const isDevelopment = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                        const loginUrl = isDevelopment 
                            ? 'http://127.0.0.1:5501/src/main/webapp/login.html'  // Development path (Live Server)
                            : '/login.html';                 // Production path
                        window.location.href = loginUrl;
                    }, 3000);
                }
            } else {
                console.log('‚ùå NO TOKEN FOUND');
                console.log('üîç Checking for alternative token sources...');
                
                // Track missing token error
                trackAuthError('missing_token', {
                    message: 'No authentication token found in callback URL',
                    code: 'no_token'
                });
                
                // Check for token in hash (some OAuth implementations use this)
                const hashParams = new URLSearchParams(window.location.hash.slice(1));
                const hashToken = hashParams.get('token') || hashParams.get('access_token');
                
                // Check for token in other common parameter names
                const altToken = urlParams.get('access_token') || urlParams.get('jwt') || urlParams.get('authtoken');
                
                console.log('üîç Hash token:', hashToken ? 'FOUND' : 'NOT FOUND');
                console.log('üîç Alternative token names:', altToken ? 'FOUND' : 'NOT FOUND');
                console.log('üîç Full hash:', window.location.hash);
                console.log('üîç Full search:', window.location.search);
                
                if (hashToken || altToken) {
                    console.log('‚úÖ Found token in alternative location, retrying...');
                    // Retry with found token
                    const foundToken = hashToken || altToken;
                    urlParams.set('token', foundToken);
                    // Recursively call the same logic
                    window.location.search = urlParams.toString();
                    return;
                }
                
                statusElement.textContent = 'No authentication token received';
                messageElement.innerHTML = '<div class="error">No authentication token received. Please try again.</div>';
                console.log('‚ùå Redirecting back to login page...');
                setTimeout(() => {
                    const isDevelopment = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                    const loginUrl = isDevelopment 
                        ? 'http://127.0.0.1:5501/src/main/webapp/login.html'  // Development path (Live Server)
                        : '/login.html';                 // Production path
                    window.location.href = loginUrl;
                }, 3000);
            }
        })();
    </script>
</body>
</html>